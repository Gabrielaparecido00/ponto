<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo</title>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// üî• CONFIG FIREBASE (COLE A SUA)
const firebaseConfig = {
  apiKey: "SUA_KEY",
  authDomain: "SEU_DOMINIO",
  projectId: "SEU_PROJECT_ID",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// üîê LOGIN
window.login = async function() {
    const email = document.getElementById("email").value;
    const senha = document.getElementById("senha").value;

    try {
        await signInWithEmailAndPassword(auth, email, senha);
    } catch (e) {
        alert("Erro no login");
    }
};

// üö™ LOGOUT
window.logout = async function() {
    await signOut(auth);
};

// üîê PROTE√á√ÉO
onAuthStateChanged(auth, user => {
    if (user) {
        document.getElementById("login").style.display = "none";
        document.getElementById("painel").style.display = "block";
    } else {
        document.getElementById("login").style.display = "block";
        document.getElementById("painel").style.display = "none";
    }
});

// üìä BUSCAR DADOS
let dadosGlobais = [];

window.buscar = async function() {

    const inicio = new Date(document.getElementById("inicio").value);
    const fim = new Date(document.getElementById("fim").value);

    const querySnapshot = await getDocs(collection(db, "pontos"));

    let dados = [];

    querySnapshot.forEach(doc => {
        const d = doc.data();

        if (!d.timestamp) return;

        const data = new Date(d.timestamp);

        if (data >= inicio && data <= fim) {
            dados.push(d);
        }
    });

    dadosGlobais = dados;

    montarTabela(dados);
};

// üß† ORGANIZAR PONTO
function montarTabela(dados) {

    const tbody = document.querySelector("tbody");
    tbody.innerHTML = "";

    const agrupado = {};

    dados.forEach(d => {
        const key = d.re + "_" + d.fullName;

        if (!agrupado[key]) agrupado[key] = [];
        agrupado[key].push(d);
    });

    Object.keys(agrupado).forEach(key => {

        const registros = agrupado[key].sort((a,b)=> new Date(a.timestamp) - new Date(b.timestamp));

        let entrada = "";
        let saidaIntervalo = "";
        let retorno = "";
        let saidaFinal = "";

        if (registros[0]) entrada = formatar(registros[0].timestamp);
        if (registros[1]) saidaIntervalo = formatar(registros[1].timestamp);
        if (registros[2]) retorno = formatar(registros[2].timestamp);
        if (registros[3]) saidaFinal = formatar(registros[3].timestamp);

        const tr = `
        <tr>
            <td>${registros[0].fullName}</td>
            <td>${registros[0].re}</td>
            <td>${entrada}</td>
            <td>${saidaIntervalo}</td>
            <td>${retorno}</td>
            <td>${saidaFinal}</td>
        </tr>
        `;

        tbody.innerHTML += tr;
    });
}

// üìÖ FORMATAR DATA
function formatar(data) {
    const d = new Date(data);
    return d.toLocaleString();
}

// üì• EXPORTAR CSV
window.exportar = function() {

    let csv = "Nome,RE,Entrada,Saida Intervalo,Retorno,Saida Final\n";

    const linhas = document.querySelectorAll("tbody tr");

    linhas.forEach(tr => {
        const cols = tr.querySelectorAll("td");
        const linha = Array.from(cols).map(td => td.innerText).join(",");
        csv += linha + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "pontos.csv";
    a.click();
};

</script>

<style>
body { font-family: Arial; background:#f5f5f5; text-align:center; }

.container {
    background:white;
    padding:20px;
    margin:20px auto;
    max-width:1000px;
    border-radius:10px;
}

.logo { width:220px; }

table {
    width:100%;
    border-collapse: collapse;
    margin-top:20px;
}

th,td {
    border:1px solid #ccc;
    padding:8px;
}
</style>

</head>

<body>

<div id="login" class="container">
    <img src="GW.png" class="logo">
    <h2>Admin</h2>
    <input id="email" placeholder="Email"><br>
    <input id="senha" type="password" placeholder="Senha"><br>
    <button onclick="login()">Entrar</button>
</div>

<div id="painel" class="container" style="display:none;">
    <img src="GW.png" class="logo">
    <h2>Painel de Controle</h2>

    <input type="date" id="inicio">
    <input type="date" id="fim">

    <button onclick="buscar()">Buscar</button>
    <button onclick="exportar()">Exportar Excel</button>
    <button onclick="logout()">Sair</button>

    <table>
        <thead>
            <tr>
                <th>Nome</th>
                <th>RE</th>
                <th>Entrada</th>
                <th>Sa√≠da Intervalo</th>
                <th>Retorno</th>
                <th>Sa√≠da Final</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

</body>
</html>
