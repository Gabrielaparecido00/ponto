<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Área do Colaborador</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Montserrat', Arial, sans-serif;
  background:#f0f0f0;
  padding:20px;
}
.container{
  max-width:1100px;
  margin:auto;
  background:#fff;
  padding:18px;
  border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,0.08);
}
.logo{
  width:180px;
  display:block;
  margin:0 auto 10px;
}
h2{
  text-align:center;
  margin:8px 0 12px;
}
.row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
  align-items:end;
}
input,select,button{
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  font-family:inherit;
}
input,select{
  min-width:220px;
}
button{
  cursor:pointer;
  background:#1f6feb;
  color:#fff;
  border:none;
  font-weight:700;
}
button.secondary{
  background:#6c757d;
}
button:disabled{
  opacity:.6;
  cursor:not-allowed;
}
.info{
  text-align:center;
  margin:10px 0;
  font-weight:700;
}
.small{
  text-align:center;
  font-size:12px;
  color:#666;
  margin-top:6px;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:14px;
  font-size:12px;
}
th,td{
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
}
th{
  background:#fafafa;
}
.footer{
  text-align:center;
  margin-top:14px;
  font-size:12px;
  color:#666;
}
.tabs{
  display:flex;
  gap:8px;
  justify-content:center;
  flex-wrap:wrap;
  margin-bottom:12px;
}
.tabBtn{
  background:#e9ecef;
  border:1px solid #ddd;
  border-radius:10px;
  padding:10px 14px;
  font-weight:700;
  cursor:pointer;
}
.tabBtn.active{
  background:#1f6feb;
  color:#fff;
}
.section{
  display:none;
}
.section.active{
  display:block;
}
.card{
  border:1px solid #eee;
  border-radius:12px;
  padding:14px;
  background:#fbfbfb;
  max-width:720px;
  margin:auto;
}
.statusLine{
  text-align:center;
  font-size:12px;
  margin-top:8px;
  color:#555;
}
</style>
</head>

<body>

<div class="container">

<img src="GW.png" class="logo">

<h2>Área do Colaborador</h2>

<div id="loginBox">

<div class="row">

<div>
<label>RE</label><br>
<input id="re" placeholder="Digite seu RE">
</div>

<div>
<label>Senha (4 primeiros do CPF)</label><br>
<input id="senha" type="password" placeholder="Senha">
</div>

<button onclick="entrar()">Entrar</button>

<button class="secondary" onclick="voltar()">Voltar</button>

</div>

<div class="small">
Senha padrão são os 4 primeiros números do CPF.
</div>

</div>


<div id="conteudo" style="display:none;">

<div class="info" id="infoUser"></div>

<div class="tabs">

<button class="tabBtn active" onclick="setTab('freq')" id="tabFreq">
Folha de Frequência
</button>

<button class="tabBtn" onclick="setTab('hol')" id="tabHol">
Holerites
</button>

<button class="secondary" onclick="voltar()">
Voltar
</button>

</div>


<div id="secFreq" class="section active">

<div class="row">

<select id="mes"></select>

<select id="ano"></select>

<button onclick="carregar()">
Carregar
</button>

<button onclick="exportarPdf()">
Exportar PDF
</button>

</div>

<table>

<thead>

<tr>

<th>Data</th>
<th>Dia</th>
<th>Entrada</th>
<th>Intervalo</th>
<th>Retorno</th>
<th>Saída</th>
<th>HE Entrada</th>
<th>HE Saída</th>
<th>Posto</th>
<th>Status</th>

</tr>

</thead>

<tbody id="tbody"></tbody>

</table>

</div>


<div id="secHol" class="section">

<div class="card">

<div class="row">

<select id="holMes"></select>

<select id="holAno"></select>

<button onclick="baixarHolerite()">
Baixar Holerite
</button>

</div>

<div id="holStatus" class="statusLine"></div>

</div>

</div>


<div class="footer">

Sistema desenvolvido por Gabriel Wandele

</div>

</div>

</div>


<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getFirestore,
doc,
getDoc,
getDocs,
collection,
query,
where
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import {
getStorage,
ref,
getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";


const firebaseConfig = {

apiKey: "AIzaSyD--zpWLbLg5X82oGTyz6SuPFQV0sd7NWc",
authDomain: "controle-ponto-f539b.firebaseapp.com",
projectId: "controle-ponto-f539b",
storageBucket: "controle-ponto-f539b.appspot.com",
messagingSenderId: "324716100257",
appId: "1:324716100257:web:32d49a9ab4916182dd4ee0"

};


const app = initializeApp(firebaseConfig);

const db = getFirestore(app);

const storage = getStorage(app);


let user = null;

let cacheLocais = [];

let jornadasMes = [];


function voltar(){

window.location.href = "index.html";

}


function pad2(n){

return String(n).padStart(2,"0");

}


function setTab(tab){

document.getElementById("tabFreq").classList.remove("active");

document.getElementById("tabHol").classList.remove("active");

document.getElementById("secFreq").classList.remove("active");

document.getElementById("secHol").classList.remove("active");

if(tab==="freq"){

document.getElementById("tabFreq").classList.add("active");

document.getElementById("secFreq").classList.add("active");

}else{

document.getElementById("tabHol").classList.add("active");

document.getElementById("secHol").classList.add("active");

}

}


function popularMesAno(){

const mesSel=document.getElementById("mes");

const anoSel=document.getElementById("ano");

const holMes=document.getElementById("holMes");

const holAno=document.getElementById("holAno");

const now=new Date();

const anoAtual=now.getFullYear();

for(let m=1;m<=12;m++){

const opt=document.createElement("option");

opt.value=m;

opt.textContent=pad2(m);

mesSel.appendChild(opt);

holMes.appendChild(opt.cloneNode(true));

}

for(let y=anoAtual-3;y<=anoAtual+1;y++){

const opt=document.createElement("option");

opt.value=y;

opt.textContent=y;

anoSel.appendChild(opt);

holAno.appendChild(opt.cloneNode(true));

}

mesSel.value=now.getMonth()+1;

anoSel.value=anoAtual;

holMes.value=mesSel.value;

holAno.value=anoSel.value;

}

popularMesAno();


async function entrar(){

const re=document.getElementById("re").value.trim();

const senha=document.getElementById("senha").value.trim();

if(!re||!senha){

alert("Preencha RE e senha");

return;

}

const refDoc=doc(db,"colaboradores",re);

const snap=await getDoc(refDoc);

if(!snap.exists()){

alert("RE não encontrado");

return;

}

const data=snap.data();

const senhaCorreta=(data.cpf||"").replace(/\D/g,"").slice(0,4);

if(senha!==senhaCorreta){

alert("Senha incorreta");

return;

}

user={

re,

nome:data.nome

};

document.getElementById("infoUser").innerText=

data.nome+" — RE "+re;

document.getElementById("loginBox").style.display="none";

document.getElementById("conteudo").style.display="block";

carregar();

}


async function carregar(){

if(!user)return;

const mes=parseInt(document.getElementById("mes").value);

const ano=parseInt(document.getElementById("ano").value);

const q=query(

collection(db,"jornadas"),

where("re","==",user.re)

);

const snap=await getDocs(q);

jornadasMes=snap.docs.map(d=>d.data()).filter(j=>{

const d=new Date(j.entrada.ts);

return d.getMonth()+1===mes && d.getFullYear()===ano;

});

renderTabela();

}


function renderTabela(){

const tbody=document.getElementById("tbody");

tbody.innerHTML="";

for(const j of jornadasMes){

const tr=document.createElement("tr");

const d=new Date(j.entrada.ts);

tr.innerHTML=`

<td>${d.toLocaleDateString("pt-BR")}</td>

<td>${d.toLocaleDateString("pt-BR",{weekday:"short"})}</td>

<td>${new Date(j.entrada.ts).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}</td>

<td>${j.saida_intervalo?.ts?new Date(j.saida_intervalo.ts).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}):""}</td>

<td>${j.retorno_intervalo?.ts?new Date(j.retorno_intervalo.ts).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}):""}</td>

<td>${j.saida?.ts?new Date(j.saida.ts).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}):""}</td>

<td>${j.entrada_he?.ts?new Date(j.entrada_he.ts).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}):""}</td>

<td>${j.saida_he?.ts?new Date(j.saida_he.ts).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"}):""}</td>

<td>-</td>

<td>-</td>

`;

tbody.appendChild(tr);

}

}


async function baixarHolerite(){

const mes=document.getElementById("holMes").value;

const ano=document.getElementById("holAno").value;

const nome=`hol_${user.re}_${pad2(mes)}_${ano}.pdf`;

try{

const url=await getDownloadURL(

ref(storage,`holerites/${user.re}/${nome}`)

);

const a=document.createElement("a");

a.href=url;

a.download=nome;

a.click();

document.getElementById("holStatus").innerText="Download iniciado";

}catch{

document.getElementById("holStatus").innerText="Holerite não disponível";

}

}


function exportarPdf(){

alert("Função PDF já disponível no sistema principal.");

}

</script>

</body>

</html>
