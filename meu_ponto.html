<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Área do Colaborador</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

<style>

body{
font-family:'Montserrat',Arial;
background:#f0f0f0;
margin:0;
padding:10px;
}

.container{
background:#fff;
padding:15px;
border-radius:12px;
max-width:1000px;
margin:auto;
}

.logo{
width:180px;
display:block;
margin:auto;
}

h2{
text-align:center;
}

.row{
display:flex;
flex-wrap:wrap;
gap:10px;
justify-content:center;
margin-bottom:10px;
}

input,select,button{
padding:10px;
border-radius:8px;
border:1px solid #ccc;
}

button{
background:#1f6feb;
color:white;
border:none;
cursor:pointer;
}

table{
width:100%;
border-collapse:collapse;
font-size:13px;
}

th,td{
border:1px solid #ccc;
padding:6px;
text-align:center;
}

th{
background:#eee;
}

</style>
</head>
<body>

<div class="container">

<img src="GW.png" class="logo">

<h2>Área do Colaborador</h2>

<div id="loginBox">

<div class="row">

<input id="re" placeholder="RE">

<input id="senha" type="password" placeholder="Senha">

<button onclick="login()">Entrar</button>

</div>

</div>

<div id="conteudo" style="display:none;">

<div class="row">

<select id="mes"></select>

<select id="ano"></select>

<button onclick="carregar()">Carregar</button>

</div>

<table>

<thead>

<tr>

<th>Data</th>
<th>Dia</th>
<th>Entrada</th>
<th>Saída</th>
<th>Posto</th>
<th>OBS</th>

</tr>

</thead>

<tbody id="tbody"></tbody>

</table>

</div>

</div>

<script type="module">

import {

initializeApp

} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

import {

getFirestore,
doc,
getDoc,
getDocs,
collection,
query,
where

} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={

apiKey:"AIzaSy...",
authDomain:"controle-ponto-f539b.firebaseapp.com",
projectId:"controle-ponto-f539b"

};

const app=initializeApp(firebaseConfig);

const db=getFirestore(app);

let user=null;

let jornadas=[];

function pad(n){

return String(n).padStart(2,"0");

}

function dataYmd(d){

return d.toISOString().slice(0,10);

}

function brDate(d){

return d.toLocaleDateString("pt-BR");

}

function weekday(d){

return d.toLocaleDateString("pt-BR",{weekday:"short"});

}

function hm(d){

return d.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});

}

function getPlantaoReferencia(dateObj,historico){

if(!historico) return null;

const ymd=dataYmd(dateObj);

let atual=null;

for(const p of historico){

if(p.inicio<=ymd){

if(!atual || p.inicio>atual.inicio){

atual=p;

}

}

}

return atual;

}

function isDiaTrabalho(dateObj,col){

if(!col) return false;

if(col.escala==="5x2"){

const d=dateObj.getDay();

return d!==0 && d!==6;

}

if(col.escala==="6x1"){

const d=dateObj.getDay();

return d!==0;

}

if(col.escala==="12x36"){

const plantao=getPlantaoReferencia(dateObj,col.plantaoHistorico);

if(!plantao) return false;

const base=new Date(plantao.inicio);

const diff=Math.floor((dateObj-base)/86400000);

return diff%2===0;

}

return false;

}

function isAdmitido(dateObj,col){

if(!col.dataAdmissao) return true;

return dataYmd(dateObj)>=col.dataAdmissao;

}

window.login=async function(){

const reVal=re.value.trim();

const senhaVal=senha.value.trim();

const ref=doc(db,"colaboradores",reVal);

const snap=await getDoc(ref);

if(!snap.exists()){

alert("RE não encontrado");

return;

}

const data=snap.data();

const senhaCorreta=(data.cpf||"").slice(0,4);

if(senhaVal!==senhaCorreta){

alert("Senha incorreta");

return;

}

user={id:reVal,...data};

loginBox.style.display="none";

conteudo.style.display="block";

initSelects();

}

function initSelects(){

const now=new Date();

for(let m=1;m<=12;m++){

mes.innerHTML+=`<option value="${m}">${pad(m)}</option>`;

}

for(let y=now.getFullYear()-2;y<=now.getFullYear()+1;y++){

ano.innerHTML+=`<option value="${y}">${y}</option>`;

}

mes.value=now.getMonth()+1;

ano.value=now.getFullYear();

}

window.carregar=async function(){

const m=Number(mes.value);

const y=Number(ano.value);

const q=query(collection(db,"jornadas"),where("re","==",user.id));

const snap=await getDocs(q);

jornadas=snap.docs.map(d=>d.data());

render(m,y);

}

function render(m,y){

tbody.innerHTML="";

const dias=new Date(y,m,0).getDate();

for(let dia=1;dia<=dias;dia++){

const d=new Date(y,m-1,dia);

const ymd=dataYmd(d);

const j=jornadas.find(x=>x.entrada?.ts?.slice(0,10)===ymd);

let entrada="",saida="",obs="",posto="";

const admitido=isAdmitido(d,user);

const trabalho=isDiaTrabalho(d,user);

if(!admitido){

obs="";

}

else if(j){

entrada=hm(new Date(j.entrada.ts));

saida=hm(new Date(j.saida?.ts));

posto=j.entrada.location||"";

if(!trabalho){

obs="FT";

}

}

else{

if(trabalho){

obs="FALTA";

}

else{

obs="FOLGA";

}

}

tbody.innerHTML+=`

<tr>

<td>${brDate(d)}</td>
<td>${weekday(d)}</td>
<td>${entrada}</td>
<td>${saida}</td>
<td>${posto}</td>
<td>${obs}</td>

</tr>

`;

}

}

</script>

</body>
</html>
