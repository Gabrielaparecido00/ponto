<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel Admin</title>

<style>
body { font-family: Arial; background:#f5f5f5; text-align:center; }
.container { background:white; padding:20px; margin:20px auto; max-width:1250px; border-radius:10px; }
.logo { width:260px; margin-bottom: 10px; }
input, button, select { padding:10px; margin:5px; }
button { cursor:pointer; }
.row { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; align-items:center; margin-top:10px; }
table { width:100%; border-collapse:collapse; margin-top:18px; font-size:13px; }
th, td { border:1px solid #ccc; padding:8px; }
th { background:#fafafa; }
.small { font-size: 12px; color:#666; }
.hr { height:1px; background:#eee; margin:18px 0; border:0; }
.menu { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:10px; }
.menu button { background:#1f6feb; color:#fff; border:none; border-radius:8px; }
.menu button.secondary { background:#6c757d; }
.section { display:none; }
.section.active { display:block; }

/* ✏️ minimalista */
.editBtn {
  border:none;
  background:transparent;
  cursor:pointer;
  font-size:11px;          /* menor */
  padding:2px 5px;         /* minimalista */
  opacity:0.65;
}
.editBtn:hover { opacity:1; }

/* Modal */
.modalOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,0.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.modal{
  background:#fff;
  width:min(520px, 92vw);
  border-radius:12px;
  padding:16px;
  box-shadow:0 10px 30px rgba(0,0,0,0.2);
  text-align:left;
}
.modal h3{ margin:0 0 10px; }
.modal .grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
.modal label{ font-size:12px; color:#555; }
.modal input, .modal select{
  width:100%;
  box-sizing:border-box;
  margin:4px 0 0;
}
.modal .actions{
  display:flex;
  justify-content:flex-end;
  gap:8px;
  margin-top:14px;
}
.modal .actions button{
  border:none;
  border-radius:10px;
}
.btnPrimary{ background:#1f6feb; color:#fff; }
.btnDanger{ background:#dc3545; color:#fff; }
.btnGhost{ background:#e9ecef; }
.badge{
  display:inline-block;
  font-size:11px;
  padding:2px 8px;
  border-radius:999px;
  background:#eee;
  margin-left:6px;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginDiv" class="container">
  <img src="GW.png" class="logo">
  <h2>Login Admin</h2>
  <input id="email" placeholder="Email"><br>
  <input id="senha" type="password" placeholder="Senha"><br>
  <button onclick="login()">Entrar</button>
</div>

<!-- PAINEL -->
<div id="painelDiv" class="container" style="display:none;">
  <img src="GW.png" class="logo">

  <h2>Painel Admin</h2>
  <div class="small">Use o menu para navegar. ✏️ edita com: <b>AAAA-MM-DD HH:MM</b></div>

  <div class="menu">
    <button onclick="showSection('secJornadas')">Jornadas</button>
    <button onclick="showSection('secColab')">Cadastro de colaborador</button>
    <button onclick="showSection('secLocal')">Cadastro de local</button>
    <button class="secondary" onclick="logout()">Sair</button>
  </div>

  <hr class="hr">

  <!-- ====== SEÇÃO JORNADAS ====== -->
  <div id="secJornadas" class="section active">
    <h3>Jornadas (Turnos)</h3>

    <div class="row">
      <label>De:</label><input type="date" id="inicio">
      <label>Até:</label><input type="date" id="fim">
      <input id="filtroRe" placeholder="Filtrar por RE (opcional)" inputmode="numeric">
      <input id="filtroNome" placeholder="Filtrar por Nome (opcional)">
      <button onclick="buscar()">Buscar</button>
      <button onclick="exportar()">Exportar CSV</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Data (Entrada)</th>
          <th>Nome</th>
          <th>RE</th>

          <th>ENTRADA</th>
          <th>SAÍDA INTERVALO</th>
          <th>RETORNO INTERVALO</th>
          <th>SAÍDA</th>
          <th>ENTRADA HE</th>
          <th>SAÍDA HE</th>

          <th>Localização (coords)</th>
          <th>Local reconhecido</th>
        </tr>
      </thead>
      <tbody id="tbodyJornadas"></tbody>
    </table>
  </div>

  <!-- ====== SEÇÃO COLABORADOR ====== -->
  <div id="secColab" class="section">
    <h3>Cadastro de colaborador</h3>
    <div class="small">Coleção: <b>colaboradores</b> (docId = RE)</div>

    <!-- Cadastro rápido -->
    <div class="row">
      <input id="cadRe" placeholder="RE (docId)" inputmode="numeric">
      <input id="cadNome" placeholder="Nome completo">
      <input id="cadCpf" placeholder="CPF (opcional)" inputmode="numeric">
      <button onclick="salvarColaboradorNovo()">Cadastrar</button>
      <button onclick="carregarColaboradores()">Atualizar lista</button>
    </div>

    <!-- Lista -->
    <table>
      <thead>
        <tr>
          <th>RE</th>
          <th>Nome</th>
          <th>CPF</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyColab"></tbody>
    </table>
  </div>

  <!-- ====== SEÇÃO LOCAL ====== -->
  <div id="secLocal" class="section">
    <h3>Cadastro de local</h3>
    <div class="small">Coleção: <b>locais</b> • margem = raio em metros</div>

    <!-- Cadastro rápido -->
    <div class="row">
      <input id="locNome" placeholder="Nome do posto (ex: Posto A)">
      <input id="locLat" placeholder="Latitude (X) ex: -12.3456">
      <input id="locLng" placeholder="Longitude (Y) ex: -38.1234">
      <input id="locRaio" placeholder="Margem (metros) ex: 150" inputmode="numeric">
      <button onclick="salvarLocalNovo()">Cadastrar</button>
      <button onclick="carregarLocais()">Atualizar lista</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th>Raio (m)</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyLocais"></tbody>
    </table>
  </div>

</div>

<!-- ===== MODAL GENÉRICO ===== -->
<div id="modalOverlay" class="modalOverlay" onclick="closeModalIfBackdrop(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <h3 id="modalTitle">Editar</h3>

    <div id="modalBody"></div>

    <div class="actions">
      <button class="btnGhost" onclick="closeModal()">Cancelar</button>
      <button id="modalDeleteBtn" class="btnDanger" style="display:none;">Excluir</button>
      <button id="modalSaveBtn" class="btnPrimary">Salvar</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDocs, collection, updateDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyD--zpWLbLg5X82oGTyz6SuPFQV0sd7NWc",
  authDomain: "controle-ponto-f539b.firebaseapp.com",
  projectId: "controle-ponto-f539b",
  storageBucket: "controle-ponto-f539b.firebasestorage.app",
  messagingSenderId: "324716100257",
  appId: "1:324716100257:web:32d49a9ab4916182dd4ee0",
  measurementId: "G-P81H3C4SFK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const loginDiv = document.getElementById("loginDiv");
const painelDiv = document.getElementById("painelDiv");

let ultimaTabela = [];
let cacheLocais = [];
let cacheColabs = [];

// ===== MENU =====
window.showSection = function(id){
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  if (id === "secLocal") carregarLocais();
  if (id === "secColab") carregarColaboradores();
};

// ===== AUTH =====
window.login = async function() {
  const email = document.getElementById("email").value;
  const senha = document.getElementById("senha").value;
  try { await signInWithEmailAndPassword(auth, email, senha); }
  catch (e) { alert("Erro no login"); console.error(e); }
};

window.logout = function() { signOut(auth); };

onAuthStateChanged(auth, user => {
  loginDiv.style.display = user ? "none" : "block";
  painelDiv.style.display = user ? "block" : "none";
  if (user) {
    carregarLocais();
    carregarColaboradores();
  }
});

// ===== Helpers =====
function norm(s){ return (s||"").toString().trim().toLowerCase(); }
function toDateAny(ts){
  if (!ts) return null;
  if (ts.toDate) return ts.toDate();
  if (ts instanceof Date) return ts;
  return new Date(ts);
}
function formatHHMM(ts){
  const d = toDateAny(ts);
  if (!d || isNaN(d)) return "";
  return d.toLocaleTimeString("pt-BR", { hour:"2-digit", minute:"2-digit" });
}
function formatYYYYMMDD(ts){
  const d = toDateAny(ts);
  if (!d || isNaN(d)) return "";
  return d.toISOString().slice(0,10);
}
function formatISOFromYYYYMMDD_HHMM(str){
  const m = (str||"").trim().match(/^(\d{4})-(\d{2})-(\d{2})\s+([01]\d|2[0-3]):([0-5]\d)$/);
  if (!m) return null;
  const dt = new Date(`${m[1]}-${m[2]}-${m[3]}T${m[4]}:${m[5]}:00`);
  if (isNaN(dt)) return null;
  return dt.toISOString();
}
function haversineMeters(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const toRad = (x)=> x * Math.PI / 180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function parseLocation(str){
  if (!str) return null;
  const parts = str.split(",").map(s=>s.trim());
  if (parts.length !== 2) return null;
  const lat = Number(parts[0]), lng = Number(parts[1]);
  if (!Number.isFinite(lat) || !Number.isFinite(lng)) return null;
  return { lat, lng };
}
function getBestLocationFromJornada(j){
  const steps = ["saida_he","entrada_he","saida","retorno_intervalo","saida_intervalo","entrada"];
  for (const s of steps){
    const loc = j?.[s]?.location;
    if (loc) return loc;
  }
  return "";
}
function reconhecerLocal(locationStr){
  const p = parseLocation(locationStr);
  if (!p) return "Não disponível";

  let melhor = null;
  for (const l of cacheLocais){
    const d = haversineMeters(p.lat, p.lng, l.lat, l.lng);
    if (d <= l.raio){
      if (!melhor || d < melhor.dist) melhor = { nome:l.nome, dist:d };
    }
  }
  return melhor ? melhor.nome : "Não reconhecido";
}

/* ===== MODAL ===== */
const overlay = document.getElementById("modalOverlay");
const titleEl = document.getElementById("modalTitle");
const bodyEl = document.getElementById("modalBody");
const saveBtn = document.getElementById("modalSaveBtn");
const delBtn = document.getElementById("modalDeleteBtn");

window.closeModal = function(){ overlay.style.display = "none"; bodyEl.innerHTML=""; saveBtn.onclick=null; delBtn.onclick=null; };
window.closeModalIfBackdrop = function(e){ if (e.target === overlay) closeModal(); };

function openModal({ title, bodyHtml, onSave, onDelete, showDelete }) {
  titleEl.innerText = title;
  bodyEl.innerHTML = bodyHtml;
  overlay.style.display = "flex";

  delBtn.style.display = showDelete ? "inline-block" : "none";

  saveBtn.onclick = onSave || null;
  delBtn.onclick = onDelete || null;
}

/* ===== JORNADAS ===== */
window.buscar = async function(){
  const iniStr = document.getElementById("inicio").value || "2000-01-01";
  const fimStr = document.getElementById("fim").value || "2999-12-31";
  const filtroRe = norm(document.getElementById("filtroRe").value);
  const filtroNome = norm(document.getElementById("filtroNome").value);

  const snap = await getDocs(collection(db, "jornadas"));
  let jornadas = snap.docs.map(d => ({ id: d.id, ...d.data() }));

  jornadas = jornadas.filter(j => {
    const d = formatYYYYMMDD(j.entrada?.ts);
    if (!d) return false;
    return d >= iniStr && d <= fimStr;
  });

  if (filtroRe) jornadas = jornadas.filter(j => norm(j.re) === filtroRe);
  if (filtroNome) jornadas = jornadas.filter(j => norm(j.nome).includes(filtroNome));

  jornadas.sort((a,b) => (toDateAny(b.entrada?.ts)||new Date(0)) - (toDateAny(a.entrada?.ts)||new Date(0)));

  ultimaTabela = jornadas;
  montarTabelaJornadas(jornadas);
};

function cellEdit(docId, path, ts){
  const v = formatHHMM(ts);
  const d = toDateAny(ts);
  const tooltip = d && !isNaN(d) ? `${d.toISOString().slice(0,10)} ${d.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}` : "";
  return `
    <td>
      <span title="${tooltip}">${v}</span>
      <button class="editBtn" onclick="editarCampoJornada('${docId}','${path}')">✎</button>
    </td>
  `;
}

function montarTabelaJornadas(jornadas){
  const tbody = document.getElementById("tbodyJornadas");
  tbody.innerHTML = "";

  for (const j of jornadas){
    const dataEntrada = formatYYYYMMDD(j.entrada?.ts);
    const loc = getBestLocationFromJornada(j);
    const rec = reconhecerLocal(loc);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${dataEntrada}</td>
      <td>${j.nome || ""}</td>
      <td>${j.re || ""}</td>

      ${cellEdit(j.id,"entrada.ts", j.entrada?.ts)}
      ${cellEdit(j.id,"saida_intervalo.ts", j.saida_intervalo?.ts)}
      ${cellEdit(j.id,"retorno_intervalo.ts", j.retorno_intervalo?.ts)}
      ${cellEdit(j.id,"saida.ts", j.saida?.ts)}
      ${cellEdit(j.id,"entrada_he.ts", j.entrada_he?.ts)}
      ${cellEdit(j.id,"saida_he.ts", j.saida_he?.ts)}

      <td>${loc || ""}</td>
      <td>${rec}</td>
    `;
    tbody.appendChild(tr);
  }
}

window.editarCampoJornada = function(docId, path){
  const j = ultimaTabela.find(x => x.id === docId);
  if (!j) return alert("Jornada não encontrada.");

  const bloco = path.split(".")[0];
  const atualISO = j[bloco]?.ts || "";
  const atualDate = toDateAny(atualISO);

  const sugestao = (atualDate && !isNaN(atualDate))
    ? `${atualDate.toISOString().slice(0,10)} ${atualDate.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}`
    : "";

  openModal({
    title: "Editar Jornada",
    bodyHtml: `
      <div class="grid">
        <div>
          <label>Campo</label>
          <input value="${path}" disabled>
        </div>
        <div>
          <label>Valor (AAAA-MM-DD HH:MM)</label>
          <input id="editJValue" placeholder="2026-02-16 07:10" value="${sugestao}">
        </div>
      </div>
      <div class="small" style="margin-top:8px">Isso atualiza somente o timestamp desse campo.</div>
    `,
    showDelete: false,
    onSave: async () => {
      const novo = document.getElementById("editJValue").value;
      const iso = formatISOFromYYYYMMDD_HHMM(novo);
      if (!iso) return alert("Formato inválido. Use AAAA-MM-DD HH:MM.");

      if (!confirm(`Confirmar alteração?\n${path} = ${novo}`)) return;

      await updateDoc(doc(db, "jornadas", docId), {
        [path]: iso,
        updatedAt: new Date().toISOString()
      });

      closeModal();
      buscar();
    }
  });
};

/* ===== COLABORADORES ===== */
window.salvarColaboradorNovo = async function(){
  const re = document.getElementById("cadRe").value.trim();
  const nome = document.getElementById("cadNome").value.trim();
  const cpf = document.getElementById("cadCpf").value.trim();

  if (!re || !nome) return alert("Preencha RE e Nome.");
  if (!confirm(`Cadastrar colaborador?\nRE: ${re}\nNome: ${nome}`)) return;

  await setDoc(doc(db, "colaboradores", re), {
    re, nome, cpf: cpf || "", ativo: true, updatedAt: new Date().toISOString()
  }, { merge:true });

  alert("Cadastrado!");
  document.getElementById("cadRe").value="";
  document.getElementById("cadNome").value="";
  document.getElementById("cadCpf").value="";
  carregarColaboradores();
};

window.carregarColaboradores = async function(){
  const snap = await getDocs(collection(db, "colaboradores"));
  cacheColabs = snap.docs.map(d => ({ id:d.id, ...d.data() }));

  // ordena por nome
  cacheColabs.sort((a,b)=> (a.nome||"").localeCompare(b.nome||""));

  const tbody = document.getElementById("tbodyColab");
  tbody.innerHTML = "";

  for (const c of cacheColabs){
    const status = (c.ativo === false) ? "Inativo" : "Ativo";
    const badge = (c.ativo === false) ? `<span class="badge">inativo</span>` : `<span class="badge">ativo</span>`;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.re || c.id}</td>
      <td>${c.nome || ""}</td>
      <td>${c.cpf || ""}</td>
      <td>${status} ${badge}</td>
      <td><button onclick="editarColaborador('${c.id}')">Modificar</button></td>
    `;
    tbody.appendChild(tr);
  }
};

window.editarColaborador = function(reDocId){
  const c = cacheColabs.find(x => x.id === reDocId);
  if (!c) return alert("Colaborador não encontrado.");

  openModal({
    title: "Modificar colaborador",
    bodyHtml: `
      <div class="grid">
        <div>
          <label>RE (docId)</label>
          <input id="colRe" value="${c.re || c.id}" disabled>
        </div>
        <div>
          <label>CPF</label>
          <input id="colCpf" value="${c.cpf || ""}" placeholder="Somente números">
        </div>

        <div style="grid-column:1 / -1">
          <label>Nome</label>
          <input id="colNome" value="${c.nome || ""}">
        </div>

        <div style="grid-column:1 / -1">
          <label>Status</label>
          <select id="colAtivo">
            <option value="true" ${c.ativo === false ? "" : "selected"}>Ativo</option>
            <option value="false" ${c.ativo === false ? "selected" : ""}>Inativo</option>
          </select>
        </div>
      </div>
      <div class="small" style="margin-top:8px">Você pode inativar sem excluir.</div>
    `,
    showDelete: true,
    onSave: async () => {
      const nome = document.getElementById("colNome").value.trim();
      const cpf = document.getElementById("colCpf").value.trim();
      const ativo = document.getElementById("colAtivo").value === "true";

      if (!nome) return alert("Nome não pode ficar vazio.");
      if (!confirm("Salvar alterações do colaborador?")) return;

      await setDoc(doc(db, "colaboradores", reDocId), {
        nome, cpf: cpf || "", ativo, updatedAt: new Date().toISOString()
      }, { merge:true });

      closeModal();
      carregarColaboradores();
    },
    onDelete: async () => {
      if (!confirm("Excluir colaborador? Isso remove do banco.")) return;
      await deleteDoc(doc(db, "colaboradores", reDocId));
      closeModal();
      carregarColaboradores();
    }
  });
};

/* ===== LOCAIS ===== */
window.salvarLocalNovo = async function(){
  const nome = document.getElementById("locNome").value.trim();
  const lat = Number(document.getElementById("locLat").value.trim());
  const lng = Number(document.getElementById("locLng").value.trim());
  const raio = Number(document.getElementById("locRaio").value.trim());

  if (!nome || !Number.isFinite(lat) || !Number.isFinite(lng) || !Number.isFinite(raio)) {
    return alert("Preencha Nome, Latitude, Longitude e Raio (metros).");
  }

  if (!confirm(`Cadastrar local?\n${nome}\n(${lat}, ${lng})\nRaio: ${raio}m`)) return;

  await addDoc(collection(db, "locais"), { nome, lat, lng, raio, updatedAt: new Date().toISOString() });

  alert("Local cadastrado!");
  document.getElementById("locNome").value="";
  document.getElementById("locLat").value="";
  document.getElementById("locLng").value="";
  document.getElementById("locRaio").value="";
  carregarLocais();
};

window.carregarLocais = async function(){
  const snap = await getDocs(collection(db, "locais"));
  cacheLocais = snap.docs.map(d => ({ id:d.id, ...d.data() }))
    .filter(l => Number.isFinite(l.lat) && Number.isFinite(l.lng) && Number.isFinite(l.raio));

  cacheLocais.sort((a,b)=> (a.nome||"").localeCompare(b.nome||""));

  const tbody = document.getElementById("tbodyLocais");
  tbody.innerHTML = "";
  for (const l of cacheLocais){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${l.nome || ""}</td>
      <td>${l.lat}</td>
      <td>${l.lng}</td>
      <td>${l.raio}</td>
      <td><button onclick="editarLocal('${l.id}')">Modificar</button></td>
    `;
    tbody.appendChild(tr);
  }
};

window.editarLocal = function(localId){
  const l = cacheLocais.find(x => x.id === localId);
  if (!l) return alert("Local não encontrado.");

  openModal({
    title: "Modificar local",
    bodyHtml: `
      <div class="grid">
        <div style="grid-column:1 / -1">
          <label>Nome do posto</label>
          <input id="mLocNome" value="${l.nome || ""}">
        </div>
        <div>
          <label>Latitude (X)</label>
          <input id="mLocLat" value="${l.lat}">
        </div>
        <div>
          <label>Longitude (Y)</label>
          <input id="mLocLng" value="${l.lng}">
        </div>
        <div style="grid-column:1 / -1">
          <label>Margem (metros)</label>
          <input id="mLocRaio" value="${l.raio}">
        </div>
      </div>
      <div class="small" style="margin-top:8px">Reconhecimento usa raio (metros) com cálculo de distância.</div>
    `,
    showDelete: true,
    onSave: async () => {
      const nome = document.getElementById("mLocNome").value.trim();
      const lat = Number(document.getElementById("mLocLat").value.trim());
      const lng = Number(document.getElementById("mLocLng").value.trim());
      const raio = Number(document.getElementById("mLocRaio").value.trim());

      if (!nome || !Number.isFinite(lat) || !Number.isFinite(lng) || !Number.isFinite(raio)) {
        return alert("Preencha corretamente Nome, Latitude, Longitude e Raio.");
      }
      if (!confirm("Salvar alterações do local?")) return;

      await updateDoc(doc(db, "locais", localId), {
        nome, lat, lng, raio, updatedAt: new Date().toISOString()
      });

      closeModal();
      carregarLocais();
      buscar(); // atualiza reconhecimento na tabela de jornadas
    },
    onDelete: async () => {
      if (!confirm("Excluir local?")) return;
      await deleteDoc(doc(db, "locais", localId));
      closeModal();
      carregarLocais();
      buscar();
    }
  });
};

/* ===== EXPORT ===== */
window.exportar = function(){
  let csv = "DataEntrada,Nome,RE,Entrada,SaidaIntervalo,RetornoIntervalo,Saida,EntradaHE,SaidaHE,LocationCoords,LocalReconhecido\n";
  for (const j of ultimaTabela){
    const loc = getBestLocationFromJornada(j);
    const rec = reconhecerLocal(loc);
    const linha = [
      formatYYYYMMDD(j.entrada?.ts),
      j.nome || "",
      j.re || "",
      formatHHMM(j.entrada?.ts),
      formatHHMM(j.saida_intervalo?.ts),
      formatHHMM(j.retorno_intervalo?.ts),
      formatHHMM(j.saida?.ts),
      formatHHMM(j.entrada_he?.ts),
      formatHHMM(j.saida_he?.ts),
      loc || "",
      rec || ""
    ].map(v => `"${String(v).replaceAll('"','""')}"`).join(",");
    csv += linha + "\n";
  }
  const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "jornadas.csv";
  a.click();
};
</script>

</body>
</html>
