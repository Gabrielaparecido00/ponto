<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Admin</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    *{ box-sizing:border-box; }

    :root{
      --bg:#0b1020;
      --panel:#0f172a;
      --card:#0b1220;
      --card2:#0b1220cc;
      --line:rgba(255,255,255,0.08);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --primary:#3b82f6;
      --primary2:#2563eb;
      --danger:#ef4444;
      --ok:#22c55e;
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
      --radius:14px;
    }

    body{
      font-family:'Montserrat', Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(59,130,246,0.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 10%, rgba(34,197,94,0.10), transparent 60%),
                  var(--bg);
      margin:0;
      padding:14px;
      color:var(--text);
      text-align:center;
    }

    .container{
      max-width:520px;
      margin:14px auto;
      background: rgba(15,23,42,0.82);
      border:1px solid var(--line);
      backdrop-filter: blur(10px);
      padding:18px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .logo{ width:220px; display:block; margin:0 auto 8px; max-width:90vw; height:auto; }

    h2{ margin:8px 0 10px; text-align:center; font-weight:700; letter-spacing:0.2px; }
    h3{ margin:10px 0 8px; text-align:left; font-weight:700; }

    .small{ font-size:12px; color:var(--muted); text-align:left; line-height:1.35; }

    input, select, button{
      font-family:inherit;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.10);
      outline:none;
      background: rgba(2,6,23,0.55);
      color: var(--text);
    }
    input::placeholder{ color: rgba(148,163,184,0.85); }

    button{ cursor:pointer; border:none; }
    button:hover{ filter:brightness(1.03); }
    button:disabled{ opacity:0.55; cursor:not-allowed; }

    .btnPrimary{ background: linear-gradient(180deg, var(--primary), var(--primary2)); color:#fff; }
    .btnGhost{ background: rgba(148,163,184,0.12); color: var(--text); border:1px solid rgba(255,255,255,0.10); }
    .btnDanger{ background: rgba(239,68,68,0.15); color:#fecaca; border:1px solid rgba(239,68,68,0.25); }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:flex-start;
      align-items:end;
      margin-top:10px;
    }

    .hr{ height:1px; background:var(--line); margin:16px 0; border:0; }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:14px;
      font-size:13px;
      overflow:hidden;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.08);
    }
    th, td{
      border-bottom:1px solid rgba(255,255,255,0.06);
      padding:10px;
      vertical-align:top;
    }
    th{
      background: rgba(2,6,23,0.45);
      text-align:center;
      color:#cbd5e1;
      font-weight:700;
    }
    td{ text-align:left; color:#e5e7eb; }
    tr:hover td{ background: rgba(59,130,246,0.06); }

    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      background: rgba(148,163,184,0.10);
      border:1px solid rgba(255,255,255,0.10);
      color:#e5e7eb;
    }

    .adminShell{
      max-width:1320px;
      margin:12px auto;
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:12px;
      text-align:left;
    }

    .side{
      background: rgba(15,23,42,0.78);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      position:sticky;
      top:12px;
      height: calc(100vh - 24px);
      overflow:auto;
    }

    .side .brand{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    .side .brand img{ width:44px; height:44px; border-radius:12px; object-fit:cover; border:1px solid rgba(255,255,255,0.10); }
    .side .brand .t{ font-weight:800; line-height:1.1; }
    .side .brand .s{ font-size:12px; color:var(--muted); margin-top:2px; }

    .nav{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:12px;
    }
    .nav button{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      background: rgba(2,6,23,0.35);
      border:1px solid rgba(255,255,255,0.08);
      color:#e5e7eb;
    }
    .nav button.activeBtn{
      background: rgba(59,130,246,0.18);
      border:1px solid rgba(59,130,246,0.35);
    }
    .nav small{ color:var(--muted); }

    .content{
      background: rgba(15,23,42,0.66);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      min-height: 540px;
    }

    .topBar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .topBar .hint{ color:var(--muted); font-size:12px; }

    .statusBar{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(2,6,23,0.35);
      color:#cbd5e1;
      font-size:12px;
      display:none;
    }
    .statusBar.ok{ border-color:rgba(34,197,94,0.25); background:rgba(34,197,94,0.12); }
    .statusBar.err{ border-color:rgba(239,68,68,0.25); background:rgba(239,68,68,0.12); }

    .section{ display:none; }
    .section.active{ display:block; }

    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:10px;
    }
    .modal{
      background: rgba(15,23,42,0.96);
      border:1px solid rgba(255,255,255,0.10);
      width:min(980px, 96vw);
      max-height:92vh;
      overflow:auto;
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
      text-align:left;
      color:var(--text);
    }
    .modal h3{ margin:0 0 10px; text-align:left; }
    .modal .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .modal label{ font-size:12px; color:var(--muted); }
    .modal input, .modal select{ width:100%; margin-top:4px; }
    .modal .actions{
      position:sticky;
      bottom:0;
      background: rgba(15,23,42,0.96);
      padding-top:10px;
      margin-top:10px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
      border-top:1px solid rgba(255,255,255,0.08);
    }

    .minBtn{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(2,6,23,0.25);
      border-radius:12px;
      padding:7px 10px;
      font-size:12px;
      color:var(--text);
    }
    .minBtn:hover{ background: rgba(2,6,23,0.40); }

    @media (max-width: 980px){
      .adminShell{ grid-template-columns:1fr; }
      .side{ position:relative; height:auto; }
      .modal .grid{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div id="loginDiv">
    <div class="container">
      <img src="GW.png" class="logo" />
      <h2 style="margin:6px 0 12px;">Login Admin</h2>
      <input id="email" placeholder="Email" autocomplete="username"><br><br>
      <input id="senha" type="password" placeholder="Senha" autocomplete="current-password"><br><br>
      <button id="btnLogin" class="btnPrimary" onclick="login()" style="width:100%;">Entrar</button>
      <div class="small" style="margin-top:10px;">Acesso restrito • Ambiente tecnológico minimalista</div>
    </div>
  </div>

  <!-- PAINEL -->
  <div id="painelDiv" style="display:none;">
    <div class="adminShell">

      <!-- SIDEBAR -->
      <aside class="side" id="sidebar">
        <div class="brand">
          <img src="GW.png" alt="Logo">
          <div>
            <div class="t">Painel Admin</div>
            <div class="s">Minimal • Tech • RH</div>
          </div>
        </div>

        <div class="small">
          Editar horários no formato: <b>DD/MM/AAAA HH:MM</b><br>
          Ex: 16/02/2026 07:10
        </div>

        <div class="nav">
          <button id="btnJornadas" onclick="showSection('secJornadas', this)">
            <span>Jornadas</span><small>registros</small>
          </button>

          <button id="btnExportRH" onclick="showSection('secExportRH', this)">
            <span>Exportação RH</span><small>XLSX</small>
          </button>

          <button id="btnExportMassa" onclick="showSection('secExportMassa', this)">
            <span>Exportação em massa</span><small>PDF</small>
          </button>

          <button id="btnColab" onclick="showSection('secColab', this)">
            <span>Colaboradores</span><small>cadastro</small>
          </button>

          <button id="btnCargos" onclick="showSection('secCargos', this)">
            <span>Cargos</span><small>VR/VA</small>
          </button>

          <button id="btnLocal" onclick="showSection('secLocal', this)">
            <span>Locais</span><small>geofence</small>
          </button>

          <button id="btnSup" onclick="showSection('secSup', this)">
            <span>Supervisores</span><small>FT</small>
          </button>

          <button class="btnDanger" onclick="logout()">
            <span>Sair</span><small>logout</small>
          </button>
        </div>
      </aside>

      <!-- CONTENT -->
      <main class="content">
        <div class="topBar">
          <div>
            <h2 style="margin:0;">Painel Admin</h2>
            <div class="hint">Use o menu à esquerda para navegar</div>
          </div>
          <img src="GW.png" class="logo" style="width:160px;margin:0;opacity:0.95;" />
        </div>

        <div id="uiStatus" class="statusBar"></div>

        <hr class="hr">

        <!-- JORNADAS -->
        <div id="secJornadas" class="section active">
          <h3>Jornadas</h3>
          <div class="row">
            <label class="small">De:</label><input type="date" id="inicio">
            <label class="small">Até:</label><input type="date" id="fim">
            <input id="filtroRe" placeholder="Filtrar por RE (opcional)" inputmode="numeric">
            <input id="filtroNome" placeholder="Filtrar por Nome (opcional)">
            <button class="btnPrimary" onclick="buscar()">Buscar</button>
            <button class="btnGhost" onclick="exportar()">Exportar CSV</button>
            <button class="btnGhost" onclick="abrirCriarJornada()">+ Criar Jornada</button>
          </div>

          <table>
            <thead>
              <tr>
                <th>Data (Entrada)</th>
                <th>Nome</th>
                <th>RE</th>
                <th>Entrada</th>
                <th>Início Intervalo</th>
                <th>Fim Intervalo</th>
                <th>Saída</th>
                <th>Entrada HE</th>
                <th>Saída HE</th>
                <th>Local</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyJornadas"></tbody>
          </table>

          <div style="margin-top:10px;">
            <span class="pill">FT = Folga Trabalhada</span>
            <span class="pill">HE = Hora Extra</span>
          </div>
        </div>

        <!-- EXPORTAÇÃO RH -->
        <div id="secExportRH" class="section">
          <h3>Exportação RH</h3>
          <div class="small">
            Exporta um XLSX (stub aqui) • seu export real você pode manter se já tiver.
          </div>

          <div class="row">
            <label class="small">Competência:</label>
            <select id="rhMes"></select>

            <label class="small">Ano:</label>
            <select id="rhAno"></select>

            <button class="btnPrimary" onclick="exportarRHXLSX()">Exportar RH (XLSX)</button>
          </div>

          <div class="small" id="rhStatus" style="margin-top:10px;"></div>
        </div>

        <!-- EXPORTAÇÃO EM MASSA (PDF) -->
        <div id="secExportMassa" class="section">
          <h3>Exportação em massa (PDF)</h3>
          <div class="small">
            1 página por colaborador • Todos os dias do mês (com/sem registro).<br>
            Inclui ATIVOS e também INATIVOS que tiverem apontamento no mês.
          </div>

          <div class="row">
            <label class="small">Competência:</label>
            <select id="pdfMes"></select>

            <label class="small">Ano:</label>
            <select id="pdfAno"></select>

            <button class="btnPrimary" onclick="exportarFolhasPDF_MASSA()">Gerar PDF (massa)</button>
            <button class="btnGhost" onclick="previewResumoMassa()">Prévia / Diagnóstico</button>
          </div>

          <div class="small" id="pdfStatus" style="margin-top:10px;"></div>
        </div>

        <!-- COLABORADORES -->
        <div id="secColab" class="section">
          <h3>Colaboradores</h3>
          <div class="small">CPF obrigatório • Cadastre escala, horário previsto, data admissão e <b>CARGO</b></div>

          <div class="row">
            <input id="colabBuscaRe" placeholder="Buscar por RE" inputmode="numeric">
            <input id="colabBuscaNome" placeholder="Buscar por Nome">
            <button class="btnPrimary" onclick="aplicarFiltroColab()">Buscar</button>
            <button class="btnGhost" onclick="limparFiltroColab()">Limpar</button>
          </div>

          <div class="row">
            <input id="cadRe" placeholder="RE" inputmode="numeric">
            <input id="cadNome" placeholder="Nome completo">
            <input id="cadCpf" placeholder="CPF (obrigatório)" inputmode="numeric">

            <select id="cadCargo"></select>

            <select id="cadEscala">
              <option value="5x2">5x2 (Seg-Sex)</option>
              <option value="6x1">6x1 (Folga Dom)</option>
              <option value="12x36">12x36 (1 trabalha / 1 folga)</option>
            </select>

            <input id="cadHoraEntrada" type="time" title="Hora prevista de entrada (informativo)">
            <input id="cadHoraSaida" type="time" title="Hora prevista de saída (informativo)">
            <input id="cadAdmissao" type="date" title="Data de admissão">

            <button class="btnPrimary" onclick="cadastrarColab()">Cadastrar</button>
            <button class="btnGhost" onclick="carregarColaboradores()">Atualizar lista</button>
          </div>

          <table>
            <thead>
              <tr>
                <th>RE</th>
                <th>Nome</th>
                <th>CPF</th>
                <th>Cargo</th>
                <th>Escala</th>
                <th>Horário</th>
                <th>Admissão</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyColab"></tbody>
          </table>
        </div>

        <!-- CARGOS -->
        <div id="secCargos" class="section">
          <h3>Cargos</h3>
          <div class="small">
            Cadastre: <b>Nome</b>, <b>Database</b>, <b>VR</b>, <b>VA</b>.<br>
            No Colaborador você seleciona o cargo.
          </div>

          <div class="row">
            <input id="cgNome" placeholder="Nome do cargo (ex: Porteiro)">
            <input id="cgDatabase" placeholder="Database (ex: 1800 ou Tabela A)">
            <input id="cgVR" placeholder="VR (ex: 25.00)" inputmode="decimal">
            <input id="cgVA" placeholder="VA (ex: 15.00)" inputmode="decimal">
            <button class="btnPrimary" onclick="cadastrarCargo()">Cadastrar</button>
            <button class="btnGhost" onclick="carregarCargos()">Atualizar lista</button>
          </div>

          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Database</th>
                <th>VR</th>
                <th>VA</th>
                <th>Atualizado</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyCargos"></tbody>
          </table>
        </div>

        <!-- LOCAIS -->
        <div id="secLocal" class="section">
          <h3>Locais</h3>
          <div class="small">margem = raio (metros) • locais podem ser excluídos</div>

          <div class="row">
            <input id="locNome" placeholder="Nome do posto (ex: Posto A)">
            <input id="locLat" placeholder="Latitude (X) ex: -12.3456">
            <input id="locLng" placeholder="Longitude (Y) ex: -38.1234">
            <input id="locRaio" placeholder="Margem (metros) ex: 150" inputmode="numeric">
            <button class="btnPrimary" onclick="cadastrarLocal()">Cadastrar</button>
            <button class="btnGhost" onclick="carregarLocais()">Atualizar lista</button>
          </div>

          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Latitude</th>
                <th>Longitude</th>
                <th>Raio (m)</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyLocais"></tbody>
          </table>
        </div>

        <!-- SUPERVISORES -->
        <div id="secSup" class="section">
          <h3>Supervisores (FT)</h3>
          <div class="small">Cadastro de supervisores (somente nome). Usado no fluxo de FT do registro.</div>

          <div class="row">
            <input id="supNome" placeholder="Nome do supervisor">
            <button class="btnPrimary" onclick="cadastrarSupervisor()">Cadastrar</button>
            <button class="btnGhost" onclick="carregarSupervisores()">Atualizar lista</button>
          </div>

          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Atualizado</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbodySup"></tbody>
          </table>
        </div>

      </main>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modalOverlay" class="modalOverlay" onclick="closeModalIfBackdrop(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <h3 id="modalTitle">Editar</h3>
      <div id="modalBody"></div>
      <div class="actions">
        <button class="btnGhost" onclick="closeModal()">Cancelar</button>
        <button id="modalSaveBtn" class="btnPrimary">Salvar</button>
      </div>
    </div>
  </div>

  <!-- XLSX (se você usar seu export real) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase COMPAT -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    /* ========= FIREBASE CONFIG ========= */
    const firebaseConfig = {
      apiKey: "AIzaSyD--zpWLbLg5X82oGTyz6SuPFQV0sd7NWc",
      authDomain: "controle-ponto-f539b.firebaseapp.com",
      projectId: "controle-ponto-f539b",
      storageBucket: "controle-ponto-f539b.appspot.com",
      messagingSenderId: "324716100257",
      appId: "1:324716100257:web:32d49a9ab4916182dd4ee0",
      measurementId: "G-P81H3C4SFK"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginDiv = document.getElementById("loginDiv");
    const painelDiv = document.getElementById("painelDiv");

    let ultimaTabela = [];
    let cacheLocais = [];
    let cacheColabs = [];
    let cacheSupervisores = [];
    let cacheCargos = [];

    let colabFiltroRe = "";
    let colabFiltroNome = "";

    /* ========= HELPERS ========= */
    function pad2(n){ return String(n).padStart(2,"0"); }
    function norm(s){ return (s||"").toString().trim().toLowerCase(); }
    function safeStr(v){ return (v==null) ? "" : String(v); }

    function toDateAny(ts){
      if (!ts) return null;
      if (ts.toDate) return ts.toDate();
      if (ts instanceof Date) return ts;
      return new Date(ts);
    }

    function ymd(d){
      if (!d || isNaN(d)) return "";
      return d.toISOString().slice(0,10);
    }

    function brDateFromYmd(ymdKey){
      if (!ymdKey) return "";
      const p = String(ymdKey).slice(0,10).split("-");
      if (p.length !== 3) return ymdKey;
      return `${p[2]}/${p[1]}/${p[0]}`;
    }

    function weekdayPtShort(d){
      return d.toLocaleDateString("pt-BR", { weekday:"short" });
    }

    function formatHHMM(ts){
      const d = toDateAny(ts);
      if (!d || isNaN(d)) return "";
      return d.toLocaleTimeString("pt-BR", { hour:"2-digit", minute:"2-digit" });
    }

    function brDateTimeFromIso(ts){
      const d = toDateAny(ts);
      if (!d || isNaN(d)) return "";
      const data = d.toLocaleDateString("pt-BR");
      const hora = d.toLocaleTimeString("pt-BR", {hour:"2-digit", minute:"2-digit"});
      return `${data} ${hora}`;
    }

    function horarioTxt(c){
      const he = (c && c.horaEntrada ? String(c.horaEntrada).trim() : "");
      const hs = (c && c.horaSaida ? String(c.horaSaida).trim() : "");
      if (he && hs) return `${he}–${hs}`;
      if (he || hs) return `${he||"—"}–${hs||"—"}`;
      return "—";
    }

    function parseMoney(v){
      const s = String(v||"").trim().replace(",",".");
      if (!s) return 0;
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }

    function setUiStatus(msg, kind){
      const el = document.getElementById("uiStatus");
      if (!el) return;
      if (!msg){
        el.style.display="none";
        el.textContent="";
        el.classList.remove("ok","err");
        return;
      }
      el.style.display="block";
      el.textContent = msg;
      el.classList.remove("ok","err");
      if (kind==="ok") el.classList.add("ok");
      if (kind==="err") el.classList.add("err");
    }

    function setPdfStatus(msg){
      const el = document.getElementById("pdfStatus");
      if (el) el.textContent = msg || "";
    }

    /* ========= RH + PDF SELECTS ========= */
    function initRhSelectors(){
      const mesSel = document.getElementById("rhMes");
      const anoSel = document.getElementById("rhAno");
      if (!mesSel || !anoSel) return;

      const now = new Date();
      const y = now.getFullYear();

      mesSel.innerHTML = "";
      for (let m=1; m<=12; m++){
        const opt=document.createElement("option");
        opt.value=String(m);
        opt.textContent=pad2(m);
        if (m === (now.getMonth()+1)) opt.selected=true;
        mesSel.appendChild(opt);
      }

      anoSel.innerHTML = "";
      for (let yy=y-3; yy<=y+1; yy++){
        const opt=document.createElement("option");
        opt.value=String(yy);
        opt.textContent=String(yy);
        if (yy===y) opt.selected=true;
        anoSel.appendChild(opt);
      }
    }

    function initPdfSelectors(){
      const mesSel = document.getElementById("pdfMes");
      const anoSel = document.getElementById("pdfAno");
      if (!mesSel || !anoSel) return;

      const now = new Date();
      const y = now.getFullYear();

      mesSel.innerHTML = "";
      for (let m=1; m<=12; m++){
        const opt=document.createElement("option");
        opt.value=String(m);
        opt.textContent=pad2(m);
        if (m === (now.getMonth()+1)) opt.selected=true;
        mesSel.appendChild(opt);
      }

      anoSel.innerHTML = "";
      for (let yy=y-3; yy<=y+1; yy++){
        const opt=document.createElement("option");
        opt.value=String(yy);
        opt.textContent=String(yy);
        if (yy===y) opt.selected=true;
        anoSel.appendChild(opt);
      }
    }

    initRhSelectors();
    initPdfSelectors();

    /* ========= MENU ========= */
    function toggleSidebar(){
      const sb = document.getElementById("sidebar");
      if (!sb) return;
      sb.classList.toggle("open");
    }
    window.toggleSidebar = toggleSidebar;

    function closeSidebarIfMobile(){
      if (window.innerWidth <= 980){
        const sb = document.getElementById("sidebar");
        if (sb) sb.classList.remove("open");
      }
    }

    function showSection(id, btnEl){
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      const sec = document.getElementById(id);
      if (sec) sec.classList.add("active");

      document.querySelectorAll(".nav button").forEach(b => b.classList.remove("activeBtn"));
      if (btnEl) btnEl.classList.add("activeBtn");

      closeSidebarIfMobile();
      setUiStatus("");

      if (id === "secLocal") carregarLocais();
      if (id === "secColab") carregarColaboradores();
      if (id === "secCargos") carregarCargos();
      if (id === "secSup") carregarSupervisores();

      if (id === "secExportMassa"){
        initPdfSelectors();
        carregarColaboradores();
      }
    }
    window.showSection = showSection;

    /* ========= AUTH ========= */
    function login(){
      const btn = document.getElementById("btnLogin");
      btn.disabled = true;
      btn.innerText = "Entrando...";

      const email = (document.getElementById("email").value || "").trim();
      const senha = (document.getElementById("senha").value || "").trim();

      if(!email || !senha){
        alert("Informe email e senha.");
        btn.disabled = false;
        btn.innerText = "Entrar";
        return;
      }

      auth.signInWithEmailAndPassword(email, senha)
        .catch(function(e){
          console.error("LOGIN ERRO:", e);
          alert("Email ou senha inválidos.");
        })
        .finally(function(){
          btn.disabled = false;
          btn.innerText = "Entrar";
        });
    }
    window.login = login;

    function logout(){ auth.signOut(); }
    window.logout = logout;

    auth.onAuthStateChanged(async function(user){
      if(user){
        try{ await user.getIdToken(true); }catch(e){ console.warn("token refresh falhou:", e); }

        loginDiv.style.display = "none";
        painelDiv.style.display = "block";

        try{
          const b = document.getElementById("btnJornadas");
          if (b) b.classList.add("activeBtn");

          setUiStatus("Logado. Carregando dados...");

          await carregarCargos();
          await carregarLocais();
          await carregarColaboradores();
          await carregarSupervisores();

          setUiStatus("✅ Dados carregados.", "ok");
        }catch(e){
          console.error("Erro ao iniciar painel:", e);
          setUiStatus("❌ Erro ao carregar dados. Veja o console (F12).", "err");
        }
      }else{
        loginDiv.style.display = "block";
        painelDiv.style.display = "none";
      }
    });

    /* ========= MODAL ========= */
    const overlay=document.getElementById("modalOverlay");
    const titleEl=document.getElementById("modalTitle");
    const bodyEl=document.getElementById("modalBody");
    const saveBtn=document.getElementById("modalSaveBtn");

    function closeModal(){ overlay.style.display="none"; bodyEl.innerHTML=""; saveBtn.onclick=null; }
    function closeModalIfBackdrop(e){ if (e.target===overlay) closeModal(); }

    window.closeModal = closeModal;
    window.closeModalIfBackdrop = closeModalIfBackdrop;

    function openModal(obj){
      titleEl.innerText = obj.title || "Editar";
      bodyEl.innerHTML = obj.bodyHtml || "";
      overlay.style.display="flex";
      saveBtn.onclick = obj.onSave || null;
    }
    window.openModal = openModal;

    /* ============================================================
       CARGOS (CRUD)  cargos/{id}: {nome, database, vr, va, updatedAt}
    ============================================================ */
    function fillCargoSelects(){
      const sel1 = document.getElementById("cadCargo");
      if (!sel1) return;

      const cur = sel1.value;
      sel1.innerHTML = `<option value="">(Sem cargo)</option>` + cacheCargos.map(c =>
        `<option value="${c.id}">${c.nome}</option>`
      ).join("");
      if (cur) sel1.value = cur;
    }

    function cargoNomeById(id){
      const c = cacheCargos.find(x => x.id === id);
      return c ? c.nome : "";
    }

    async function carregarCargos(){
      setUiStatus("Carregando cargos...");
      try{
        const snap = await db.collection("cargos").get();
        cacheCargos = snap.docs.map(d=>{
          const data = d.data()||{};
          return {
            id: d.id,
            nome: String(data.nome||"").trim(),
            database: String(data.database||"").trim(),
            vr: Number(data.vr||0),
            va: Number(data.va||0),
            updatedAt: String(data.updatedAt||"")
          };
        }).filter(c=>!!c.nome).sort((a,b)=>a.nome.localeCompare(b.nome));

        const tbody = document.getElementById("tbodyCargos");
        if (tbody){
          tbody.innerHTML = "";
          cacheCargos.forEach(c=>{
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${c.nome}</td>
              <td>${c.database || ""}</td>
              <td>${(c.vr||0).toFixed(2)}</td>
              <td>${(c.va||0).toFixed(2)}</td>
              <td>${brDateTimeFromIso(c.updatedAt)}</td>
              <td><button class="minBtn" onclick="editarCargo('${c.id}')">Modificar</button></td>
            `;
            tbody.appendChild(tr);
          });
        }

        fillCargoSelects();
        setUiStatus("✅ Cargos carregados.", "ok");
      }catch(e){
        console.error("carregarCargos ERRO:", e);
        setUiStatus("❌ Falha ao carregar cargos (ver console).", "err");
      }
    }
    window.carregarCargos = carregarCargos;

    async function cadastrarCargo(){
      const nome = (document.getElementById("cgNome").value || "").trim();
      const database = (document.getElementById("cgDatabase").value || "").trim();
      const vr = parseMoney(document.getElementById("cgVR").value);
      const va = parseMoney(document.getElementById("cgVA").value);
      if (!nome){ alert("Informe o nome do cargo."); return; }

      if (!confirm(`Cadastrar cargo?\n${nome}\nDatabase: ${database||"-"}\nVR: ${vr.toFixed(2)}\nVA: ${va.toFixed(2)}`)) return;

      try{
        await db.collection("cargos").add({ nome, database, vr, va, updatedAt: new Date().toISOString() });
        document.getElementById("cgNome").value="";
        document.getElementById("cgDatabase").value="";
        document.getElementById("cgVR").value="";
        document.getElementById("cgVA").value="";
        await carregarCargos();
      }catch(e){
        console.error("cadastrarCargo ERRO:", e);
        alert("Não foi possível cadastrar cargo.");
      }
    }
    window.cadastrarCargo = cadastrarCargo;

    function editarCargo(id){
      const c = cacheCargos.find(x=>x.id===id);
      if (!c){ alert("Cargo não encontrado."); return; }

      openModal({
        title: "Modificar Cargo",
        bodyHtml: `
          <div class="grid">
            <div style="grid-column:1 / -1">
              <label>Nome</label>
              <input id="mcgNome" value="${String(c.nome||"").replaceAll('"','&quot;')}">
            </div>
            <div style="grid-column:1 / -1">
              <label>Database</label>
              <input id="mcgDb" value="${String(c.database||"").replaceAll('"','&quot;')}">
            </div>
            <div>
              <label>VR</label>
              <input id="mcgVr" value="${Number(c.vr||0).toFixed(2)}">
            </div>
            <div>
              <label>VA</label>
              <input id="mcgVa" value="${Number(c.va||0).toFixed(2)}">
            </div>
            <div class="small" style="grid-column:1 / -1">
              <button class="btnDanger" id="btnExcluirCargo" type="button">Excluir cargo</button>
            </div>
          </div>
        `,
        onSave: async function(){
          const nome = (document.getElementById("mcgNome").value || "").trim();
          const database = (document.getElementById("mcgDb").value || "").trim();
          const vr = parseMoney(document.getElementById("mcgVr").value);
          const va = parseMoney(document.getElementById("mcgVa").value);
          if (!nome){ alert("Nome não pode ficar vazio."); return; }
          if (!confirm("Salvar alterações do cargo?")) return;

          try{
            await db.collection("cargos").doc(id).update({ nome, database, vr, va, updatedAt:new Date().toISOString() });
            closeModal();
            await carregarCargos();
            await carregarColaboradores();
          }catch(e){
            console.error("editarCargo ERRO:", e);
            alert("Não foi possível salvar cargo.");
          }
        }
      });

      setTimeout(function(){
        const btn = document.getElementById("btnExcluirCargo");
        if (!btn) return;
        btn.onclick = async function(){
          if (!confirm("Excluir este cargo? (não apaga colaboradores)")) return;
          try{
            await db.collection("cargos").doc(id).delete();
            closeModal();
            await carregarCargos();
          }catch(e){
            console.error("excluirCargo ERRO:", e);
            alert("Não foi possível excluir cargo.");
          }
        };
      }, 0);
    }
    window.editarCargo = editarCargo;

    /* ============================================================
       COLABORADORES  colaboradores/{re}: {nome, cpf, cargoId, escala, horaEntrada, horaSaida, dataAdmissao, ativo}
    ============================================================ */
    function aplicarFiltroColab(){
      colabFiltroRe = (document.getElementById("colabBuscaRe").value || "").trim();
      colabFiltroNome = (document.getElementById("colabBuscaNome").value || "").trim();
      carregarColaboradores();
    }
    window.aplicarFiltroColab = aplicarFiltroColab;

    function limparFiltroColab(){
      document.getElementById("colabBuscaRe").value = "";
      document.getElementById("colabBuscaNome").value = "";
      colabFiltroRe = "";
      colabFiltroNome = "";
      carregarColaboradores();
    }
    window.limparFiltroColab = limparFiltroColab;

    async function carregarColaboradores(){
      try{
        setUiStatus("Carregando colaboradores...");
        const snap = await db.collection("colaboradores").get();
        cacheColabs = snap.docs.map(d=>{
          const data = d.data()||{};
          return {
            id: d.id,
            re: String(data.re || d.id).trim(),
            nome: String(data.nome||"").trim(),
            cpf: String(data.cpf||"").trim(),
            cargoId: String(data.cargoId||"").trim(),
            escala: String(data.escala||"5x2").trim(),
            horaEntrada: String(data.horaEntrada||"").trim(),
            horaSaida: String(data.horaSaida||"").trim(),
            dataAdmissao: String(data.dataAdmissao||"").slice(0,10),
            ativo: (data.ativo !== false),
            updatedAt: String(data.updatedAt||"")
          };
        });

        let list = [...cacheColabs];
        if (colabFiltroRe) list = list.filter(c => c.re.includes(colabFiltroRe));
        if (colabFiltroNome) list = list.filter(c => norm(c.nome).includes(norm(colabFiltroNome)));

        list.sort((a,b)=>String(a.nome||"").localeCompare(String(b.nome||"")));

        const tbody = document.getElementById("tbodyColab");
        if (tbody){
          tbody.innerHTML = "";
          list.forEach(c=>{
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${c.re}</td>
              <td>${c.nome || ""}</td>
              <td>${c.cpf || ""}</td>
              <td>${cargoNomeById(c.cargoId) || ""}</td>
              <td>${c.escala || ""}</td>
              <td>${horarioTxt(c)}</td>
              <td>${c.dataAdmissao ? brDateFromYmd(c.dataAdmissao) : ""}</td>
              <td>${c.ativo ? "ATIVO" : "INATIVO"}</td>
              <td><button class="minBtn" onclick="editarColab('${c.re}')">Modificar</button></td>
            `;
            tbody.appendChild(tr);
          });
        }

        fillCargoSelects();
        setUiStatus("✅ Colaboradores carregados.", "ok");
      }catch(e){
        console.error("carregarColaboradores ERRO:", e);
        setUiStatus("❌ Falha ao carregar colaboradores (ver console).", "err");
      }
    }
    window.carregarColaboradores = carregarColaboradores;

    async function cadastrarColab(){
      const re = (document.getElementById("cadRe").value || "").trim();
      const nome = (document.getElementById("cadNome").value || "").trim();
      const cpf = (document.getElementById("cadCpf").value || "").trim();
      const cargoId = (document.getElementById("cadCargo").value || "").trim();
      const escala = (document.getElementById("cadEscala").value || "").trim();
      const horaEntrada = (document.getElementById("cadHoraEntrada").value || "").trim();
      const horaSaida = (document.getElementById("cadHoraSaida").value || "").trim();
      const dataAdmissao = (document.getElementById("cadAdmissao").value || "").trim();

      if (!re) { alert("Informe o RE."); return; }
      if (!nome) { alert("Informe o nome."); return; }
      if (!cpf) { alert("CPF obrigatório."); return; }

      if (!confirm(`Cadastrar/Atualizar colaborador?\nRE: ${re}\nNome: ${nome}\nCPF: ${cpf}\nCargo: ${cargoNomeById(cargoId)||"—"}`)) return;

      try{
        await db.collection("colaboradores").doc(re).set({
          re, nome, cpf, cargoId, escala, horaEntrada, horaSaida,
          dataAdmissao: dataAdmissao || "",
          ativo: true,
          updatedAt: new Date().toISOString()
        }, { merge:true });

        document.getElementById("cadRe").value="";
        document.getElementById("cadNome").value="";
        document.getElementById("cadCpf").value="";
        document.getElementById("cadCargo").value="";
        document.getElementById("cadEscala").value="5x2";
        document.getElementById("cadHoraEntrada").value="";
        document.getElementById("cadHoraSaida").value="";
        document.getElementById("cadAdmissao").value="";

        await carregarColaboradores();
      }catch(e){
        console.error("cadastrarColab ERRO:", e);
        alert("Não foi possível cadastrar colaborador.");
      }
    }
    window.cadastrarColab = cadastrarColab;

    function editarColab(re){
      const c = cacheColabs.find(x => String(x.re) === String(re));
      if (!c){ alert("Colaborador não encontrado no cache. Clique em 'Atualizar lista'."); return; }

      openModal({
        title: "Modificar Colaborador",
        bodyHtml: `
          <div class="grid">
            <div>
              <label>RE</label>
              <input id="mcRe" value="${String(c.re).replaceAll('"','&quot;')}" disabled>
            </div>
            <div>
              <label>Status</label>
              <select id="mcAtivo">
                <option value="true" ${c.ativo ? "selected":""}>ATIVO</option>
                <option value="false" ${!c.ativo ? "selected":""}>INATIVO</option>
              </select>
            </div>
            <div style="grid-column:1 / -1">
              <label>Nome</label>
              <input id="mcNome" value="${String(c.nome||"").replaceAll('"','&quot;')}">
            </div>
            <div>
              <label>CPF</label>
              <input id="mcCpf" value="${String(c.cpf||"").replaceAll('"','&quot;')}">
            </div>
            <div>
              <label>Cargo</label>
              <select id="mcCargo"></select>
            </div>
            <div>
              <label>Escala</label>
              <select id="mcEscala">
                <option value="5x2" ${c.escala==="5x2"?"selected":""}>5x2</option>
                <option value="6x1" ${c.escala==="6x1"?"selected":""}>6x1</option>
                <option value="12x36" ${c.escala==="12x36"?"selected":""}>12x36</option>
              </select>
            </div>
            <div>
              <label>Hora Entrada</label>
              <input id="mcHE" type="time" value="${c.horaEntrada||""}">
            </div>
            <div>
              <label>Hora Saída</label>
              <input id="mcHS" type="time" value="${c.horaSaida||""}">
            </div>
            <div>
              <label>Admissão</label>
              <input id="mcAdm" type="date" value="${c.dataAdmissao||""}">
            </div>
          </div>
        `,
        onSave: async function(){
          const nome = (document.getElementById("mcNome").value || "").trim();
          const cpf  = (document.getElementById("mcCpf").value || "").trim();
          const cargoId = (document.getElementById("mcCargo").value || "").trim();
          const escala = (document.getElementById("mcEscala").value || "").trim();
          const horaEntrada = (document.getElementById("mcHE").value || "").trim();
          const horaSaida = (document.getElementById("mcHS").value || "").trim();
          const dataAdmissao = (document.getElementById("mcAdm").value || "").trim();
          const ativo = (document.getElementById("mcAtivo").value === "true");

          if (!nome){ alert("Nome obrigatório."); return; }
          if (!cpf){ alert("CPF obrigatório."); return; }
          if (!confirm("Salvar alterações do colaborador?")) return;

          try{
            await db.collection("colaboradores").doc(re).set({
              nome, cpf, cargoId, escala, horaEntrada, horaSaida,
              dataAdmissao: dataAdmissao || "",
              ativo,
              updatedAt: new Date().toISOString()
            }, { merge:true });

            closeModal();
            await carregarColaboradores();
          }catch(e){
            console.error("editarColab ERRO:", e);
            alert("Não foi possível salvar colaborador.");
          }
        }
      });

      setTimeout(function(){
        const sel = document.getElementById("mcCargo");
        if (sel){
          sel.innerHTML = `<option value="">(Sem cargo)</option>` + cacheCargos.map(x =>
            `<option value="${x.id}">${x.nome}</option>`
          ).join("");
          sel.value = c.cargoId || "";
        }
      }, 0);
    }
    window.editarColab = editarColab;

    /* ============================================================
       LOCAIS  locais/{id}: {nome, lat, lng, raio, updatedAt}
    ============================================================ */
    async function carregarLocais(){
      try{
        const snap = await db.collection("locais").get();
        cacheLocais = snap.docs.map(d=>{
          const data=d.data()||{};
          return {
            id:d.id,
            nome:String(data.nome||"").trim(),
            lat:safeStr(data.lat||""),
            lng:safeStr(data.lng||""),
            raio:safeStr(data.raio||""),
            updatedAt:String(data.updatedAt||"")
          };
        }).filter(x=>x.nome).sort((a,b)=>a.nome.localeCompare(b.nome));

        const tbody = document.getElementById("tbodyLocais");
        if (tbody){
          tbody.innerHTML="";
          cacheLocais.forEach(l=>{
            const tr=document.createElement("tr");
            tr.innerHTML = `
              <td>${l.nome}</td>
              <td>${l.lat}</td>
              <td>${l.lng}</td>
              <td>${l.raio}</td>
              <td><button class="minBtn" onclick="excluirLocal('${l.id}')">Excluir</button></td>
            `;
            tbody.appendChild(tr);
          });
        }
      }catch(e){
        console.error("carregarLocais ERRO:", e);
      }
    }
    window.carregarLocais = carregarLocais;

    async function cadastrarLocal(){
      const nome=(document.getElementById("locNome").value||"").trim();
      const lat=(document.getElementById("locLat").value||"").trim();
      const lng=(document.getElementById("locLng").value||"").trim();
      const raio=(document.getElementById("locRaio").value||"").trim();
      if(!nome){ alert("Informe o nome do local."); return; }

      try{
        await db.collection("locais").add({ nome, lat, lng, raio, updatedAt:new Date().toISOString() });
        document.getElementById("locNome").value="";
        document.getElementById("locLat").value="";
        document.getElementById("locLng").value="";
        document.getElementById("locRaio").value="";
        await carregarLocais();
      }catch(e){
        console.error("cadastrarLocal ERRO:", e);
        alert("Não foi possível cadastrar local.");
      }
    }
    window.cadastrarLocal = cadastrarLocal;

    async function excluirLocal(id){
      if(!confirm("Excluir este local?")) return;
      try{
        await db.collection("locais").doc(id).delete();
        await carregarLocais();
      }catch(e){
        console.error("excluirLocal ERRO:", e);
        alert("Não foi possível excluir local.");
      }
    }
    window.excluirLocal = excluirLocal;

    /* ============================================================
       SUPERVISORES  supervisores/{id}: {nome, updatedAt}
    ============================================================ */
    async function carregarSupervisores(){
      try{
        const snap = await db.collection("supervisores").get();
        cacheSupervisores = snap.docs.map(d=>{
          const data=d.data()||{};
          return { id:d.id, nome:String(data.nome||"").trim(), updatedAt:String(data.updatedAt||"") };
        }).filter(x=>x.nome).sort((a,b)=>a.nome.localeCompare(b.nome));

        const tbody = document.getElementById("tbodySup");
        if (tbody){
          tbody.innerHTML="";
          cacheSupervisores.forEach(s=>{
            const tr=document.createElement("tr");
            tr.innerHTML = `
              <td>${s.nome}</td>
              <td>${brDateTimeFromIso(s.updatedAt)}</td>
              <td><button class="minBtn" onclick="excluirSupervisor('${s.id}')">Excluir</button></td>
            `;
            tbody.appendChild(tr);
          });
        }
      }catch(e){
        console.error("carregarSupervisores ERRO:", e);
      }
    }
    window.carregarSupervisores = carregarSupervisores;

    async function cadastrarSupervisor(){
      const nome=(document.getElementById("supNome").value||"").trim();
      if(!nome){ alert("Informe o nome."); return; }
      try{
        await db.collection("supervisores").add({ nome, updatedAt:new Date().toISOString() });
        document.getElementById("supNome").value="";
        await carregarSupervisores();
      }catch(e){
        console.error("cadastrarSupervisor ERRO:", e);
        alert("Não foi possível cadastrar supervisor.");
      }
    }
    window.cadastrarSupervisor = cadastrarSupervisor;

    async function excluirSupervisor(id){
      if(!confirm("Excluir este supervisor?")) return;
      try{
        await db.collection("supervisores").doc(id).delete();
        await carregarSupervisores();
      }catch(e){
        console.error("excluirSupervisor ERRO:", e);
        alert("Não foi possível excluir supervisor.");
      }
    }
    window.excluirSupervisor = excluirSupervisor;

    /* ============================================================
       JORNADAS (mínimo para LISTAR + CSV)  jornadas/{id}
       OBS: criação via modal abaixo usa sua lógica de turno noturno (mantida)
    ============================================================ */
    function dateFromYmdAndTime(ymdKey, hhmm){
      const m = (hhmm||"").trim().match(/^([01]\d|2[0-3]):([0-5]\d)$/);
      if (!m) return null;
      const hh=Number(m[1]), mm=Number(m[2]);
      const dt = new Date(`${ymdKey}T${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}:00`);
      if (isNaN(dt)) return null;
      return dt;
    }
    function addDays(dt, days){ const d=new Date(dt); d.setDate(d.getDate()+days); return d; }
    function dateRelativeToBase(baseDate, hhmm){
      const m = (hhmm||"").trim().match(/^([01]\d|2[0-3]):([0-5]\d)$/);
      if (!m) return null;
      const hh=Number(m[1]), mm=Number(m[2]);
      const cand = new Date(baseDate);
      cand.setHours(hh, mm, 0, 0);
      if (cand < baseDate) return addDays(cand, 1);
      return cand;
    }

    async function buscar(){
      try{
        setUiStatus("Buscando jornadas...");
        const ini = (document.getElementById("inicio").value||"").trim();
        const fim = (document.getElementById("fim").value||"").trim();
        const filtroRe = (document.getElementById("filtroRe").value||"").trim();
        const filtroNome = norm((document.getElementById("filtroNome").value||"").trim());

        // fallback: se não informar datas, pega últimas 200
        let query = db.collection("jornadas");
        const hasIni = !!ini, hasFim = !!fim;

        if (hasIni) query = query.where("entrada.ts", ">=", `${ini}T00:00:00.000Z`);
        if (hasFim) query = query.where("entrada.ts", "<=", `${fim}T23:59:59.999Z`);

        // sem orderBy aqui pra não estourar index; pega e ordena localmente
        const snap = await query.get();
        let rows = snap.docs.map(d=>({ id:d.id, ...d.data() }));

        // ordena por entrada.ts desc
        rows.sort((a,b)=>String(b?.entrada?.ts||"").localeCompare(String(a?.entrada?.ts||"")));

        if (filtroRe) rows = rows.filter(r => String(r.re||"").includes(filtroRe));
        if (filtroNome) rows = rows.filter(r => norm(r.nome||"").includes(filtroNome));

        ultimaTabela = rows;

        const tbody = document.getElementById("tbodyJornadas");
        if (tbody){
          tbody.innerHTML = "";
          rows.forEach(r=>{
            const ent = String(r?.entrada?.ts||"");
            const dataEnt = ent ? brDateFromYmd(ent.slice(0,10)) : "";
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${dataEnt}</td>
              <td>${safeStr(r.nome||"")}</td>
              <td>${safeStr(r.re||"")}</td>
              <td>${formatHHMM(r?.entrada?.ts)}</td>
              <td>${formatHHMM(r?.saida_intervalo?.ts)}</td>
              <td>${formatHHMM(r?.retorno_intervalo?.ts)}</td>
              <td>${formatHHMM(r?.saida?.ts)}</td>
              <td>${formatHHMM(r?.entrada_he?.ts)}</td>
              <td>${formatHHMM(r?.saida_he?.ts)}</td>
              <td>${safeStr(r?.entrada?.posto||"")}</td>
              <td><button class="minBtn" onclick="excluirJornada('${r.id}')">Excluir</button></td>
            `;
            tbody.appendChild(tr);
          });
        }

        setUiStatus(`✅ Jornadas: ${rows.length}`, "ok");
      }catch(e){
        console.error("buscar ERRO:", e);
        setUiStatus("❌ Falha ao buscar jornadas (ver console).", "err");
      }
    }
    window.buscar = buscar;

    function exportar(){
      if (!ultimaTabela || !ultimaTabela.length){
        alert("Nada para exportar. Faça uma busca.");
        return;
      }
      const head = ["data_entrada","nome","re","entrada","saida_intervalo","retorno_intervalo","saida","entrada_he","saida_he","posto"];
      const lines = [head.join(";")];

      ultimaTabela.forEach(r=>{
        const ent = String(r?.entrada?.ts||"");
        const row = [
          ent ? ent.slice(0,10) : "",
          safeStr(r.nome||""),
          safeStr(r.re||""),
          formatHHMM(r?.entrada?.ts),
          formatHHMM(r?.saida_intervalo?.ts),
          formatHHMM(r?.retorno_intervalo?.ts),
          formatHHMM(r?.saida?.ts),
          formatHHMM(r?.entrada_he?.ts),
          formatHHMM(r?.saida_he?.ts),
          safeStr(r?.entrada?.posto||"")
        ];
        lines.push(row.map(v=>String(v).replaceAll(";"," ")).join(";"));
      });

      const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `jornadas_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }
    window.exportar = exportar;

    async function excluirJornada(id){
      if (!confirm("Excluir esta jornada?")) return;
      try{
        await db.collection("jornadas").doc(id).delete();
        await buscar();
      }catch(e){
        console.error("excluirJornada ERRO:", e);
        alert("Não foi possível excluir jornada.");
      }
    }
    window.excluirJornada = excluirJornada;

    async function existeEntradaNoDia(re, ymdKey){
      const snap = await db.collection("jornadas").where("re","==",re).get();
      const all = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      return all.some(j => String(j?.entrada?.ts||"").slice(0,10) === ymdKey);
    }

    function abrirCriarJornada(){
      openModal({
        title: "Criar Jornada (Admin)",
        bodyHtml: `
          <div class="grid">
            <div>
              <label>RE</label>
              <input id="cjRe" placeholder="RE" inputmode="numeric">
            </div>
            <div>
              <label>Data (da ENTRADA)</label>
              <input id="cjData" type="date">
            </div>
            <div>
              <label>Hora ENTRADA</label>
              <input id="cjEntrada" type="time" value="08:00">
            </div>
            <div>
              <label>Hora SAÍDA</label>
              <input id="cjSaida" type="time" value="17:48">
              <div class="small" style="text-align:left;">✅ Se a saída for menor que a entrada, assume <b>dia seguinte</b> (turno noturno).</div>
            </div>
            <div>
              <label>Início intervalo (opcional)</label>
              <input id="cjSaiInt" type="time">
            </div>
            <div>
              <label>Fim intervalo (opcional)</label>
              <input id="cjRetInt" type="time">
            </div>
            <div>
              <label>Entrada HE (opcional)</label>
              <input id="cjEntHe" type="time">
            </div>
            <div>
              <label>Saída HE (opcional)</label>
              <input id="cjSaiHe" type="time">
            </div>
            <div style="grid-column:1 / -1">
              <label>Posto (opcional)</label>
              <input id="cjPosto" placeholder="Ex: Posto A">
            </div>
          </div>
        `,
        onSave: async function(){
          const re = (document.getElementById("cjRe").value || "").trim();
          const data = (document.getElementById("cjData").value || "").trim();
          const hEnt = (document.getElementById("cjEntrada").value || "").trim();
          const hSai = (document.getElementById("cjSaida").value || "").trim();

          const hSaiInt = (document.getElementById("cjSaiInt").value || "").trim();
          const hRetInt = (document.getElementById("cjRetInt").value || "").trim();
          const hEntHe  = (document.getElementById("cjEntHe").value || "").trim();
          const hSaiHe  = (document.getElementById("cjSaiHe").value || "").trim();

          const posto = (document.getElementById("cjPosto").value || "").trim();

          if (!re){ alert("Informe o RE."); return; }
          if (!data){ alert("Informe a data."); return; }
          if (!hEnt){ alert("Informe a hora de ENTRADA."); return; }
          if (!hSai){ alert("Informe a hora de SAÍDA."); return; }

          const entDt = dateFromYmdAndTime(data, hEnt);
          if (!entDt){ alert("Horário de ENTRADA inválido."); return; }
          const saiDt = dateRelativeToBase(entDt, hSai);
          if (!saiDt){ alert("Horário de SAÍDA inválido."); return; }

          // colab precisa existir
          const colSnap = await db.collection("colaboradores").doc(re).get();
          if (!colSnap.exists){ alert("Colaborador não encontrado."); return; }
          const col = colSnap.data()||{};
          const nome = String(col.nome||"").trim();
          if (!nome){ alert("Colaborador sem nome cadastrado."); return; }

          if (await existeEntradaNoDia(re, data)){
            alert("❌ Já existe uma jornada com ENTRADA nesse dia para este RE.");
            return;
          }

          const payload = {
            re, nome,
            status: "fechada",
            entrada: { ts: entDt.toISOString(), posto: posto||"" },
            saida: { ts: saiDt.toISOString(), posto: posto||"" },
            updatedAt: new Date().toISOString(),
            adminCriada: true
          };

          if (hSaiInt) payload.saida_intervalo = { ts: dateRelativeToBase(entDt, hSaiInt).toISOString(), posto: posto||"" };
          if (hRetInt) payload.retorno_intervalo = { ts: dateRelativeToBase(entDt, hRetInt).toISOString(), posto: posto||"" };
          if (hEntHe)  payload.entrada_he = { ts: dateRelativeToBase(entDt, hEntHe).toISOString(), posto: posto||"" };
          if (hSaiHe)  payload.saida_he = { ts: dateRelativeToBase(entDt, hSaiHe).toISOString(), posto: posto||"" };

          if (!confirm(`Criar jornada?\nRE: ${re}\nData: ${brDateFromYmd(data)}\nEntrada: ${hEnt}\nSaída: ${hSai}`)) return;

          await db.collection("jornadas").add(payload);
          closeModal();
          await buscar();
          alert("✅ Jornada criada.");
        }
      });
    }
    window.abrirCriarJornada = abrirCriarJornada;

    /* ============================================================
       EXPORT RH XLSX (stub) — mantenha seu export real se já tiver
    ============================================================ */
    function exportarRHXLSX(){
      const mes = document.getElementById("rhMes").value;
      const ano = document.getElementById("rhAno").value;
      document.getElementById("rhStatus").textContent = `Stub: export RH ${pad2(mes)}/${ano}. (Se você já tinha seu export real, pode colar aqui.)`;
    }
    window.exportarRHXLSX = exportarRHXLSX;

    /* ============================================================
       PDF MASSA — TODOS OS DIAS + ATIVOS + INATIVOS COM APONTAMENTO
    ============================================================ */
    function monthDaysList(year, month1to12){
      const last = new Date(year, month1to12, 0).getDate();
      const out = [];
      for (let d=1; d<=last; d++){
        out.push(new Date(year, month1to12-1, d, 12, 0, 0));
      }
      return out;
    }

    function findJornadaByDay(re, ymdKey, jornadasAll){
      return (jornadasAll||[]).find(j =>
        String(j?.re||"").trim()===String(re).trim() &&
        String(j?.entrada?.ts||"").slice(0,10)===ymdKey
      ) || null;
    }

    async function previewResumoMassa(){
      const mes = Number(document.getElementById("pdfMes").value);
      const ano = Number(document.getElementById("pdfAno").value);
      setPdfStatus("Analisando mês...");

      const snapCol = await db.collection("colaboradores").get();
      const colaboradores = snapCol.docs.map(d=>({ id:d.id, ...d.data() }));

      const snapJ = await db.collection("jornadas").get();
      const jornadas = snapJ.docs.map(d=>({ id:d.id, ...d.data() }));

      const hasInMonth = (re)=>{
        return jornadas.some(j=>{
          if (String(j.re||"")!==String(re)) return false;
          const d = toDateAny(j?.entrada?.ts);
          return d && d.getFullYear()===ano && (d.getMonth()+1)===mes;
        });
      };

      const list = colaboradores
        .map(c=>{
          const re = String(c.re || c.id || "").trim();
          const ativo = (c.ativo !== false);
          return { re, nome:c.nome||"", ativo, include: (ativo || hasInMonth(re)) };
        })
        .filter(x=>x.re && x.include)
        .sort((a,b)=>String(a.nome||"").localeCompare(String(b.nome||"")));

      setPdfStatus(`Prévia: ${list.length} colaboradores serão exportados em ${pad2(mes)}/${ano}.`);
    }
    window.previewResumoMassa = previewResumoMassa;

    async function exportarFolhasPDF_MASSA(){
      try{
        const mes = Number(document.getElementById("pdfMes").value);
        const ano = Number(document.getElementById("pdfAno").value);

        setPdfStatus("Carregando dados do Firestore...");

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("p","pt","a4");

        const [snapCol, snapJ] = await Promise.all([
          db.collection("colaboradores").get(),
          db.collection("jornadas").get()
        ]);

        const colaboradores = snapCol.docs.map(d=>({ id:d.id, ...d.data() }));
        const jornadasAll = snapJ.docs.map(d=>({ id:d.id, ...d.data() }));

        const hasInMonth = (re)=>{
          return jornadasAll.some(j=>{
            if (String(j.re||"")!==String(re)) return false;
            const d = toDateAny(j?.entrada?.ts);
            return d && d.getFullYear()===ano && (d.getMonth()+1)===mes;
          });
        };

        const lista = colaboradores
          .map(c=>{
            const re = String(c.re || c.id || "").trim();
            const ativo = (c.ativo !== false);
            const include = ativo || hasInMonth(re);
            return { ...c, re, ativo, include };
          })
          .filter(x => x.re && x.include)
          .sort((a,b)=>String(a.nome||"").localeCompare(String(b.nome||"")));

        const days = monthDaysList(ano, mes);

        let first = true;
        setPdfStatus(`Gerando PDF... (${lista.length} colaboradores)`);

        for (let idx=0; idx<lista.length; idx++){
          const col = lista[idx];
          const re = col.re;

          if (!first) doc.addPage();
          first = false;

          doc.setFontSize(14);
          doc.text("Folha de Frequência — Espelho de Ponto", 40, 40);

          doc.setFontSize(10);
          doc.text(`Nome: ${col.nome||""}`, 40, 62);
          doc.text(`RE: ${re}`, 40, 78);
          doc.text(`Cargo: ${cargoNomeById(String(col.cargoId||"")) || ""}`, 40, 94);
          doc.text(`Competência: ${pad2(mes)}/${ano}`, 40, 110);

          const body = [];

          for (const dt of days){
            const ymdKey = ymd(dt);
            const j = findJornadaByDay(re, ymdKey, jornadasAll);

            body.push([
              brDateFromYmd(ymdKey),
              weekdayPtShort(dt),
              j ? "OK" : "",
              formatHHMM(j?.entrada?.ts),
              formatHHMM(j?.saida_intervalo?.ts),
              formatHHMM(j?.retorno_intervalo?.ts),
              formatHHMM(j?.saida?.ts),
              formatHHMM(j?.entrada_he?.ts),
              formatHHMM(j?.saida_he?.ts)
            ]);
          }

          doc.autoTable({
            startY:130,
            head:[["Data","Dia","Status","Ent","Ini Int","Fim Int","Sai","HE Ent","HE Sai"]],
            body,
            styles:{ fontSize:8 },
            headStyles:{ fontSize:8 }
          });

          setPdfStatus(`Gerando... ${idx+1}/${lista.length}`);
        }

        const filename = `Folhas_Massa_${pad2(mes)}-${ano}.pdf`;
        doc.save(filename);
        setPdfStatus(`✅ Exportado: ${filename}`);
      }catch(e){
        console.error("exportarFolhasPDF_MASSA ERRO:", e);
        setPdfStatus("❌ Falha ao exportar (veja o console).");
        alert("Falha ao exportar PDF em massa.");
      }
    }
    window.exportarFolhasPDF_MASSA = exportarFolhasPDF_MASSA;

    /* ========= DEBUG DB (pra seu “não puxa nada”) ========= */
    async function debugDB(){
      try{
        const u = auth.currentUser;
        console.log("AUTH:", u?.email, u?.uid);
        if (!u){ alert("Não está logado."); return; }

        const tests = ["colaboradores","jornadas","locais","cargos","supervisores"];
        for (const col of tests){
          try{
            const snap = await db.collection(col).limit(3).get();
            console.log("OK READ", col, "docs:", snap.size);
          }catch(e){
            console.error("FAIL READ", col, e.code, e.message, e);
          }
        }
        alert("Debug finalizado. Veja o console (F12).");
      }catch(e){
        console.error("debugDB ERRO:", e);
      }
    }
    window.debugDB = debugDB;

  </script>
</body>
</html>
