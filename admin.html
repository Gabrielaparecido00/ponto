<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Painel Admin</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

<style>
  *{ box-sizing:border-box; }
  body{
    font-family:'Montserrat', Arial, sans-serif;
    background:#f0f0f0;
    padding:12px;
    margin:0;
    text-align:center;
  }
  .container{
    max-width:1300px;
    margin:12px auto;
    background:#fff;
    padding:14px;
    border-radius:12px;
    box-shadow:0 2px 10px rgba(0,0,0,0.08);
  }
  .logo{ width:220px; display:block; margin:0 auto 8px; max-width:90vw; height:auto; }

  h2{ margin:8px 0 10px; text-align:center; }
  h3{ margin:10px 0 8px; text-align:center; } /* ✅ centralizado */
  .small{ font-size:12px; color:#666; text-align:left; }

  input, select, button{
    font-family:inherit;
    padding:10px;
    border-radius:10px;
    border:1px solid #ddd;
    outline:none;
  }
  button{ cursor:pointer; }
  button:hover{ filter:brightness(0.98); }

  .row{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    justify-content:center;
    align-items:end;
    margin-top:10px;
  }

  .hr{ height:1px; background:#eee; margin:18px 0; border:0; }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:14px;
    font-size:13px;
  }
  th, td{
    border:1px solid #e2e2e2;
    padding:8px;
    text-align:left;
    vertical-align:top;
  }
  th{ background:#fafafa; }

  .menu{
    display:flex;
    gap:8px;
    justify-content:center;
    flex-wrap:wrap;
    margin-top:10px;
  }
  .menu button{
    background:#1f6feb;
    color:#fff;
    border:none;
    border-radius:10px;
    padding:10px 14px;
  }
  .menu button.secondary{ background:#6c757d; }
  .menu button.activeBtn{ filter:brightness(0.92); }

  .minBtn{
    border:1px solid #ddd;
    background:#fff;
    border-radius:10px;
    padding:6px 10px;
    font-size:12px;
  }
  .minBtn:hover{ background:#f3f3f3; }

  .section{ display:none; }
  .section.active{ display:block; }

  /* MODAL (POPUP) - cabe na tela com scroll interno */
  .modalOverlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.45);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
    padding:10px;
  }
  .modal{
    background:#fff;
    width:min(920px, 96vw);
    max-height:92vh;
    overflow:auto;
    border-radius:12px;
    padding:14px;
    box-shadow:0 10px 30px rgba(0,0,0,0.22);
    text-align:left;
  }
  .modal h3{ margin:0 0 10px; text-align:left; }
  .modal .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  .modal label{ font-size:12px; color:#555; }
  .modal input, .modal select{
    width:100%;
    margin-top:4px;
  }
  .modal .actions{
    position:sticky;
    bottom:0;
    background:#fff;
    padding-top:10px;
    margin-top:10px;
    display:flex;
    justify-content:flex-end;
    gap:8px;
    border-top:1px solid #eee;
  }
  .modal .actions button{
    border:none;
    border-radius:10px;
    padding:10px 14px;
  }
  .btnPrimary{ background:#1f6feb; color:#fff; }
  .btnGhost{ background:#e9ecef; }
  .btnDangerInline{
    display:inline-block;
    border:1px solid #f2b8b5;
    background:#fff0f0;
    border-radius:10px;
    padding:8px 10px;
    font-size:12px;
    cursor:pointer;
    color:#a10000;
  }

  /* ✅ filtro colaboradores */
  .filterBar{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    justify-content:center;
    margin-top:10px;
  }
  .filterBar input{
    min-width:220px;
    width:min(320px, 90vw);
  }

  @media (max-width: 820px){
    table{ font-size:12px; }
    th, td{ padding:6px; }
    .modal .grid{ grid-template-columns:1fr; }
  }
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginDiv" class="container">
  <img src="GW.png" class="logo" />
  <h2>Login Admin</h2>
  <input id="email" placeholder="Email"><br><br>
  <input id="senha" type="password" placeholder="Senha"><br><br>
  <button onclick="login()">Entrar</button>
</div>

<!-- PAINEL -->
<div id="painelDiv" class="container" style="display:none;">
  <img src="GW.png" class="logo" />
  <h2>Painel Admin</h2>

  <div class="small">
    Editar horários no formato: <b>DD/MM/AAAA HH:MM</b> (ex: 16/02/2026 07:10)
  </div>

  <div class="menu">
    <button id="btnJornadas" onclick="showSection('secJornadas', this)">Jornadas</button>
    <button id="btnExportRH" onclick="showSection('secExportRH', this)">Exportação RH</button>
    <button id="btnColab" onclick="showSection('secColab', this)">Colaboradores</button>
    <button id="btnLocal" onclick="showSection('secLocal', this)">Locais</button>
    <button id="btnOcorr" onclick="showSection('secOcorr', this)">Ocorrências (dia)</button>
    <button id="btnAfast" onclick="showSection('secAfast', this)">Férias (período)</button>
    <button id="btnPlantoes" onclick="showSection('secPlantoes', this)">Plantões 12x36</button>
    <button class="secondary" onclick="logout()">Sair</button>
  </div>

  <hr class="hr">

  <!-- JORNADAS -->
  <div id="secJornadas" class="section active">
    <h3>Jornadas</h3>
    <div class="row">
      <label>De:</label><input type="date" id="inicio">
      <label>Até:</label><input type="date" id="fim">
      <input id="filtroRe" placeholder="Filtrar por RE (opcional)" inputmode="numeric">
      <input id="filtroNome" placeholder="Filtrar por Nome (opcional)">
      <button onclick="buscar()">Buscar</button>
      <button onclick="exportar()">Exportar CSV</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Data (Entrada)</th>
          <th>Nome</th>
          <th>RE</th>
          <th>Entrada</th>
          <th>Início Intervalo</th>
          <th>Fim Intervalo</th>
          <th>Saída</th>
          <th>Entrada HE</th>
          <th>Saída HE</th>
          <th>Coords</th>
          <th>Local</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyJornadas"></tbody>
    </table>
  </div>

  <!-- EXPORTAÇÃO RH -->
  <div id="secExportRH" class="section">
    <h3>Exportação RH</h3>
    <div class="small">
      Gera um único XLSX com 3 abas: <b>Resumo</b>, <b>Diário</b> e <b>Escala</b>.<br>
      Usa horário planejado (por dia da semana) para separar <b>Hora Normal</b> vs <b>HE</b>.<br>
      <b>FT (Folga Trabalhada) NÃO é HE</b>: se trabalhar na folga, vai para FT e não entra em HE.<br>
      <b>Exporta apenas colaboradores ATIVOS (ativo === true).</b>
    </div>

    <div class="row">
      <label>Competência (mês):</label>
      <select id="rhMes"></select>

      <label>Ano:</label>
      <select id="rhAno"></select>

      <button onclick="exportarRHXLSX()">Exportar RH (XLSX)</button>
    </div>

    <div class="small" id="rhStatus" style="margin-top:10px;"></div>

    <hr class="hr">

    <div class="small">
      Regras rápidas:
      <ul style="margin:8px 0 0 16px; padding:0; text-align:left;">
        <li>Ocorrência / Férias têm prioridade e entram no Diário.</li>
        <li>Sem horário planejado no dia: o trabalhado vira <b>Normal</b> (para não inventar HE).</li>
        <li>Trabalho em folga: vira <b>FT</b> (Folga Trabalhada) e <b>não</b> conta como HE.</li>
        <li>Campo HE (entrada_he/saida_he): conta como <b>HE</b> apenas em dia de trabalho; em folga vira <b>FT</b>.</li>
      </ul>
    </div>
  </div>

  <!-- COLABORADORES -->
  <div id="secColab" class="section">
    <h3>Colaboradores</h3>
    <div class="small">CPF é obrigatório • Sem excluir colaborador • Cadastre escala, horário previsto e data de admissão</div>

    <div class="row">
      <input id="cadRe" placeholder="RE" inputmode="numeric">
      <input id="cadNome" placeholder="Nome completo">
      <input id="cadCpf" placeholder="CPF (obrigatório)" inputmode="numeric">

      <select id="cadEscala">
        <option value="5x2">5x2 (Seg-Sex)</option>
        <option value="6x1">6x1 (Folga Dom)</option>
        <option value="12x36">12x36 (1 trabalha / 1 folga)</option>
      </select>

      <input id="cadHoraEntrada" type="time" title="Hora prevista de entrada (informativo)">
      <input id="cadHoraSaida" type="time" title="Hora prevista de saída (informativo)">

      <input id="cadAdmissao" type="date" title="Data de admissão">

      <button onclick="cadastrarColab()">Cadastrar</button>
      <button onclick="carregarColaboradores()">Atualizar lista</button>
    </div>

    <!-- ✅ BUSCADOR -->
    <div class="filterBar">
      <input id="colabFiltroRe" placeholder="Buscar por RE..." inputmode="numeric">
      <input id="colabFiltroNome" placeholder="Buscar por Nome...">
      <button class="minBtn" onclick="limparFiltroColab()">Limpar</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>RE</th>
          <th>Nome</th>
          <th>CPF</th>
          <th>Escala</th>
          <th>Horário</th>
          <th>Admissão</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyColab"></tbody>
    </table>
  </div>

  <!-- LOCAIS -->
  <div id="secLocal" class="section">
    <h3>Locais</h3>
    <div class="small">margem = raio (metros) • locais podem ser excluídos</div>

    <div class="row">
      <input id="locNome" placeholder="Nome do posto (ex: Posto A)">
      <input id="locLat" placeholder="Latitude (X) ex: -12.3456">
      <input id="locLng" placeholder="Longitude (Y) ex: -38.1234">
      <input id="locRaio" placeholder="Margem (metros) ex: 150" inputmode="numeric">
      <button onclick="cadastrarLocal()">Cadastrar</button>
      <button onclick="carregarLocais()">Atualizar lista</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th>Raio (m)</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyLocais"></tbody>
    </table>
  </div>

  <!-- OCORRÊNCIAS -->
  <div id="secOcorr" class="section">
    <h3>Ocorrências (por dia)</h3>
    <div class="small">
      Ao salvar (FALTA/ATESTADO/ABONO), a ocorrência vira prioridade e apaga jornadas do dia (pela data da ENTRADA).
    </div>

    <div class="row">
      <input id="ocRe" placeholder="RE" inputmode="numeric">
      <input id="ocData" type="date">
      <select id="ocTipo">
        <option value="falta">FALTA</option>
        <option value="atestado">ATESTADO</option>
        <option value="abono">ABONO</option>
      </select>
      <input id="ocMotivo" placeholder="Motivo (opcional)">
      <button onclick="salvarOcorrencia()">Salvar ocorrência (prioritária)</button>
    </div>

    <hr class="hr">

    <div class="row">
      <input id="ocFiltroRe" placeholder="Filtrar RE (opcional)" inputmode="numeric">
      <input id="ocFiltroData" type="date" title="Filtrar data (opcional)">
      <button onclick="carregarOcorrencias()">Atualizar lista</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>RE</th>
          <th>Nome</th>
          <th>Tipo</th>
          <th>Motivo</th>
          <th>Atualizado</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyOcorr"></tbody>
    </table>
  </div>

  <!-- FÉRIAS -->
  <div id="secAfast" class="section">
    <h3>Férias (por período)</h3>
    <div class="small">
      Cadastre 1 período e o sistema marca automaticamente no espelho (somente dias de trabalho).<br>
      Ao salvar férias, o sistema apaga jornadas do período (dias úteis, conforme escala do colaborador).
    </div>

    <div class="row">
      <input id="afRe" placeholder="RE" inputmode="numeric">
      <input id="afInicio" type="date">
      <input id="afFim" type="date">
      <label style="display:flex;align-items:center;gap:6px;font-size:12px;">
        <input type="checkbox" id="afDiasUteis" checked> Somente dias de trabalho
      </label>
      <input id="afMotivo" placeholder="Motivo (opcional)">
      <button onclick="salvarFerias()">Salvar FÉRIAS</button>
      <button onclick="carregarFerias()">Atualizar lista</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>RE</th>
          <th>Nome</th>
          <th>Período</th>
          <th>Somente dias trabalho?</th>
          <th>Motivo</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyFerias"></tbody>
    </table>
  </div>

  <!-- PLANTÕES 12x36 -->
  <div id="secPlantoes" class="section">
    <h3>Plantões 12x36</h3>
    <div class="small">
      Cadastre uma regra de base por vigência: se em <b>DATA</b> a pessoa estará em <b>TRABALHA</b> ou <b>FOLGA</b>.<br>
      O sistema usa o histórico (não altera o passado ao trocar o plantão depois).<br>
      <b>IMPORTANTE:</b> após salvar, sincroniza em <b>colaboradores/{re}.plantaoHistorico</b>.
    </div>

    <div class="row">
      <input id="plRe" placeholder="RE" inputmode="numeric">
      <input id="plVigencia" type="date" title="A partir desta data (inclusive)">
      <select id="plBase">
        <option value="trabalha">TRABALHA (dia base)</option>
        <option value="folga">FOLGA (dia base)</option>
      </select>
      <input id="plObs" placeholder="Obs (opcional) ex: Mudança de plantão">
      <button onclick="salvarPlantao12x36()">Salvar 12x36</button>
    </div>

    <hr class="hr">

    <div class="row">
      <input id="plFiltroRe" placeholder="Filtrar RE (opcional)" inputmode="numeric">
      <button onclick="carregarPlantoes12x36()">Atualizar lista</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>RE</th>
          <th>Nome</th>
          <th>Vigência</th>
          <th>Base</th>
          <th>Obs</th>
          <th>Atualizado</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyPlantoes"></tbody>
    </table>
  </div>

</div>

<!-- MODAL -->
<div id="modalOverlay" class="modalOverlay" onclick="closeModalIfBackdrop(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <h3 id="modalTitle">Editar</h3>
    <div id="modalBody"></div>
    <div class="actions">
      <button class="btnGhost" onclick="closeModal()">Cancelar</button>
      <button id="modalSaveBtn" class="btnPrimary">Salvar</button>
    </div>
  </div>
</div>

<!-- XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDocs, collection, updateDoc, addDoc,
  deleteDoc, deleteField, query, where, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyD--zpWLbLg5X82oGTyz6SuPFQV0sd7NWc",
  authDomain: "controle-ponto-f539b.firebaseapp.com",
  projectId: "controle-ponto-f539b",
  storageBucket: "controle-ponto-f539b.firebasestorage.app",
  messagingSenderId: "324716100257",
  appId: "1:324716100257:web:32d49a9ab4916182dd4ee0",
  measurementId: "G-P81H3C4SFK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const loginDiv = document.getElementById("loginDiv");
const painelDiv = document.getElementById("painelDiv");

let ultimaTabela = [];
let cacheLocais = [];
let cacheColabs = [];
let cacheFerias = [];
let cacheOcorr = [];
let cachePlantoes = [];

// ===== RH selects (mês/ano) =====
function pad2(n){ return String(n).padStart(2,"0"); }
function initRhSelectors(){
  const mesSel = document.getElementById("rhMes");
  const anoSel = document.getElementById("rhAno");
  if (!mesSel || !anoSel) return;

  const now = new Date();
  const y = now.getFullYear();

  mesSel.innerHTML = "";
  for (let m=1; m<=12; m++){
    const opt=document.createElement("option");
    opt.value=String(m);
    opt.textContent=pad2(m);
    if (m === (now.getMonth()+1)) opt.selected=true;
    mesSel.appendChild(opt);
  }

  anoSel.innerHTML = "";
  for (let yy=y-3; yy<=y+1; yy++){
    const opt=document.createElement("option");
    opt.value=String(yy);
    opt.textContent=String(yy);
    if (yy===y) opt.selected=true;
    anoSel.appendChild(opt);
  }
}
initRhSelectors();

// ===== menu
window.showSection = function(id, btnEl){
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  document.querySelectorAll(".menu button").forEach(b => b.classList.remove("activeBtn"));
  if (btnEl) btnEl.classList.add("activeBtn");

  if (id === "secLocal") carregarLocais();
  if (id === "secColab") carregarColaboradores();
  if (id === "secAfast") { carregarColaboradores().then(carregarFerias); }
  if (id === "secOcorr") { carregarColaboradores().then(carregarOcorrencias); }
  if (id === "secPlantoes") { carregarColaboradores().then(carregarPlantoes12x36); }
};

// ===== auth
window.login = async function(){
  const email = document.getElementById("email").value;
  const senha = document.getElementById("senha").value;
  try { await signInWithEmailAndPassword(auth, email, senha); }
  catch(e){ alert("Erro no login."); }
};
window.logout = function(){ signOut(auth); };

onAuthStateChanged(auth, user => {
  loginDiv.style.display = user ? "none" : "block";
  painelDiv.style.display = user ? "block" : "none";
  if (user){
    const b = document.getElementById("btnJornadas");
    if (b) b.classList.add("activeBtn");
    carregarLocais();
    carregarColaboradores();
    setupFiltroColab();
  }
});

// ===== helpers
function norm(s){ return (s||"").toString().trim().toLowerCase(); }
function toDateAny(ts){
  if (!ts) return null;
  if (ts.toDate) return ts.toDate();
  if (ts instanceof Date) return ts;
  return new Date(ts);
}
function formatHHMM(ts){
  const d = toDateAny(ts);
  if (!d || isNaN(d)) return "";
  return d.toLocaleTimeString("pt-BR", { hour:"2-digit", minute:"2-digit" });
}
function formatBRDate(ts){
  const d = toDateAny(ts);
  if (!d || isNaN(d)) return "";
  return d.toLocaleDateString("pt-BR");
}
function brDateFromYmd(ymd){
  if (!ymd) return "";
  const [y,m,d] = ymd.split("-");
  if (!y||!m||!d) return ymd;
  return `${d}/${m}/${y}`;
}
function isoFromBrDateTime(str){
  const m = (str||"").trim().match(/^(\d{2})\/(\d{2})\/(\d{4})\s+([01]\d|2[0-3]):([0-5]\d)$/);
  if (!m) return null;
  const dd=m[1], mm=m[2], yyyy=m[3], hh=m[4], mi=m[5];
  const dt = new Date(`${yyyy}-${mm}-${dd}T${hh}:${mi}:00`);
  if (isNaN(dt)) return null;
  return dt.toISOString();
}
function brDateTimeFromIso(ts){
  const d = toDateAny(ts);
  if (!d || isNaN(d)) return "";
  const data = d.toLocaleDateString("pt-BR");
  const hora = d.toLocaleTimeString("pt-BR", {hour:"2-digit", minute:"2-digit"});
  return `${data} ${hora}`;
}
function horarioTxt(c){
  const he = (c?.horaEntrada||"").trim();
  const hs = (c?.horaSaida||"").trim();
  if (he && hs) return `${he}–${hs}`;
  if (he || hs) return `${he||"—"}–${hs||"—"}`;
  return "—";
}
function ymd(d){
  if (!d || isNaN(d)) return "";
  return d.toISOString().slice(0,10);
}

// ===== modal
const overlay=document.getElementById("modalOverlay");
const titleEl=document.getElementById("modalTitle");
const bodyEl=document.getElementById("modalBody");
const saveBtn=document.getElementById("modalSaveBtn");

window.closeModal=function(){ overlay.style.display="none"; bodyEl.innerHTML=""; saveBtn.onclick=null; };
window.closeModalIfBackdrop=function(e){ if (e.target===overlay) closeModal(); };

function openModal({title, bodyHtml, onSave}){
  titleEl.innerText=title;
  bodyEl.innerHTML=bodyHtml;
  overlay.style.display="flex";
  saveBtn.onclick=onSave || null;
}

// ===== localização/posto
function haversineMeters(lat1, lon1, lat2, lon2){
  const R=6371000; const toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function parseLocation(str){
  if (!str) return null;
  const p=str.split(",").map(s=>s.trim());
  if (p.length!==2) return null;
  const lat=Number(p[0]), lng=Number(p[1]);
  if (!Number.isFinite(lat)||!Number.isFinite(lng)) return null;
  return {lat,lng};
}
function getBestLocationFromJornada(j){
  const steps=["saida_he","entrada_he","saida","retorno_intervalo","saida_intervalo","entrada"];
  for (const s of steps){ const loc=j?.[s]?.location; if (loc) return loc; }
  return "";
}
function reconhecerLocal(locationStr){
  const p=parseLocation(locationStr);
  if (!p) return "Não disponível";
  let best=null;
  for (const l of cacheLocais){
    const d=haversineMeters(p.lat,p.lng,l.lat,l.lng);
    if (d<=l.raio){ if (!best || d<best.d) best={nome:l.nome,d}; }
  }
  return best ? best.nome : "Não reconhecido";
}

// ===== 12x36 helpers
function getPlantaoReferencia(dateObj, historico){
  if (!Array.isArray(historico) || !historico.length) return null;
  const key = ymd(dateObj);
  let best = null;
  for (const p of historico){
    const ini = String(p?.inicio || p?.vigencia || "").slice(0,10);
    if (!/^\d{4}-\d{2}-\d{2}$/.test(ini)) continue;
    if (ini <= key){
      if (!best || ini > String(best.inicio||"")) best = { ...p, inicio: ini };
    }
  }
  return best;
}
function isFolgaByEscala(dateObj, escala, plantaoHistorico){
  const dow = dateObj.getDay();
  const e = (escala || "5x2").toLowerCase();
  if (e === "5x2") return (dow === 0 || dow === 6);
  if (e === "6x1") return (dow === 0);

  const eh12x36 = e.includes("12") && e.includes("36");
  if (eh12x36){
    const plantao = getPlantaoReferencia(dateObj, plantaoHistorico || []);
    if (!plantao) return false;
    const baseYmd = String(plantao.inicio||"").slice(0,10);
    const baseTipo = String(plantao.base||"trabalha").toLowerCase();
    const base = new Date(baseYmd + "T00:00:00");
    const atual = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), 12, 0, 0);
    const diffDias = Math.floor((atual - base) / 86400000);
    const trabalha = (diffDias % 2) === 0 ? (baseTipo === "trabalha") : (baseTipo !== "trabalha");
    return !trabalha;
  }
  return false;
}
function isDiaTrabalho(dateObj, escala, plantaoHistorico){
  return !isFolgaByEscala(dateObj, escala, plantaoHistorico);
}

// ===== SYNC 12x36 -> colaborador.plantaoHistorico
async function syncPlantaoHistoricoToColaborador(re){
  const qP = query(collection(db,"plantoes12x36"), where("re","==",re));
  const snap = await getDocs(qP);
  let list = snap.docs.map(d => ({ id:d.id, ...(d.data()||{}) }));
  list.sort((a,b) => String(a.vigencia||"").localeCompare(String(b.vigencia||"")));

  const historico = list
    .map(p => ({
      inicio: String(p.vigencia||"").slice(0,10),
      base: String(p.base||"trabalha").toLowerCase(),
      obs: String(p.obs||""),
      updatedAt: String(p.updatedAt||"")
    }))
    .filter(p => /^\d{4}-\d{2}-\d{2}$/.test(p.inicio));

  await setDoc(doc(db,"colaboradores",re), {
    plantaoHistorico: historico,
    updatedAt: new Date().toISOString()
  }, { merge:true });
}

// ===== COLABORADORES
window.cadastrarColab = async function(){
  const re = document.getElementById("cadRe").value.trim();
  const nome = document.getElementById("cadNome").value.trim();
  let cpf = document.getElementById("cadCpf").value.trim();
  const escala = document.getElementById("cadEscala").value;
  const horaEntrada = (document.getElementById("cadHoraEntrada").value || "").trim();
  const horaSaida = (document.getElementById("cadHoraSaida").value || "").trim();
  const dataAdmissao = (document.getElementById("cadAdmissao").value || "").trim();

  if (!re || !nome) return alert("Preencha RE e Nome.");
  cpf = cpf.replace(/\D/g,"");
  if (!cpf || cpf.length < 4) return alert("CPF é obrigatório (mínimo 4 dígitos).");
  if (!dataAdmissao) return alert("Data de admissão é obrigatória.");

  if (!confirm(
    `Cadastrar?\nRE: ${re}\nNome: ${nome}\nEscala: ${escala}\nHorário (info): ${horaEntrada||"—"}–${horaSaida||"—"}\nAdmissão: ${brDateFromYmd(dataAdmissao)}`
  )) return;

  await setDoc(doc(db,"colaboradores",re), {
    re, nome, cpf, escala, horaEntrada, horaSaida,
    dataAdmissao,
    horariosSemana: {},
    ativo:true,
    updatedAt:new Date().toISOString()
  }, { merge:true });

  document.getElementById("cadRe").value="";
  document.getElementById("cadNome").value="";
  document.getElementById("cadCpf").value="";
  document.getElementById("cadEscala").value="5x2";
  document.getElementById("cadHoraEntrada").value="";
  document.getElementById("cadHoraSaida").value="";
  document.getElementById("cadAdmissao").value="";
  carregarColaboradores();
};

// ✅ filtros colaboradores
function getColabFiltros(){
  const fr = norm(document.getElementById("colabFiltroRe")?.value || "");
  const fn = norm(document.getElementById("colabFiltroNome")?.value || "");
  return { fr, fn };
}
function aplicarFiltroColab(list){
  const { fr, fn } = getColabFiltros();
  let out = list;
  if (fr) out = out.filter(c => norm(c.re || c.id) === fr || norm(c.re || c.id).includes(fr));
  if (fn) out = out.filter(c => norm(c.nome).includes(fn));
  return out;
}
window.limparFiltroColab = function(){
  const a = document.getElementById("colabFiltroRe");
  const b = document.getElementById("colabFiltroNome");
  if (a) a.value = "";
  if (b) b.value = "";
  carregarColaboradores();
};
function setupFiltroColab(){
  const a = document.getElementById("colabFiltroRe");
  const b = document.getElementById("colabFiltroNome");
  if (!a || !b) return;
  if (a.dataset.bound === "1") return;
  a.dataset.bound = "1";
  b.dataset.bound = "1";
  const handler = () => carregarColaboradores();
  a.addEventListener("input", handler);
  b.addEventListener("input", handler);
}

window.carregarColaboradores = async function(){
  const snap = await getDocs(collection(db,"colaboradores"));
  cacheColabs = snap.docs.map(d => ({ id:d.id, ...d.data() }))
    .sort((a,b)=> (a.nome||"").localeCompare(b.nome||""));

  setupFiltroColab();

  const tbody=document.getElementById("tbodyColab");
  if (tbody){
    tbody.innerHTML="";
    const list = aplicarFiltroColab(cacheColabs);

    for (const c of list){
      const status = (c.ativo === false) ? "Inativo" : "Ativo";
      const escala = (c.escala || "5x2");
      const adm = (c.dataAdmissao ? brDateFromYmd(String(c.dataAdmissao).slice(0,10)) : "—");
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${c.re || c.id}</td>
        <td>${c.nome || ""}</td>
        <td>${c.cpf || ""}</td>
        <td>${escala}</td>
        <td>${horarioTxt(c)}</td>
        <td>${adm}</td>
        <td>${status}</td>
        <td><button class="minBtn" onclick="editarColab('${c.id}')">Modificar</button></td>
      `;
      tbody.appendChild(tr);
    }
  }
};

// ===== horário por semana (modal) + BLOQUEIOS por escala
function normalizeWeekSchedule(raw){
  const out = {};
  for (let d=0; d<=6; d++){
    const k = String(d);
    const v = raw?.[k];
    if (!v) { out[k] = null; continue; }
    const i = (v.in || v.entrada || "").toString().trim();
    const o = (v.out || v.saida || "").toString().trim();
    if (!i || !o) out[k] = null;
    else out[k] = { in:i, out:o };
  }
  return out;
}
function diasPadraoPorEscala(escala){
  const e = (escala||"5x2").toLowerCase();
  if (e==="5x2") return [1,2,3,4,5];
  if (e==="6x1") return [1,2,3,4,5,6];
  if (e.includes("12") && e.includes("36")) return [0,1,2,3,4,5,6];
  return [1,2,3,4,5];
}
function diasBloqueadosPorEscala(escala){
  const e = (escala||"5x2").toLowerCase();
  if (e === "5x2") return new Set([0,6]); // Dom e Sáb bloqueados
  if (e === "6x1") return new Set([0]);   // Dom bloqueado
  return new Set();                       // 12x36 e outros: sem bloqueio
}
function weekLabel(d){ return ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"][d] || String(d); }

function buildHorarioSemanaHtml(horariosSemana, escala){
  const hs = normalizeWeekSchedule(horariosSemana);
  const marcadosDefault = new Set(diasPadraoPorEscala(escala));
  const bloqueados = diasBloqueadosPorEscala(escala);

  const rows = [];
  for (let d=0; d<=6; d++){
    const cur = hs[String(d)];
    const isBlocked = bloqueados.has(d);
    const checked = (marcadosDefault.has(d) && !isBlocked);

    rows.push(`
      <div style="border:1px solid #eee; border-radius:10px; padding:10px; ${isBlocked ? "opacity:.65" : ""}">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <label style="display:flex; gap:8px; align-items:center; margin:0;">
            <input type="checkbox" class="wkChk" data-d="${d}" ${checked ? "checked" : ""} ${isBlocked ? "disabled" : ""}>
            <b>${weekLabel(d)}</b>
          </label>
          <span class="small">${isBlocked ? "BLOQUEADO pela escala" : "se desmarcar, vira folga planejada"}</span>
        </div>

        <div style="display:flex; gap:8px; margin-top:8px;">
          <div style="flex:1;">
            <label>Entrada</label>
            <input type="time" class="wkIn" data-d="${d}" value="${isBlocked ? "" : (cur?.in || "")}" ${isBlocked ? "disabled" : ""}>
          </div>
          <div style="flex:1;">
            <label>Saída</label>
            <input type="time" class="wkOut" data-d="${d}" value="${isBlocked ? "" : (cur?.out || "")}" ${isBlocked ? "disabled" : ""}>
          </div>
        </div>
      </div>
    `);
  }

  return `
    <div style="grid-column:1 / -1; margin-top:8px; padding:12px; border:1px solid #eee; border-radius:12px;">
      <div style="font-weight:700; margin-bottom:6px;">Horários por dia da semana (cálculo RH)</div>
      <div class="small" style="margin-bottom:10px;">
        1) Marque os dias • 2) Preencha o primeiro dia • 3) Clique “Replicar” • 4) Ajuste dia a dia.<br>
        <b>5x2:</b> Sáb/Dom ficam bloqueados.
      </div>

      <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:10px;">
        <button type="button" class="minBtn" id="btnAutoDias">Marcar dias pela escala</button>
        <button type="button" class="minBtn" id="btnReplicar">Replicar do primeiro dia marcado</button>
        <span class="small">* Para 12x36, isso define apenas “horário base”; o calendário vem do histórico.</span>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;" id="wkGrid">
        ${rows.join("")}
      </div>
    </div>
  `;
}
function readHorarioSemanaFromModal(){
  const hs = {};
  const chks = Array.from(document.querySelectorAll(".wkChk"));
  for (const chk of chks){
    const d = chk.getAttribute("data-d");
    const enabled = chk.checked;

    const inEl = document.querySelector(\`.wkIn[data-d="\${d}"]\`);
    const outEl = document.querySelector(\`.wkOut[data-d="\${d}"]\`);

    const i = (inEl?.value || "").trim();
    const o = (outEl?.value || "").trim();

    if (!enabled){
      hs[String(d)] = null;
      if (inEl) inEl.value="";
      if (outEl) outEl.value="";
      continue;
    }
    if (!i || !o) hs[String(d)] = null;
    else hs[String(d)] = { in:i, out:o };
  }
  return hs;
}

window.editarColab = function(reDocId){
  const c = cacheColabs.find(x => x.id === reDocId);
  if (!c) return alert("Colaborador não encontrado.");

  const escalaAtual = (c.escala || "5x2");

  openModal({
    title: "Modificar colaborador",
    bodyHtml: `
      <div class="grid">
        <div>
          <label>RE</label>
          <input id="mRe" value="${c.re || c.id}" disabled>
        </div>
        <div>
          <label>CPF (obrigatório)</label>
          <input id="mCpf" value="${c.cpf || ""}" placeholder="Somente números">
        </div>

        <div style="grid-column:1 / -1">
          <label>Nome</label>
          <input id="mNome" value="${c.nome || ""}">
        </div>

        <div>
          <label>Escala</label>
          <select id="mEscala">
            <option value="5x2" ${(escalaAtual)==="5x2" ? "selected" : ""}>5x2 (Seg-Sex)</option>
            <option value="6x1" ${(escalaAtual)==="6x1" ? "selected" : ""}>6x1 (Folga Dom)</option>
            <option value="12x36" ${(escalaAtual)==="12x36" ? "selected" : ""}>12x36 (1 trabalha / 1 folga)</option>
          </select>
        </div>

        <div>
          <label>Status</label>
          <select id="mAtivo">
            <option value="true" ${c.ativo === false ? "" : "selected"}>Ativo</option>
            <option value="false" ${c.ativo === false ? "selected" : ""}>Inativo</option>
          </select>
        </div>

        <div>
          <label>Hora entrada prevista (info)</label>
          <input id="mHoraEntrada" type="time" value="${(c.horaEntrada||"").toString().trim()}">
        </div>
        <div>
          <label>Hora saída prevista (info)</label>
          <input id="mHoraSaida" type="time" value="${(c.horaSaida||"").toString().trim()}">
        </div>

        <div style="grid-column:1 / -1">
          <label>Data de admissão (obrigatório)</label>
          <input id="mAdmissao" type="date" value="${String(c.dataAdmissao||"").slice(0,10)}">
        </div>

        ${buildHorarioSemanaHtml(c.horariosSemana || {}, escalaAtual)}
      </div>
    `,
    onSave: async () => {
      const nome = document.getElementById("mNome").value.trim();
      let cpf = document.getElementById("mCpf").value.trim().replace(/\D/g,"");
      const ativo = document.getElementById("mAtivo").value === "true";
      const escala = document.getElementById("mEscala").value;
      const horaEntrada = (document.getElementById("mHoraEntrada").value || "").trim();
      const horaSaida = (document.getElementById("mHoraSaida").value || "").trim();
      const dataAdmissao = (document.getElementById("mAdmissao").value || "").trim();
      const horariosSemana = readHorarioSemanaFromModal();

      if (!nome) return alert("Nome não pode ficar vazio.");
      if (!cpf || cpf.length < 4) return alert("CPF é obrigatório (mínimo 4 dígitos).");
      if (!dataAdmissao) return alert("Data de admissão é obrigatória.");
      if (!confirm("Salvar alteração do colaborador?")) return;

      await setDoc(doc(db,"colaboradores",reDocId), {
        nome, cpf, ativo, escala, horaEntrada, horaSaida,
        dataAdmissao,
        horariosSemana,
        updatedAt:new Date().toISOString()
      }, { merge:true });

      closeModal();
      carregarColaboradores();
      carregarFerias();
      carregarOcorrencias();
      carregarPlantoes12x36();
    }
  });

  setTimeout(() => {
    const escSel = document.getElementById("mEscala");
    const btnAuto = document.getElementById("btnAutoDias");
    const btnRep = document.getElementById("btnReplicar");

    function applyAutoDias(){
      const esc = escSel?.value || escalaAtual;
      const days = new Set(diasPadraoPorEscala(esc));
      const blocked = diasBloqueadosPorEscala(esc);

      for (let d=0; d<=6; d++){
        const chk = document.querySelector(\`.wkChk[data-d="\${d}"]\`);
        const i = document.querySelector(\`.wkIn[data-d="\${d}"]\`);
        const o = document.querySelector(\`.wkOut[data-d="\${d}"]\`);
        const isBlocked = blocked.has(d);

        if (chk){
          chk.disabled = isBlocked;
          chk.checked = (!isBlocked && days.has(d));
        }
        if (i){
          i.disabled = isBlocked;
          if (isBlocked) i.value = "";
          else if (!days.has(d)) i.value = "";
        }
        if (o){
          o.disabled = isBlocked;
          if (isBlocked) o.value = "";
          else if (!days.has(d)) o.value = "";
        }
      }
    }

    function replicateFromFirst(){
      const esc = escSel?.value || escalaAtual;
      const blocked = diasBloqueadosPorEscala(esc);

      let first = null;
      for (let d=0; d<=6; d++){
        if (blocked.has(d)) continue;
        const chk = document.querySelector(\`.wkChk[data-d="\${d}"]\`);
        if (!chk || !chk.checked) continue;
        const i = document.querySelector(\`.wkIn[data-d="\${d}"]\`)?.value || "";
        const o = document.querySelector(\`.wkOut[data-d="\${d}"]\`)?.value || "";
        if (i && o){ first = { in:i, out:o }; break; }
      }
      if (!first) return alert("Preencha o horário (entrada/saída) no primeiro dia marcado antes de replicar.");

      for (let d=0; d<=6; d++){
        if (blocked.has(d)) continue;
        const chk = document.querySelector(\`.wkChk[data-d="\${d}"]\`);
        if (!chk || !chk.checked) continue;
        const i = document.querySelector(\`.wkIn[data-d="\${d}"]\`);
        const o = document.querySelector(\`.wkOut[data-d="\${d}"]\`);
        if (i && !i.value) i.value = first.in;
        if (o && !o.value) o.value = first.out;
      }
    }

    if (btnAuto) btnAuto.onclick = applyAutoDias;
    if (btnRep) btnRep.onclick = replicateFromFirst;

    // se desmarcar, limpa horários (apenas nos não-bloqueados)
    for (let d=0; d<=6; d++){
      const chk = document.querySelector(\`.wkChk[data-d="\${d}"]\`);
      if (!chk) continue;
      chk.addEventListener("change", () => {
        if (!chk.checked){
          const i = document.querySelector(\`.wkIn[data-d="\${d}"]\`);
          const o = document.querySelector(\`.wkOut[data-d="\${d}"]\`);
          if (i) i.value = "";
          if (o) o.value = "";
        }
      });
    }
  }, 0);
};

// ===== LOCAIS
window.cadastrarLocal = async function(){
  const nome = document.getElementById("locNome").value.trim();
  const lat = Number(document.getElementById("locLat").value.trim());
  const lng = Number(document.getElementById("locLng").value.trim());
  const raio = Number(document.getElementById("locRaio").value.trim());

  if (!nome || !Number.isFinite(lat) || !Number.isFinite(lng) || !Number.isFinite(raio)){
    return alert("Preencha Nome, Latitude, Longitude e Raio.");
  }
  if (!confirm(`Cadastrar local?\n${nome}\n(${lat}, ${lng})\nRaio: ${raio}m`)) return;

  await addDoc(collection(db,"locais"), { nome, lat, lng, raio, updatedAt:new Date().toISOString() });

  document.getElementById("locNome").value="";
  document.getElementById("locLat").value="";
  document.getElementById("locLng").value="";
  document.getElementById("locRaio").value="";
  carregarLocais();
};

window.carregarLocais = async function(){
  const snap = await getDocs(collection(db,"locais"));
  cacheLocais = snap.docs.map(d => ({ id:d.id, ...d.data() }))
    .filter(l => Number.isFinite(l.lat) && Number.isFinite(l.lng) && Number.isFinite(l.raio))
    .sort((a,b)=> (a.nome||"").localeCompare(b.nome||""));

  const tbody=document.getElementById("tbodyLocais");
  tbody.innerHTML="";

  for (const l of cacheLocais){
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${l.nome || ""}</td>
      <td>${l.lat}</td>
      <td>${l.lng}</td>
      <td>${l.raio}</td>
      <td><button class="minBtn" onclick="editarLocal('${l.id}')">Modificar</button></td>
    `;
    tbody.appendChild(tr);
  }
};

window.editarLocal = function(id){
  const l = cacheLocais.find(x => x.id === id);
  if (!l) return alert("Local não encontrado.");

  openModal({
    title: "Modificar local",
    bodyHtml: `
      <div class="grid">
        <div style="grid-column:1 / -1">
          <label>Nome</label>
          <input id="mlNome" value="${l.nome || ""}">
        </div>
        <div>
          <label>Latitude</label>
          <input id="mlLat" value="${l.lat}">
        </div>
        <div>
          <label>Longitude</label>
          <input id="mlLng" value="${l.lng}">
        </div>
        <div style="grid-column:1 / -1">
          <label>Raio (m)</label>
          <input id="mlRaio" value="${l.raio}">
        </div>
        <div class="small" style="grid-column:1 / -1">
          <button class="btnDangerInline" id="btnExcluirLocal">Excluir local</button>
        </div>
      </div>
    `,
    onSave: async () => {
      const nome = document.getElementById("mlNome").value.trim();
      const lat = Number(document.getElementById("mlLat").value.trim());
      const lng = Number(document.getElementById("mlLng").value.trim());
      const raio = Number(document.getElementById("mlRaio").value.trim());

      if (!nome || !Number.isFinite(lat) || !Number.isFinite(lng) || !Number.isFinite(raio)){
        return alert("Preencha corretamente Nome, Latitude, Longitude e Raio.");
      }
      if (!confirm("Salvar alterações do local?")) return;

      await updateDoc(doc(db,"locais",id), { nome, lat, lng, raio, updatedAt:new Date().toISOString() });
      closeModal();
      carregarLocais();
      buscar();
    }
  });

  setTimeout(() => {
    const btn = document.getElementById("btnExcluirLocal");
    if (!btn) return;
    btn.onclick = async () => {
      if (!confirm("Excluir este local?")) return;
      await deleteDoc(doc(db,"locais",id));
      closeModal();
      carregarLocais();
      buscar();
    };
  }, 0);
};

// ===== JORNADAS
window.buscar = async function(){
  const iniStr = document.getElementById("inicio").value || "2000-01-01";
  const fimStr = document.getElementById("fim").value || "2999-12-31";
  const filtroRe = norm(document.getElementById("filtroRe").value);
  const filtroNome = norm(document.getElementById("filtroNome").value);

  const snap = await getDocs(collection(db,"jornadas"));
  let jornadas = snap.docs.map(d => ({ id:d.id, ...d.data() }));

  jornadas = jornadas.filter(j => {
    const iso = (j.entrada?.ts || "").toString();
    const d = iso ? iso.slice(0,10) : "";
    if (!d) return false;
    return d >= iniStr && d <= fimStr;
  });

  if (filtroRe) jornadas = jornadas.filter(j => norm(j.re) === filtroRe);
  if (filtroNome) jornadas = jornadas.filter(j => norm(j.nome).includes(filtroNome));

  jornadas.sort((a,b) => (toDateAny(b.entrada?.ts)||new Date(0)) - (toDateAny(a.entrada?.ts)||new Date(0)));
  ultimaTabela = jornadas;
  montarJornadas(jornadas);
};

function montarJornadas(jornadas){
  const tbody=document.getElementById("tbodyJornadas");
  tbody.innerHTML="";

  for (const j of jornadas){
    const dataEntrada = formatBRDate(j.entrada?.ts);
    const loc = getBestLocationFromJornada(j);
    const rec = reconhecerLocal(loc);

    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${dataEntrada}</td>
      <td>${j.nome || ""}</td>
      <td>${j.re || ""}</td>
      <td>${formatHHMM(j.entrada?.ts)}</td>
      <td>${formatHHMM(j.saida_intervalo?.ts)}</td>
      <td>${formatHHMM(j.retorno_intervalo?.ts)}</td>
      <td>${formatHHMM(j.saida?.ts)}</td>
      <td>${formatHHMM(j.entrada_he?.ts)}</td>
      <td>${formatHHMM(j.saida_he?.ts)}</td>
      <td>${loc || ""}</td>
      <td>${rec}</td>
      <td><button class="minBtn" onclick="editarJornada('${j.id}')">Modificar</button></td>
    `;
    tbody.appendChild(tr);
  }
}

window.editarJornada = function(docId){
  const j = ultimaTabela.find(x => x.id === docId);
  if (!j) return alert("Jornada não encontrada.");

  const val = (ts) => brDateTimeFromIso(ts);

  openModal({
    title: `Modificar Jornada — RE ${j.re}`,
    bodyHtml: `
      <div class="grid">
        <div><label>ENTRADA</label><input id="fEntrada" placeholder="DD/MM/AAAA HH:MM" value="${val(j.entrada?.ts)}"></div>
        <div><label>INÍCIO INTERVALO</label><input id="fSaiInt" placeholder="DD/MM/AAAA HH:MM" value="${val(j.saida_intervalo?.ts)}"></div>
        <div><label>FIM INTERVALO</label><input id="fRetInt" placeholder="DD/MM/AAAA HH:MM" value="${val(j.retorno_intervalo?.ts)}"></div>
        <div><label>SAÍDA</label><input id="fSaida" placeholder="DD/MM/AAAA HH:MM" value="${val(j.saida?.ts)}"></div>
        <div><label>ENTRADA HE</label><input id="fEntHe" placeholder="DD/MM/AAAA HH:MM" value="${val(j.entrada_he?.ts)}"></div>
        <div><label>SAÍDA HE</label><input id="fSaiHe" placeholder="DD/MM/AAAA HH:MM" value="${val(j.saida_he?.ts)}"></div>
      </div>
      <div class="small" style="margin-top:8px">Deixe em branco para remover o campo (apaga no banco).</div>
    `,
    onSave: async () => {
      const campos = [
        ["entrada.ts", document.getElementById("fEntrada").value],
        ["saida_intervalo.ts", document.getElementById("fSaiInt").value],
        ["retorno_intervalo.ts", document.getElementById("fRetInt").value],
        ["saida.ts", document.getElementById("fSaida").value],
        ["entrada_he.ts", document.getElementById("fEntHe").value],
        ["saida_he.ts", document.getElementById("fSaiHe").value],
      ];

      const payload = { updatedAt: new Date().toISOString() };

      for (const [path, txt] of campos){
        const t = (txt || "").trim();
        if (!t){ payload[path] = deleteField(); continue; }
        const iso = isoFromBrDateTime(t);
        if (!iso) return alert(`Formato inválido. Use DD/MM/AAAA HH:MM`);
        payload[path] = iso;
      }

      if (!confirm("Salvar alterações desta jornada?")) return;
      await updateDoc(doc(db,"jornadas",docId), payload);
      closeModal();
      buscar();
    }
  });
};

// ===== OCORRÊNCIAS / FÉRIAS / PLANTÕES
function ocDocId(re, ymd){ return `${re}_${ymd}`; }
function nomePorRe(re){
  const c = cacheColabs.find(x => (x.re || x.id) === re);
  return c?.nome || "";
}
async function apagarJornadasDoDia(re, dataYmd){
  const qJ = query(collection(db,"jornadas"), where("re","==",re));
  const snap = await getDocs(qJ);
  const all = snap.docs.map(d => ({ id:d.id, ...d.data() }));
  const doDia = all.filter(j => (j?.entrada?.ts || "").toString().slice(0,10) === dataYmd);
  for (const j of doDia) await deleteDoc(doc(db,"jornadas", j.id));
  return doDia.length;
}

window.salvarOcorrencia = async function(){
  try{
    const re = (document.getElementById("ocRe").value || "").trim();
    const data = document.getElementById("ocData").value;
    const tipo = document.getElementById("ocTipo").value;
    const motivo = (document.getElementById("ocMotivo").value || "").trim();

    if (!re) return alert("Informe o RE.");
    if (!data) return alert("Informe a data.");

    if (!confirm(`Salvar ocorrência?\nRE: ${re}\nData: ${brDateFromYmd(data)}\nTipo: ${tipo.toUpperCase()}\n\nIsso vai APAGAR registros do dia (se existirem).`)) return;

    await setDoc(doc(db,"ocorrencias", ocDocId(re, data)), {
      re, data, tipo, motivo,
      updatedAt: new Date().toISOString()
    }, { merge:true });

    const n = await apagarJornadasDoDia(re, data);
    alert(`Ocorrência salva.\nRegistros apagados do dia: ${n}`);

    document.getElementById("ocMotivo").value = "";
    document.getElementById("ocFiltroRe").value = re;
    document.getElementById("ocFiltroData").value = data;
    await carregarOcorrencias();
  }catch(e){
    console.error(e);
    alert("Falha ao salvar ocorrência.\n\nMotivo: " + (e?.message || e));
  }
};

window.carregarOcorrencias = async function(){
  try{
    const filtroRe = (document.getElementById("ocFiltroRe").value || "").trim();
    const filtroData = document.getElementById("ocFiltroData").value;

    const snap = await getDocs(collection(db,"ocorrencias"));
    let list = snap.docs.map(d => ({ id:d.id, ...(d.data()||{}) }));

    list = list.map(o => ({
      ...o,
      re: (o.re || "").toString().trim(),
      data: (o.data || "").toString().slice(0,10),
      tipo: (o.tipo || "").toString(),
      motivo: (o.motivo || "").toString(),
      updatedAt: (o.updatedAt || "")
    }));

    if (filtroRe) list = list.filter(o => o.re === filtroRe);
    if (filtroData) list = list.filter(o => o.data === filtroData);

    list.sort((a,b) =>
      (String(b.data||"")).localeCompare(String(a.data||"")) ||
      String(b.updatedAt||"").localeCompare(String(a.updatedAt||""))
    );

    cacheOcorr = list;

    const tbody = document.getElementById("tbodyOcorr");
    tbody.innerHTML = "";

    for (const o of cacheOcorr){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${brDateFromYmd(o.data||"")}</td>
        <td>${o.re || ""}</td>
        <td>${nomePorRe(o.re)}</td>
        <td>${(o.tipo||"").toUpperCase()}</td>
        <td>${o.motivo || ""}</td>
        <td>${brDateTimeFromIso(o.updatedAt)}</td>
        <td><button class="minBtn" onclick="editarOcorrencia('${o.id}')">Modificar</button></td>
      `;
      tbody.appendChild(tr);
    }
  }catch(e){
    console.error(e);
    alert("Falha ao carregar ocorrências.\n\nMotivo: " + (e?.message || e));
  }
};

window.editarOcorrencia = function(id){
  const o = cacheOcorr.find(x => x.id === id);
  if (!o) return alert("Ocorrência não encontrada.");

  openModal({
    title: `Modificar Ocorrência — ${o.re} — ${brDateFromYmd(o.data)}`,
    bodyHtml: `
      <div class="grid">
        <div><label>RE</label><input value="${o.re}" disabled></div>
        <div><label>Data</label><input value="${o.data}" disabled></div>
        <div>
          <label>Tipo</label>
          <select id="moTipo">
            <option value="falta" ${o.tipo==="falta" ? "selected" : ""}>FALTA</option>
            <option value="atestado" ${o.tipo==="atestado" ? "selected" : ""}>ATESTADO</option>
            <option value="abono" ${o.tipo==="abono" ? "selected" : ""}>ABONO</option>
          </select>
        </div>
        <div><label>Motivo</label><input id="moMotivo" value="${(o.motivo||"").replaceAll('"','&quot;')}"></div>
        <div class="small" style="grid-column:1 / -1">
          <button class="btnDangerInline" id="btnExcluirOcorr">Excluir ocorrência</button>
        </div>
      </div>
    `,
    onSave: async () => {
      const tipo = document.getElementById("moTipo").value;
      const motivo = (document.getElementById("moMotivo").value || "").trim();
      if (!confirm("Salvar alteração desta ocorrência?")) return;
      await updateDoc(doc(db,"ocorrencias", id), { tipo, motivo, updatedAt: new Date().toISOString() });
      closeModal();
      carregarOcorrencias();
    }
  });

  setTimeout(() => {
    const btn = document.getElementById("btnExcluirOcorr");
    if (!btn) return;
    btn.onclick = async () => {
      if (!confirm("Excluir esta ocorrência?")) return;
      await deleteDoc(doc(db,"ocorrencias", id));
      closeModal();
      carregarOcorrencias();
    };
  }, 0);
};

// ===== FÉRIAS
async function getColab(re){
  const ref = doc(db,"colaboradores", re);
  const snap = await getDoc(ref);
  if (!snap.exists()) return null;
  return { id:snap.id, ...(snap.data()||{}) };
}
function rangeDays(iniYmd, fimYmd){
  const out = [];
  const [y1,m1,d1] = iniYmd.split("-").map(Number);
  const [y2,m2,d2] = fimYmd.split("-").map(Number);
  let cur = new Date(y1, m1-1, d1, 12, 0, 0);
  const end = new Date(y2, m2-1, d2, 12, 0, 0);
  while (cur <= end){ out.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
  return out;
}
async function apagarJornadasNoPeriodo(re, iniYmd, fimYmd, escala, somenteDiasTrabalho, plantaoHistorico){
  const qJ = query(collection(db,"jornadas"), where("re","==",re));
  const snap = await getDocs(qJ);
  const all = snap.docs.map(d => ({ id:d.id, ...d.data() }));

  const days = rangeDays(iniYmd, fimYmd);
  const alvo = new Set();

  for (const dt of days){
    const dayKey = dt.toISOString().slice(0,10);
    if (somenteDiasTrabalho){
      if (!isDiaTrabalho(dt, escala, plantaoHistorico)) continue;
    }
    alvo.add(dayKey);
  }

  const apagar = all.filter(j => alvo.has((j?.entrada?.ts || "").toString().slice(0,10)));
  for (const j of apagar) await deleteDoc(doc(db,"jornadas", j.id));
  return apagar.length;
}

window.salvarFerias = async function(){
  const re = (document.getElementById("afRe").value || "").trim();
  const inicio = document.getElementById("afInicio").value;
  const fim = document.getElementById("afFim").value;
  const aplicarSomenteDiasTrabalho = document.getElementById("afDiasUteis").checked;
  const motivo = (document.getElementById("afMotivo").value || "").trim();

  if (!re) return alert("Informe o RE.");
  if (!inicio || !fim) return alert("Informe início e fim.");
  if (fim < inicio) return alert("Fim não pode ser menor que início.");

  const col = await getColab(re);
  if (!col) return alert("Colaborador não encontrado.");
  const escala = (col.escala || "5x2");
  const plantaoHistorico = Array.isArray(col.plantaoHistorico) ? col.plantaoHistorico : [];

  if (!confirm(
    `Salvar FÉRIAS?\nRE: ${re}\nNome: ${col.nome||""}\nPeríodo: ${brDateFromYmd(inicio)} até ${brDateFromYmd(fim)}\nSomente dias de trabalho: ${aplicarSomenteDiasTrabalho ? "SIM" : "NÃO"}\n\nIsso vai APAGAR jornadas dentro do período (conforme regra).`
  )) return;

  await addDoc(collection(db,"afastamentos"), {
    re, tipo:"ferias", inicio, fim,
    aplicarSomenteDiasTrabalho,
    motivo,
    createdAt:new Date().toISOString(),
    updatedAt:new Date().toISOString()
  });

  const apagadas = await apagarJornadasNoPeriodo(re, inicio, fim, escala, aplicarSomenteDiasTrabalho, plantaoHistorico);
  alert(`Férias salvas.\nJornadas apagadas no período: ${apagadas}`);
  document.getElementById("afMotivo").value="";
  carregarFerias();
};

window.carregarFerias = async function(){
  const snap = await getDocs(collection(db,"afastamentos"));
  cacheFerias = snap.docs.map(d => ({ id:d.id, ...(d.data()||{}) }))
    .filter(x => String(x.tipo||"").toLowerCase() === "ferias")
    .sort((a,b) => (String(b.inicio||"")).localeCompare(String(a.inicio||"")));

  const tbody = document.getElementById("tbodyFerias");
  tbody.innerHTML="";

  for (const f of cacheFerias){
    const col = cacheColabs.find(c => (c.re||c.id) === f.re) || null;
    const nome = col?.nome || "";
    const periodo = `${brDateFromYmd(String(f.inicio||"").slice(0,10))} até ${brDateFromYmd(String(f.fim||"").slice(0,10))}`;
    const du = (f.aplicarSomenteDiasTrabalho === true) ? "SIM" : "NÃO";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${f.re || ""}</td>
      <td>${nome}</td>
      <td>${periodo}</td>
      <td>${du}</td>
      <td>${(f.motivo||"")}</td>
      <td><button class="minBtn" onclick="editarFerias('${f.id}')">Modificar</button></td>
    `;
    tbody.appendChild(tr);
  }
};

window.editarFerias = function(id){
  const f = cacheFerias.find(x => x.id === id);
  if (!f) return alert("Férias não encontradas.");

  openModal({
    title: `Modificar Férias — RE ${f.re}`,
    bodyHtml: `
      <div class="grid">
        <div><label>RE</label><input value="${f.re||""}" disabled></div>
        <div><label>Tipo</label><input value="FÉRIAS" disabled></div>
        <div><label>Início</label><input id="mfInicio" type="date" value="${String(f.inicio||"").slice(0,10)}"></div>
        <div><label>Fim</label><input id="mfFim" type="date" value="${String(f.fim||"").slice(0,10)}"></div>
        <div style="grid-column:1 / -1">
          <label style="display:flex;align-items:center;gap:8px;">
            <input id="mfDiasUteis" type="checkbox" ${f.aplicarSomenteDiasTrabalho===true ? "checked" : ""}>
            Somente dias de trabalho
          </label>
        </div>
        <div style="grid-column:1 / -1">
          <label>Motivo</label>
          <input id="mfMotivo" value="${(f.motivo||"").toString().replaceAll('"','&quot;')}">
        </div>
        <div class="small" style="grid-column:1 / -1">
          <button class="btnDangerInline" id="btnExcluirFerias">Excluir período de férias</button>
        </div>
      </div>
    `,
    onSave: async () => {
      const ini = document.getElementById("mfInicio").value;
      const fim = document.getElementById("mfFim").value;
      const du = document.getElementById("mfDiasUteis").checked;
      const motivo = (document.getElementById("mfMotivo").value || "").trim();

      if (!ini || !fim) return alert("Informe início e fim.");
      if (fim < ini) return alert("Fim não pode ser menor que início.");
      if (!confirm("Salvar alteração do período de férias?")) return;

      await updateDoc(doc(db,"afastamentos", id), {
        inicio: ini, fim: fim, aplicarSomenteDiasTrabalho: du, motivo,
        updatedAt: new Date().toISOString()
      });

      closeModal();
      carregarFerias();
    }
  });

  setTimeout(() => {
    const btn = document.getElementById("btnExcluirFerias");
    if (!btn) return;
    btn.onclick = async () => {
      if (!confirm("Excluir este período de férias?")) return;
      await deleteDoc(doc(db,"afastamentos", id));
      closeModal();
      carregarFerias();
    };
  }, 0);
};

// ===== PLANTÕES 12x36
window.salvarPlantao12x36 = async function(){
  const re = (document.getElementById("plRe").value || "").trim();
  const vigencia = (document.getElementById("plVigencia").value || "").trim();
  const base = document.getElementById("plBase").value;
  const obs = (document.getElementById("plObs").value || "").trim();

  if (!re) return alert("Informe o RE.");
  if (!vigencia) return alert("Informe a data de vigência.");

  try{
    const colSnap = await getDoc(doc(db, "colaboradores", re));
    if (!colSnap.exists()) return alert("Colaborador não encontrado no banco. Cadastre na aba Colaboradores.");
    const col = colSnap.data() || {};

    const msg =
      `Salvar ajuste 12x36?\nRE: ${re}\nNome: ${col.nome||""}\nVigente a partir de: ${brDateFromYmd(vigencia)}\nBase: ${base.toUpperCase()}\n` +
      (obs ? `Obs: ${obs}\n` : "");

    if (!confirm(msg)) return;

    await addDoc(collection(db, "plantoes12x36"), { re, vigencia, base, obs, updatedAt: new Date().toISOString() });
    await syncPlantaoHistoricoToColaborador(re);

    document.getElementById("plObs").value = "";
    document.getElementById("plFiltroRe").value = re;

    alert("✅ Plantão 12x36 salvo e sincronizado no colaborador.");
    await carregarPlantoes12x36();
  }catch(e){
    console.error(e);
    alert("❌ Não foi possível salvar o plantão 12x36.\n\nMotivo: " + (e?.message || e));
  }
};

window.carregarPlantoes12x36 = async function(){
  try{
    const filtroRe = (document.getElementById("plFiltroRe")?.value || "").trim();
    const snap = await getDocs(collection(db, "plantoes12x36"));
    let list = snap.docs.map(d => ({ id:d.id, ...(d.data()||{}) }));

    list = list.map(x => ({
      ...x,
      re: (x.re||"").toString().trim(),
      vigencia: (x.vigencia||"").toString().slice(0,10),
      base: (x.base||"").toString(),
      obs: (x.obs||"").toString(),
      updatedAt: (x.updatedAt||"").toString()
    }));

    if (filtroRe) list = list.filter(x => x.re === filtroRe);

    list.sort((a,b) =>
      (String(b.vigencia||"")).localeCompare(String(a.vigencia||"")) ||
      (String(b.updatedAt||"")).localeCompare(String(a.updatedAt||""))
    );

    cachePlantoes = list;

    const tbody = document.getElementById("tbodyPlantoes");
    tbody.innerHTML = "";

    for (const p of cachePlantoes){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.re}</td>
        <td>${nomePorRe(p.re)}</td>
        <td>${brDateFromYmd(p.vigencia)}</td>
        <td>${(p.base||"").toUpperCase()}</td>
        <td>${p.obs || ""}</td>
        <td>${brDateTimeFromIso(p.updatedAt)}</td>
        <td><button class="minBtn" onclick="editarPlantao('${p.id}')">Modificar</button></td>
      `;
      tbody.appendChild(tr);
    }
  }catch(e){
    console.error(e);
    alert("❌ Falha ao carregar plantões 12x36.\n\nMotivo: " + (e?.message || e));
  }
};

window.editarPlantao = function(id){
  const p = cachePlantoes.find(x => x.id === id);
  if (!p) return alert("Plantão não encontrado.");

  openModal({
    title: `Modificar 12x36 — RE ${p.re}`,
    bodyHtml: `
      <div class="grid">
        <div><label>RE</label><input value="${p.re}" disabled></div>
        <div><label>Nome</label><input value="${nomePorRe(p.re)}" disabled></div>
        <div><label>Vigência (a partir)</label><input id="mpVigencia" type="date" value="${String(p.vigencia||"").slice(0,10)}"></div>
        <div>
          <label>Base</label>
          <select id="mpBase">
            <option value="trabalha" ${String(p.base)==="trabalha" ? "selected" : ""}>TRABALHA</option>
            <option value="folga" ${String(p.base)==="folga" ? "selected" : ""}>FOLGA</option>
          </select>
        </div>
        <div style="grid-column:1 / -1">
          <label>Obs</label>
          <input id="mpObs" value="${(p.obs||"").replaceAll('"','&quot;')}">
        </div>
        <div class="small" style="grid-column:1 / -1">
          <button class="btnDangerInline" id="btnExcluirPlantao">Excluir este registro</button>
        </div>
      </div>
    `,
    onSave: async () => {
      const vig = (document.getElementById("mpVigencia").value || "").trim();
      const base = document.getElementById("mpBase").value;
      const obs = (document.getElementById("mpObs").value || "").trim();
      if (!vig) return alert("Informe a vigência.");
      if (!confirm("Salvar alteração deste plantão 12x36?")) return;

      await updateDoc(doc(db, "plantoes12x36", id), { vigencia: vig, base, obs, updatedAt: new Date().toISOString() });
      await syncPlantaoHistoricoToColaborador(p.re);

      closeModal();
      carregarPlantoes12x36();
    }
  });

  setTimeout(() => {
    const btn = document.getElementById("btnExcluirPlantao");
    if (!btn) return;
    btn.onclick = async () => {
      if (!confirm("Excluir este registro de plantão 12x36?")) return;
      await deleteDoc(doc(db,"plantoes12x36", id));
      await syncPlantaoHistoricoToColaborador(p.re);
      closeModal();
      carregarPlantoes12x36();
    };
  }, 0);
};

// ===== export simples CSV
window.exportar = function(){
  let csv = "DataEntrada,Nome,RE,Entrada,InicioIntervalo,FimIntervalo,Saida,EntradaHE,SaidaHE,Coords,Local\n";
  for (const j of ultimaTabela){
    const loc = getBestLocationFromJornada(j);
    const rec = reconhecerLocal(loc);
    const linha = [
      formatBRDate(j.entrada?.ts),
      j.nome || "",
      j.re || "",
      formatHHMM(j.entrada?.ts),
      formatHHMM(j.saida_intervalo?.ts),
      formatHHMM(j.retorno_intervalo?.ts),
      formatHHMM(j.saida?.ts),
      formatHHMM(j.entrada_he?.ts),
      formatHHMM(j.saida_he?.ts),
      loc || "",
      rec || ""
    ].map(v => `"${String(v).replaceAll('"','""')}"`).join(",");
    csv += linha + "\n";
  }
  const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "jornadas.csv";
  a.click();
};

// ============================================
// ✅ EXPORTAÇÃO RH (XLSX) - SOMENTE ATIVOS
// ✅ HE separado de FT (folga trabalhada)
// ============================================
function setRhStatus(msg){
  const el = document.getElementById("rhStatus");
  if (el) el.textContent = msg || "";
}
function minutesToHHMM(min){
  const m = Math.max(0, Math.round(min||0));
  const hh = Math.floor(m/60);
  const mm = m%60;
  return `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}`;
}
function parseHHMMToMinutes(h){
  const m = (h||"").trim().match(/^([01]\d|2[0-3]):([0-5]\d)$/);
  if (!m) return null;
  return Number(m[1])*60 + Number(m[2]);
}
function diffMinutes(a,b){
  const da = toDateAny(a);
  const db = toDateAny(b);
  if (!da || !db || isNaN(da) || isNaN(db)) return 0;
  return Math.round((db - da)/60000);
}
function getPlannedMinutesForDay(col, dateObj){
  const dow = dateObj.getDay();
  const hs = col?.horariosSemana || {};
  const slot = hs?.[String(dow)];
  if (slot && slot.in && slot.out){
    const i = parseHHMMToMinutes(slot.in);
    const o = parseHHMMToMinutes(slot.out);
    if (i != null && o != null) return (o >= i) ? (o - i) : (o + 24*60 - i);
  }
  const he = parseHHMMToMinutes(col?.horaEntrada||"");
  const hs2= parseHHMMToMinutes(col?.horaSaida||"");
  if (he!=null && hs2!=null) return (hs2>=he) ? (hs2-he) : (hs2+24*60-he);
  return null;
}
function calcWorkedMinutesFromJornada(j){
  const ent = j?.entrada?.ts;
  const sai = j?.saida?.ts;
  if (!ent || !sai) return { worked:0, intervalo:0, virou:false };
  const dEnt = toDateAny(ent);
  const dSai = toDateAny(sai);
  const virou = (dEnt && dSai) ? (ymd(dEnt) !== ymd(dSai)) : false;

  let total = diffMinutes(ent, sai);
  let intervalo = 0;
  const si = j?.saida_intervalo?.ts;
  const ri = j?.retorno_intervalo?.ts;
  if (si && ri) intervalo = Math.max(0, diffMinutes(si, ri));
  total = Math.max(0, total - intervalo);
  return { worked: total, intervalo, virou };
}
function calcHeMinutesFromJornada(j){
  const ehEnt = j?.entrada_he?.ts;
  const ehSai = j?.saida_he?.ts;
  if (!ehEnt || !ehSai) return 0;
  return Math.max(0, diffMinutes(ehEnt, ehSai));
}
function monthDays(year, month1to12){
  const last = new Date(year, month1to12, 0).getDate();
  const out = [];
  for (let d=1; d<=last; d++) out.push(new Date(year, month1to12-1, d, 12, 0, 0));
  return out;
}
function findOcorrencia(re, ymdKey, ocorrenciasList){
  return ocorrenciasList.find(o => o.re===re && String(o.data||"").slice(0,10)===ymdKey) || null;
}
function findFerias(re, ymdKey, dateObj, col, feriasList){
  const escala = (col?.escala || "5x2");
  const plantaoHistorico = Array.isArray(col?.plantaoHistorico) ? col.plantaoHistorico : [];
  for (const f of feriasList){
    if (f.re !== re) continue;
    const ini = String(f.inicio||"").slice(0,10);
    const fim = String(f.fim||"").slice(0,10);
    if (!ini || !fim) continue;
    if (!(ymdKey >= ini && ymdKey <= fim)) continue;
    const onlyWork = (f.aplicarSomenteDiasTrabalho === true);
    if (onlyWork){
      if (!isDiaTrabalho(dateObj, escala, plantaoHistorico)) continue;
    }
    return f;
  }
  return null;
}
function isBeforeAdmissao(col, ymdKey){
  const ad = String(col?.dataAdmissao || "").slice(0,10);
  if (!/^\d{4}-\d{2}-\d{2}$/.test(ad)) return false;
  return ymdKey < ad;
}
function getScaleStatus(col, dateObj){
  const escala = (col?.escala || "5x2");
  const plantaoHistorico = Array.isArray(col?.plantaoHistorico) ? col.plantaoHistorico : [];
  const folga = isFolgaByEscala(dateObj, escala, plantaoHistorico);
  return folga ? "FOLGA" : "TRABALHA";
}
function getJornadaOfDay(re, ymdKey, jornadasList){
  return jornadasList.find(j => j.re===re && String(j?.entrada?.ts||"").slice(0,10)===ymdKey) || null;
}
function weekdayPtShort(d){ return d.toLocaleDateString("pt-BR", { weekday:"short" }); }
function safeStr(v){ return (v==null) ? "" : String(v); }
function formatDayBR(ymdKey){ return brDateFromYmd(ymdKey); }

window.exportarRHXLSX = async function(){
  try{
    setRhStatus("Carregando dados do Firestore...");

    const mes = Number(document.getElementById("rhMes").value);
    const ano = Number(document.getElementById("rhAno").value);
    const mes2 = pad2(mes);

    const [snapCol, snapJor, snapOco, snapAfa] = await Promise.all([
      getDocs(collection(db,"colaboradores")),
      getDocs(collection(db,"jornadas")),
      getDocs(collection(db,"ocorrencias")),
      getDocs(collection(db,"afastamentos"))
    ]);

    // ✅ SOMENTE ATIVOS (RÍGIDO)
    const colaboradores = snapCol.docs
      .map(d => ({ id:d.id, ...(d.data()||{}) }))
      .filter(c => c.ativo === true)
      .sort((a,b)=> (a.nome||"").localeCompare(b.nome||""));

    const jornadasAll = snapJor.docs.map(d => ({ id:d.id, ...(d.data()||{}) }));
    const ocorrAll = snapOco.docs.map(d => ({ id:d.id, ...(d.data()||{}) }));
    const feriasAll = snapAfa.docs.map(d => ({ id:d.id, ...(d.data()||{}) }))
      .filter(x => String(x.tipo||"").toLowerCase() === "ferias");

    const jornadasMes = jornadasAll.filter(j => {
      const ent = String(j?.entrada?.ts||"");
      if (!ent) return false;
      const d = toDateAny(ent);
      if (!d || isNaN(d)) return false;
      return d.getFullYear()===ano && (d.getMonth()+1)===mes;
    });

    setRhStatus("Calculando competência e montando XLSX...");

    const days = monthDays(ano, mes);

    const sheetResumo = [];
    const sheetDiario = [];
    const sheetEscala = [];

    // ✅ Resumo com HE e FT separados
    sheetResumo.push([
      "RE","Nome","CPF","Escala","Admissão",
      "Minutos Normais","Horas Normais",
      "Minutos HE","Horas HE",
      "Minutos FT","Horas FT",
      "Minutos Total","Horas Total",
      "Faltas","Atestados","Abonos","Férias","Folgas",
      "Dias Trabalhados","Dias Planejados Trabalhar"
    ]);

    // ✅ Diário: Normal / HE / FT separados
    sheetDiario.push([
      "RE","Nome","Data","Dia",
      "Escala (dia)","Planejado (HH:MM)","Status",
      "Entrada","Saída","Intervalo (min)","Trabalhado (min)",
      "Normal (min)","HE (min)","FT (min)","Total (min)",
      "Entrada HE","Saída HE","HE campo (min)",
      "Posto","Obs"
    ]);

    sheetEscala.push([
      "RE","Nome","Data","Dia","Escala","Status (TRABALHA/FOLGA)","Planejado (HH:MM)"
    ]);

    for (const col of colaboradores){
      const re = String(col.re || col.id || "").trim();
      if (!re) continue;

      const nome = safeStr(col.nome);
      const cpf = safeStr(col.cpf);
      const escala = safeStr(col.escala || "5x2");
      const adm = safeStr(col.dataAdmissao||"").slice(0,10);

      let sumNormal = 0, sumHE = 0, sumFT = 0, sumTotal = 0;
      let qtdFalta = 0, qtdAtestado = 0, qtdAbono = 0, qtdFerias = 0, qtdFolgas = 0;
      let diasTrabalhados = 0, diasPlanejadosTrabalhar = 0;

      for (const dt of days){
        const ymdKey = ymd(dt);
        const diaAntesAdm = isBeforeAdmissao(col, ymdKey);
        const escalaDia = getScaleStatus(col, dt);
        const planejadoMin = getPlannedMinutesForDay(col, dt);
        const planejadoTxt = (planejadoMin==null) ? "" : minutesToHHMM(planejadoMin);

        sheetEscala.push([
          re, nome,
          formatDayBR(ymdKey),
          weekdayPtShort(dt),
          escala,
          diaAntesAdm ? "NÃO ADMITIDO" : escalaDia,
          planejadoTxt
        ]);

        if (diaAntesAdm) continue;

        const isTrabalha = (escalaDia === "TRABALHA");
        if (isTrabalha) diasPlanejadosTrabalhar++;

        const fer = findFerias(re, ymdKey, dt, col, feriasAll);
        if (fer){
          qtdFerias++;
          sheetDiario.push([
            re,nome,formatDayBR(ymdKey),weekdayPtShort(dt),
            escalaDia, planejadoTxt, "FÉRIAS",
            "","","","",
            "","", "", "",
            "","","",
            "", safeStr(fer.motivo||"")
          ]);
          continue;
        }

        const oc = findOcorrencia(re, ymdKey, ocorrAll);
        if (oc){
          const t = String(oc.tipo||"").toLowerCase();
          if (t==="falta") qtdFalta++;
          if (t==="atestado") qtdAtestado++;
          if (t==="abono") qtdAbono++;
          sheetDiario.push([
            re,nome,formatDayBR(ymdKey),weekdayPtShort(dt),
            escalaDia, planejadoTxt, (t||"").toUpperCase(),
            "","","","",
            "","", "", "",
            "","","",
            "", safeStr(oc.motivo||"")
          ]);
          continue;
        }

        const j = getJornadaOfDay(re, ymdKey, jornadasMes);
        if (!j){
          if (!isTrabalha){
            qtdFolgas++;
            sheetDiario.push([
              re,nome,formatDayBR(ymdKey),weekdayPtShort(dt),
              escalaDia,planejadoTxt,"FOLGA",
              "","","","",
              "","", "", "",
              "","","",
              "", ""
            ]);
          } else {
            qtdFalta++;
            sheetDiario.push([
              re,nome,formatDayBR(ymdKey),weekdayPtShort(dt),
              escalaDia,planejadoTxt,"FALTA",
              "","","","",
              "","", "", "",
              "","","",
              "", ""
            ]);
          }
          continue;
        }

        const workedInfo = calcWorkedMinutesFromJornada(j);
        const heFieldMin = calcHeMinutesFromJornada(j);
        const worked = workedInfo.worked;
        const intervaloMin = workedInfo.intervalo;

        let normalMin = 0, heMin = 0, ftMin = 0;

        if (!isTrabalha){
          // ✅ Folga: tudo vira FT (inclusive campo HE)
          qtdFolgas++;
          ftMin = Math.max(0, worked + heFieldMin);
        } else {
          // ✅ Dia de trabalho: Normal + HE (o excedente + campo HE)
          if (planejadoMin == null){
            normalMin = worked;
            heMin = heFieldMin;
          } else {
            normalMin = Math.min(worked, planejadoMin);
            heMin = Math.max(0, worked - planejadoMin) + heFieldMin;
          }
        }

        const totalMin = normalMin + heMin + ftMin;

        sumNormal += normalMin;
        sumHE += heMin;
        sumFT += ftMin;
        sumTotal += totalMin;

        if (totalMin > 0) diasTrabalhados++;

        const posto = reconhecerLocal(getBestLocationFromJornada(j));
        const obs = [
          (workedInfo.virou ? "Virou o dia" : ""),
          (!j?.saida?.ts ? "Sem saída" : ""),
          ((j?.saida_intervalo?.ts && !j?.retorno_intervalo?.ts) || (!j?.saida_intervalo?.ts && j?.retorno_intervalo?.ts)) ? "Intervalo incompleto" : ""
        ].filter(Boolean).join(" | ");

        sheetDiario.push([
          re, nome,
          formatDayBR(ymdKey), weekdayPtShort(dt),
          escalaDia, planejadoTxt,
          (!isTrabalha ? "FT (FOLGA TRAB.)" : "TRABALHOU"),
          formatHHMM(j?.entrada?.ts),
          formatHHMM(j?.saida?.ts),
          intervaloMin,
          worked,
          normalMin,
          heMin,
          ftMin,
          totalMin,
          formatHHMM(j?.entrada_he?.ts),
          formatHHMM(j?.saida_he?.ts),
          heFieldMin,
          posto,
          obs
        ]);
      }

      sheetResumo.push([
        re, nome, cpf, escala,
        adm ? brDateFromYmd(adm) : "",
        sumNormal, minutesToHHMM(sumNormal),
        sumHE, minutesToHHMM(sumHE),
        sumFT, minutesToHHMM(sumFT),
        sumTotal, minutesToHHMM(sumTotal),
        qtdFalta, qtdAtestado, qtdAbono, qtdFerias, qtdFolgas,
        diasTrabalhados, diasPlanejadosTrabalhar
      ]);
    }

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheetResumo), "Resumo");
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheetDiario), "Diario");
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheetEscala), "Escala");

    const filename = `RH_${mes2}-${ano}.xlsx`;
    XLSX.writeFile(wb, filename);
    setRhStatus(`✅ Exportado com sucesso: ${filename}`);
  }catch(e){
    console.error(e);
    setRhStatus("❌ Falha ao exportar. Veja o console.");
    alert("Falha ao exportar RH (XLSX). Veja o console.");
  }
};
</script>
</body>
</html>
