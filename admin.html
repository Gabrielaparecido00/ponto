<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Admin</title>

<style>
body {
    font-family: Arial;
    background: #f5f5f5;
    text-align: center;
}

.container {
    background: white;
    padding: 20px;
    margin: 20px auto;
    max-width: 1000px;
    border-radius: 10px;
}

.logo {
    width: 260px;
    margin-bottom: 20px;
}

input, button {
    padding: 10px;
    margin: 5px;
}

button {
    cursor: pointer;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

th, td {
    border: 1px solid #ccc;
    padding: 8px;
}
</style>

</head>
<body>

<!-- LOGIN -->
<div id="loginDiv" class="container">
    <img src="GW.png" class="logo">
    <h2>Login Admin</h2>

    <input id="email" placeholder="Email"><br>
    <input id="senha" type="password" placeholder="Senha"><br>

    <button onclick="login()">Entrar</button>
</div>

<!-- PAINEL -->
<div id="painelDiv" class="container" style="display:none;">

    <img src="GW.png" class="logo">

    <h2>Painel de Ponto</h2>

    <label>De:</label>
    <input type="date" id="inicio">

    <label>At√©:</label>
    <input type="date" id="fim">

    <br>

    <button onclick="buscar()">Buscar</button>
    <button onclick="exportar()">Exportar Excel</button>
    <button onclick="logout()">Sair</button>

    <table>
        <thead>
            <tr>
                <th>Nome</th>
                <th>RE</th>
                <th>Entrada</th>
                <th>Sa√≠da Intervalo</th>
                <th>Retorno</th>
                <th>Sa√≠da Final</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

// üî• SUA CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyD--zpWLbLg5X82oGTyz6SuPFQV0sd7NWc",
  authDomain: "controle-ponto-f539b.firebaseapp.com",
  projectId: "controle-ponto-f539b",
  storageBucket: "controle-ponto-f539b.firebasestorage.app",
  messagingSenderId: "324716100257",
  appId: "1:324716100257:web:32d49a9ab4916182dd4ee0",
  measurementId: "G-P81H3C4SFK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const loginDiv = document.getElementById("loginDiv");
const painelDiv = document.getElementById("painelDiv");

// üîê LOGIN
window.login = async function() {

    const email = document.getElementById("email").value;
    const senha = document.getElementById("senha").value;

    try {
        await signInWithEmailAndPassword(auth, email, senha);
    } catch (err) {
        alert("Erro no login");
        console.error(err);
    }
};

// üîê LOGOUT
window.logout = function() {
    signOut(auth);
};

// üîê PROTE√á√ÉO
onAuthStateChanged(auth, user => {

    if (user) {
        loginDiv.style.display = "none";
        painelDiv.style.display = "block";
    } else {
        loginDiv.style.display = "block";
        painelDiv.style.display = "none";
    }
});

// üîç BUSCAR DADOS
window.buscar = async function() {

    let ini = document.getElementById("inicio").value;
    let fim = document.getElementById("fim").value;

    ini = ini ? new Date(ini) : new Date("2000-01-01");
    fim = fim ? new Date(fim) : new Date();

    fim.setHours(23,59,59,999);

    const snap = await getDocs(collection(db, "pontos"));

    let dados = [];

    snap.forEach(doc => {
        const d = doc.data();

        if (!d.timestamp) return;

        const t = new Date(d.timestamp);

        if (t >= ini && t <= fim) {
            dados.push(d);
        }
    });

    console.log("dados encontrados:", dados);

    montarTabela(dados);
};

// üìä ORGANIZAR REGISTROS
function montarTabela(dados) {

    const tbody = document.querySelector("tbody");
    tbody.innerHTML = "";

    const grupos = {};

    dados.forEach(d => {

        const chave = d.re + "_" + new Date(d.timestamp).toLocaleDateString();

        if (!grupos[chave]) grupos[chave] = [];

        grupos[chave].push(d);
    });

    for (const chave in grupos) {

        const registros = grupos[chave]
            .sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

        const linha = document.createElement("tr");

        linha.innerHTML = `
            <td>${registros[0]?.fullName || ""}</td>
            <td>${registros[0]?.re || ""}</td>
            <td>${formatar(registros[0])}</td>
            <td>${formatar(registros[1])}</td>
            <td>${formatar(registros[2])}</td>
            <td>${formatar(registros[3])}</td>
        `;

        tbody.appendChild(linha);
    }
}

// ‚è∞ FORMATAR DATA
function formatar(dado) {
    if (!dado) return "";
    return new Date(dado.timestamp).toLocaleString();
}

// üì• EXPORTAR CSV
window.exportar = function() {

    let csv = "Nome,RE,Entrada,Saida Intervalo,Retorno,Saida Final\n";

    document.querySelectorAll("tbody tr").forEach(tr => {

        const cols = tr.querySelectorAll("td");

        const linha = Array.from(cols)
            .map(td => `"${td.innerText}"`)
            .join(",");

        csv += linha + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "pontos.csv";
    a.click();
};

</script>

</body>
</html>
