<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Admin</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    *{ box-sizing:border-box; }

    :root{
      --bg:#0b1020;
      --panel:#0f172a;
      --card:#0b1220;
      --line:rgba(255,255,255,0.08);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --primary:#3b82f6;
      --primary2:#2563eb;
      --danger:#ef4444;
      --ok:#22c55e;
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
      --radius:14px;
    }

    body{
      font-family:'Montserrat', Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(59,130,246,0.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 10%, rgba(34,197,94,0.10), transparent 60%),
                  var(--bg);
      margin:0;
      padding:0; /* ✅ ocupa tela toda */
      color:var(--text);
    }

    /* ===== Login ===== */
    .loginWrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .loginCard{
      width:min(520px, 96vw);
      background: rgba(15,23,42,0.82);
      border:1px solid var(--line);
      backdrop-filter: blur(10px);
      padding:18px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align:center;
    }
    .logo{ width:220px; display:block; margin:0 auto 10px; max-width:90vw; height:auto; }

    h2{ margin:8px 0 10px; font-weight:800; letter-spacing:0.2px; }
    h3{ margin:10px 0 8px; font-weight:800; }

    input, select, button{
      font-family:inherit;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.10);
      outline:none;
      background: rgba(2,6,23,0.55);
      color: var(--text);
    }
    input::placeholder{ color: rgba(148,163,184,0.85); }
    button{ cursor:pointer; border:none; }
    button:hover{ filter:brightness(1.03); }
    button:disabled{ opacity:0.55; cursor:not-allowed; }

    .btnPrimary{ background: linear-gradient(180deg, var(--primary), var(--primary2)); color:#fff; }
    .btnGhost{ background: rgba(148,163,184,0.12); color: var(--text); border:1px solid rgba(255,255,255,0.10); }
    .btnDanger{ background: rgba(239,68,68,0.15); color:#fecaca; border:1px solid rgba(239,68,68,0.25); }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:flex-start;
      align-items:end;
      margin-top:10px;
    }

    .hr{ height:1px; background:var(--line); margin:16px 0; border:0; }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:14px;
      font-size:13px;
      overflow:hidden;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.08);
    }
    th, td{
      border-bottom:1px solid rgba(255,255,255,0.06);
      padding:10px;
      vertical-align:top;
    }
    th{
      background: rgba(2,6,23,0.45);
      text-align:center;
      color:#cbd5e1;
      font-weight:800;
    }
    td{ text-align:left; color:#e5e7eb; }
    tr:hover td{ background: rgba(59,130,246,0.06); }

    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      background: rgba(148,163,184,0.10);
      border:1px solid rgba(255,255,255,0.10);
      color:#e5e7eb;
      margin-right:6px;
    }

    /* ===== Painel: ocupa a tela toda ===== */
    .adminShell{
      width:100%;
      max-width:none; /* ✅ sem “apertar” */
      margin:0;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:12px;
      padding:12px;
      min-height:100vh;
    }

    .side{
      background: rgba(15,23,42,0.78);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      position:sticky;
      top:12px;
      height: calc(100vh - 24px);
      overflow:auto;
    }

    .side .brand{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    .side .brand img{
      width:44px; height:44px;
      border-radius:12px;
      object-fit:cover;
      border:1px solid rgba(255,255,255,0.10);
    }
    .side .brand .t{ font-weight:900; line-height:1.1; }
    .side .brand .s{ font-size:12px; color:var(--muted); margin-top:2px; }

    .nav{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:12px;
    }
    .nav button{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      background: rgba(2,6,23,0.35);
      border:1px solid rgba(255,255,255,0.08);
      color:#e5e7eb;
      text-align:left;
    }
    .nav button small{ color:var(--muted); font-weight:600; }
    .nav button.activeBtn{
      background: rgba(59,130,246,0.18);
      border:1px solid rgba(59,130,246,0.35);
    }

    .content{
      background: rgba(15,23,42,0.66);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      min-height: calc(100vh - 24px);
      overflow:auto;
    }

    .topBar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .topBar .hint{ color:var(--muted); font-size:12px; }

    .statusBar{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(2,6,23,0.35);
      color:#cbd5e1;
      font-size:12px;
      display:none;
    }
    .statusBar.ok{ border-color:rgba(34,197,94,0.25); background:rgba(34,197,94,0.12); }
    .statusBar.err{ border-color:rgba(239,68,68,0.25); background:rgba(239,68,68,0.12); }

    .section{ display:none; }
    .section.active{ display:block; }

    .minBtn{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(2,6,23,0.25);
      border-radius:12px;
      padding:7px 10px;
      font-size:12px;
      color:var(--text);
    }

    /* Modal */
    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:10px;
    }
    .modal{
      background: rgba(15,23,42,0.96);
      border:1px solid rgba(255,255,255,0.10);
      width:min(980px, 96vw);
      max-height:92vh;
      overflow:auto;
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
      color:var(--text);
    }
    .modal h3{ margin:0 0 10px; }
    .modal .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .modal label{ font-size:12px; color:var(--muted); }
    .modal input, .modal select{ width:100%; margin-top:4px; }
    .modal .actions{
      position:sticky;
      bottom:0;
      background: rgba(15,23,42,0.96);
      padding-top:10px;
      margin-top:10px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
      border-top:1px solid rgba(255,255,255,0.08);
    }

    @media (max-width: 980px){
      .adminShell{ grid-template-columns:1fr; }
      .side{ position:relative; height:auto; }
    }
    @media (max-width: 820px){
      table{ font-size:12px; }
      th, td{ padding:8px; }
      .modal .grid{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div id="loginDiv" class="loginWrap">
    <div class="loginCard">
      <img src="GW.png" class="logo" />
      <h2>Login Admin</h2>
      <input id="email" placeholder="Email" autocomplete="username"><br><br>
      <input id="senha" type="password" placeholder="Senha" autocomplete="current-password"><br><br>
      <button id="btnLogin" class="btnPrimary" onclick="login()" style="width:100%;">Entrar</button>
    </div>
  </div>

  <!-- PAINEL -->
  <div id="painelDiv" style="display:none;">
    <div class="adminShell">

      <!-- SIDEBAR -->
      <aside class="side">
        <div class="brand">
          <img src="GW.png" alt="Logo">
          <div>
            <div class="t">Painel Admin</div>
            <div class="s">RH</div>
          </div>
        </div>

        <div class="nav">
          <button id="btnJornadas" onclick="showSection('secJornadas', this)">
            <span>Jornadas</span><small>registros</small>
          </button>

          <button id="btnExportRH" onclick="showSection('secExportRH', this)">
            <span>Exportação RH</span><small>XLSX</small>
          </button>

          <button id="btnExportMassa" onclick="showSection('secExportMassa', this)">
            <span>Exportação em massa</span><small>PDF</small>
          </button>

          <button id="btnColab" onclick="showSection('secColab', this)">
            <span>Colaboradores</span><small>cadastro</small>
          </button>

          <button id="btnCargos" onclick="showSection('secCargos', this)">
            <span>Cargos</span><small>VR/VA</small>
          </button>

          <button id="btnLocal" onclick="showSection('secLocal', this)">
            <span>Locais</span><small>geofence</small>
          </button>

          <button id="btnOcorr" onclick="showSection('secOcorr', this)">
            <span>Ocorrências</span><small>dia</small>
          </button>

          <button id="btnAfast" onclick="showSection('secAfast', this)">
            <span>Férias</span><small>período</small>
          </button>

          <button id="btnAfastPeriodo" onclick="showSection('secAfastPeriodo', this)">
            <span>Afastamentos</span><small>período</small>
          </button>

          <button id="btnPlantoes" onclick="showSection('secPlantoes', this)">
            <span>Plantões 12x36</span><small>regras</small>
          </button>

          <button id="btnSup" onclick="showSection('secSup', this)">
            <span>Supervisores</span><small>FT</small>
          </button>

          <button class="btnDanger" onclick="logout()">
            <span>Sair</span><small>logout</small>
          </button>
        </div>
      </aside>

      <!-- CONTENT -->
      <main class="content">
        <div class="topBar">
          <div>
            <h2 style="margin:0;">Painel Admin</h2>
            <div class="hint"> </div>
          </div>
          <img src="GW.png" class="logo" style="width:160px;margin:0;opacity:0.95;" />
        </div>

        <div id="uiStatus" class="statusBar"></div>

        <hr class="hr">

        <!-- JORNADAS -->
        <div id="secJornadas" class="section active">
          <h3>Jornadas</h3>
          <div class="row">
            <label style="font-size:12px;color:var(--muted);">De:</label><input type="date" id="inicio">
            <label style="font-size:12px;color:var(--muted);">Até:</label><input type="date" id="fim">
            <input id="filtroRe" placeholder="RE" inputmode="numeric">
            <input id="filtroNome" placeholder="Nome">
            <button class="btnPrimary" onclick="buscar()">Buscar</button>
            <button class="btnGhost" onclick="exportar()">Exportar CSV</button>
            <button class="btnGhost" onclick="abrirCriarJornada()">+ Criar Jornada</button>
          </div>

          <table>
            <thead>
              <tr>
                <th>Data (Entrada)</th>
                <th>Nome</th>
                <th>RE</th>
                <th>Entrada</th>
                <th>Início Intervalo</th>
                <th>Fim Intervalo</th>
                <th>Saída</th>
                <th>Entrada HE</th>
                <th>Saída HE</th>
                <th>Coords</th>
                <th>Local</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyJornadas"></tbody>
          </table>

          <div style="margin-top:10px;">
            <span class="pill">FT</span>
            <span class="pill">HE</span>
          </div>
        </div>

        <!-- EXPORTAÇÃO RH -->
        <div id="secExportRH" class="section">
          <h3>Exportação RH</h3>
          <div class="row">
            <label style="font-size:12px;color:var(--muted);">Competência:</label>
            <select id="rhMes"></select>

            <label style="font-size:12px;color:var(--muted);">Ano:</label>
            <select id="rhAno"></select>

            <button class="btnPrimary" onclick="exportarRHXLSX()">Exportar RH (XLSX)</button>
          </div>
          <div id="rhStatus" style="margin-top:10px;color:var(--muted);font-size:12px;"></div>
        </div>

        <!-- EXPORTAÇÃO EM MASSA (PDF) -->
        <div id="secExportMassa" class="section">
          <h3>Exportação em massa (PDF)</h3>
          <div class="row">
            <label style="font-size:12px;color:var(--muted);">Competência:</label>
            <select id="pdfMes"></select>

            <label style="font-size:12px;color:var(--muted);">Ano:</label>
            <select id="pdfAno"></select>

            <button class="btnPrimary" onclick="exportarFolhasPDF_MASSA()">Gerar PDF</button>
            <button class="btnGhost" onclick="previewResumoMassa()">Prévia</button>
          </div>

          <div id="pdfStatus" style="margin-top:10px;color:var(--muted);font-size:12px;"></div>
        </div>

        <!-- COLABORADORES -->
        <div id="secColab" class="section">
          <h3>Colaboradores</h3>

          <div class="row">
            <input id="colabBuscaRe" placeholder="Buscar RE" inputmode="numeric">
            <input id="colabBuscaNome" placeholder="Buscar Nome">
            <button class="btnPrimary" onclick="aplicarFiltroColab()">Buscar</button>
            <button class="btnGhost" onclick="limparFiltroColab()">Limpar</button>
          </div>

          <div class="row">
            <input id="cadRe" placeholder="RE" inputmode="numeric">
            <input id="cadNome" placeholder="Nome completo">
            <input id="cadCpf" placeholder="CPF" inputmode="numeric">
            <select id="cadCargo"></select>

            <select id="cadEscala">
              <option value="5x2">5x2</option>
              <option value="6x1">6x1</option>
              <option value="12x36">12x36</option>
            </select>

            <input id="cadHoraEntrada" type="time" title="Hora prevista de entrada">
            <input id="cadHoraSaida" type="time" title="Hora prevista de saída">
            <input id="cadAdmissao" type="date" title="Data de admissão">

            <button class="btnPrimary" onclick="cadastrarColab()">Cadastrar</button>
            <button class="btnGhost" onclick="carregarColaboradores()">Atualizar</button>
          </div>

          <table>
            <thead>
              <tr>
                <th>RE</th>
                <th>Nome</th>
                <th>CPF</th>
                <th>Cargo</th>
                <th>Escala</th>
                <th>Horário</th>
                <th>Admissão</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyColab"></tbody>
          </table>
        </div>

        <!-- CARGOS -->
        <div id="secCargos" class="section">
          <h3>Cargos</h3>

          <div class="row">
            <input id="cgNome" placeholder="Nome do cargo">

            <!-- ✅ database agora é MÊS (select) -->
            <select id="cgMes"></select>

            <!-- ✅ VR/VA em R$ -->
            <input id="cgVR" placeholder="VR (R$)" inputmode="decimal">
            <input id="cgVA" placeholder="VA (R$)" inputmode="decimal">

            <button class="btnPrimary" onclick="cadastrarCargo()">Cadastrar</button>
            <button class="btnGhost" onclick="carregarCargos()">Atualizar</button>
          </div>

          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Mês</th>
                <th>VR</th>
                <th>VA</th>
                <th>Atualizado</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyCargos"></tbody>
          </table>
        </div>

        <!-- LOCAIS -->
        <div id="secLocal" class="section">
          <h3>Locais</h3>

          <div class="row">
            <input id="locNome" placeholder="Nome do posto">
            <input id="locLat" placeholder="Latitude">
            <input id="locLng" placeholder="Longitude">
            <input id="locRaio" placeholder="Raio (m)" inputmode="numeric">
            <button class="btnPrimary" onclick="cadastrarLocal()">Cadastrar</button>
            <button class="btnGhost" onclick="carregarLocais()">Atualizar</button>
          </div>

          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Latitude</th>
                <th>Longitude</th>
                <th>Raio (m)</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyLocais"></tbody>
          </table>
        </div>

        <!-- OCORRÊNCIAS -->
        <div id="secOcorr" class="section">
          <h3>Ocorrências</h3>

          <div class="row">
            <input id="ocRe" placeholder="RE" inputmode="numeric">
            <input id="ocData" type="date">
            <select id="ocTipo">
              <option value="falta">FALTA</option>
              <option value="atestado">ATESTADO</option>
              <option value="abono">ABONO</option>
            </select>
            <input id="ocMotivo" placeholder="Motivo (opcional)">
            <button class="btnPrimary" onclick="salvarOcorrencia()">Salvar</button>
          </div>

          <hr class="hr">

          <div class="row">
            <input id="ocFiltroRe" placeholder="Filtrar RE" inputmode="numeric">
            <input id="ocFiltroData" type="date">
            <button class="btnGhost" onclick="carregarOcorrencias()">Atualizar</button>
          </div>

          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>RE</th>
                <th>Nome</th>
                <th>Tipo</th>
                <th>Motivo</th>
                <th>Atualizado</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyOcorr"></tbody>
          </table>
        </div>

        <!-- FÉRIAS -->
        <div id="secAfast" class="section">
          <h3>Férias</h3>

          <div class="row">
            <input id="afRe" placeholder="RE" inputmode="numeric">
            <input id="afInicio" type="date">
            <input id="afFim" type="date">
            <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);">
              <input type="checkbox" id="afDiasUteis" checked> Somente dias de trabalho
            </label>
            <input id="afMotivo" placeholder="Motivo (opcional)">
            <button class="btnPrimary" onclick="salvarFerias()">Salvar</button>
            <button class="btnGhost" onclick="carregarFerias()">Atualizar</button>
          </div>

          <table>
            <thead>
              <tr>
                <th>RE</th>
                <th>Nome</th>
                <th>Período</th>
                <th>Dias trabalho?</th>
                <th>Motivo</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyFerias"></tbody>
          </table>
        </div>

        <!-- AFASTAMENTOS -->
        <div id="secAfastPeriodo" class="section">
          <h3>Afastamentos</h3>

          <div class="row">
            <input id="afpRe" placeholder="RE" inputmode="numeric">
            <input id="afpInicio" type="date">
            <input id="afpFim" type="date">

            <select id="afpMotivo">
              <option value="doenca">DOENÇA</option>
              <option value="licenca_maternidade">LICENÇA MATERNIDADE</option>
              <option value="licenca_amamentacao">LICENÇA AMAMENTAÇÃO</option>
            </select>

            <button class="btnPrimary" onclick="salvarAfastamentoPeriodo()">Salvar</button>
            <button class="btnGhost" onclick="carregarAfastamentosPeriodo()">Atualizar</button>
          </div>

          <table>
            <thead>
              <tr>
                <th>RE</th>
                <th>Nome</th>
                <th>Período</th>
                <th>Motivo</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyAfastPeriodo"></tbody>
          </table>
        </div>

        <!-- PLANTÕES -->
        <div id="secPlantoes" class="section">
          <h3>Plantões 12x36</h3>

          <div class="row">
            <input id="plRe" placeholder="RE" inputmode="numeric">
            <input id="plVigencia" type="date">
            <select id="plBase">
              <option value="trabalha">TRABALHA</option>
              <option value="folga">FOLGA</option>
            </select>
            <input id="plObs" placeholder="Obs (opcional)">
            <button class="btnPrimary" onclick="salvarPlantao12x36()">Salvar</button>
          </div>

          <hr class="hr">

          <div class="row">
            <input id="plFiltroRe" placeholder="Filtrar RE" inputmode="numeric">
            <button class="btnGhost" onclick="carregarPlantoes12x36()">Atualizar</button>
          </div>

          <table>
            <thead>
              <tr>
                <th>RE</th>
                <th>Nome</th>
                <th>Vigência</th>
                <th>Base</th>
                <th>Obs</th>
                <th>Atualizado</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyPlantoes"></tbody>
          </table>
        </div>

        <!-- SUPERVISORES -->
        <div id="secSup" class="section">
          <h3>Supervisores</h3>

          <div class="row">
            <input id="supNome" placeholder="Nome do supervisor">
            <button class="btnPrimary" onclick="cadastrarSupervisor()">Cadastrar</button>
            <button class="btnGhost" onclick="carregarSupervisores()">Atualizar</button>
          </div>

          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Atualizado</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbodySup"></tbody>
          </table>
        </div>

      </main>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modalOverlay" class="modalOverlay" onclick="closeModalIfBackdrop(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <h3 id="modalTitle">Editar</h3>
      <div id="modalBody"></div>
      <div class="actions">
        <button class="btnGhost" onclick="closeModal()">Cancelar</button>
        <button id="modalSaveBtn" class="btnPrimary">Salvar</button>
      </div>
    </div>
  </div>

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase COMPAT (global) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    /* ========= FIREBASE CONFIG ========= */
    const firebaseConfig = {
      apiKey: "AIzaSyD--zpWLbLg5X82oGTyz6SuPFQV0sd7NWc",
      authDomain: "controle-ponto-f539b.firebaseapp.com",
      projectId: "controle-ponto-f539b",
      storageBucket: "controle-ponto-f539b.appspot.com",
      messagingSenderId: "324716100257",
      appId: "1:324716100257:web:32d49a9ab4916182dd4ee0",
      measurementId: "G-P81H3C4SFK"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginDiv = document.getElementById("loginDiv");
    const painelDiv = document.getElementById("painelDiv");

    let cacheLocais = [];
    let cacheColabs = [];
    let cacheFerias = [];
    let cacheOcorr = [];
    let cachePlantoes = [];
    let cacheSupervisores = [];
    let cacheCargos = [];

    let colabFiltroRe = "";
    let colabFiltroNome = "";

    /* ========= UI STATUS ========= */
    function setUiStatus(msg, kind){
      const el = document.getElementById("uiStatus");
      if (!el) return;
      if (!msg){
        el.style.display="none";
        el.textContent="";
        el.classList.remove("ok","err");
        return;
      }
      el.style.display="block";
      el.textContent = msg;
      el.classList.remove("ok","err");
      if (kind==="ok") el.classList.add("ok");
      if (kind==="err") el.classList.add("err");
    }

    /* ========= MENU ========= */
    function showSection(id, btnEl){
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      const sec = document.getElementById(id);
      if (sec) sec.classList.add("active");

      document.querySelectorAll(".nav button").forEach(b => b.classList.remove("activeBtn"));
      if (btnEl) btnEl.classList.add("activeBtn");

      setUiStatus("");

      if (id === "secLocal") carregarLocais();
      if (id === "secColab") carregarColaboradores();
      if (id === "secCargos") carregarCargos();
      if (id === "secAfast") { carregarColaboradores().then(carregarFerias); }
      if (id === "secOcorr") { carregarColaboradores().then(carregarOcorrencias); }
      if (id === "secPlantoes") { carregarColaboradores().then(carregarPlantoes12x36); }
      if (id === "secSup") { carregarSupervisores(); }
      if (id === "secAfastPeriodo") { carregarColaboradores().then(carregarAfastamentosPeriodo); }

      if (id === "secExportMassa"){
        initPdfSelectors();
        carregarColaboradores();
      }
    }
    window.showSection = showSection;

    /* ========= AUTH ========= */
    function login(){
      const btn = document.getElementById("btnLogin");
      btn.disabled = true;
      btn.innerText = "Entrando...";

      const email = (document.getElementById("email").value || "").trim();
      const senha = (document.getElementById("senha").value || "").trim();

      if(!email || !senha){
        alert("Informe email e senha.");
        btn.disabled = false;
        btn.innerText = "Entrar";
        return;
      }

      auth.signInWithEmailAndPassword(email, senha)
        .catch(function(e){
          console.error("LOGIN ERRO:", e);
          alert("Email ou senha inválidos.");
        })
        .finally(function(){
          btn.disabled = false;
          btn.innerText = "Entrar";
        });
    }
    window.login = login;

    function logout(){ auth.signOut(); }
    window.logout = logout;

    auth.onAuthStateChanged(async function(user){
      if(user){
        try{ await user.getIdToken(true); }catch(e){}

        loginDiv.style.display = "none";
        painelDiv.style.display = "block";

        const b = document.getElementById("btnJornadas");
        if (b) b.classList.add("activeBtn");

        // carrega o mínimo para o painel não “parecer vazio”
        carregarCargos().catch(()=>{});
        carregarLocais().catch(()=>{});
        carregarColaboradores().catch(()=>{});
        carregarSupervisores().catch(()=>{});
      }else{
        loginDiv.style.display = "flex";
        painelDiv.style.display = "none";
      }
    });

    /* ========= HELPERS ========= */
    function pad2(n){ return String(n).padStart(2,"0"); }
    function toDateAny(ts){
      if (!ts) return null;
      if (ts.toDate) return ts.toDate();
      if (ts instanceof Date) return ts;
      return new Date(ts);
    }
    function ymd(d){
      if (!d || isNaN(d)) return "";
      return d.toISOString().slice(0,10);
    }
    function brDateFromYmd(ymdStr){
      if (!ymdStr) return "";
      const p = String(ymdStr).slice(0,10).split("-");
      if (p.length!==3) return ymdStr;
      return `${p[2]}/${p[1]}/${p[0]}`;
    }
    function brDateTimeFromIso(ts){
      const d = toDateAny(ts);
      if (!d || isNaN(d)) return "";
      const data = d.toLocaleDateString("pt-BR");
      const hora = d.toLocaleTimeString("pt-BR", {hour:"2-digit", minute:"2-digit"});
      return `${data} ${hora}`;
    }
    function formatHHMM(ts){
      const d = toDateAny(ts);
      if (!d || isNaN(d)) return "";
      return d.toLocaleTimeString("pt-BR", { hour:"2-digit", minute:"2-digit" });
    }
    function horarioTxt(c){
      const he = (c && c.horaEntrada ? String(c.horaEntrada).trim() : "");
      const hs = (c && c.horaSaida ? String(c.horaSaida).trim() : "");
      if (he && hs) return `${he}–${hs}`;
      if (he || hs) return `${he||"—"}–${hs||"—"}`;
      return "—";
    }

    /* ========= Dinheiro (R$) ========= */
    function moneyToNumberBR(str){
      const s = String(str||"").replace(/[^\d,.-]/g,"").trim();
      if (!s) return 0;
      // aceita "1.234,56" ou "1234,56"
      const norm = s.replace(/\./g,"").replace(",",".");
      const n = Number(norm);
      return Number.isFinite(n) ? n : 0;
    }
    function formatMoneyBR(n){
      const v = Number(n||0);
      return v.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
    }
    function maskCurrencyBR(inputEl){
      // mantém só dígitos
      const digits = String(inputEl.value||"").replace(/\D/g,"");
      if (!digits){
        inputEl.value = "";
        return;
      }
      const cents = Number(digits);
      const value = cents / 100;
      inputEl.value = value.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
    }

    /* ========= Meses (database) ========= */
    const MESES = [
      { v:"janeiro", t:"Janeiro" },
      { v:"fevereiro", t:"Fevereiro" },
      { v:"marco", t:"Março" },
      { v:"abril", t:"Abril" },
      { v:"maio", t:"Maio" },
      { v:"junho", t:"Junho" },
      { v:"julho", t:"Julho" },
      { v:"agosto", t:"Agosto" },
      { v:"setembro", t:"Setembro" },
      { v:"outubro", t:"Outubro" },
      { v:"novembro", t:"Novembro" },
      { v:"dezembro", t:"Dezembro" }
    ];
    function initMesCargoSelect(){
      const sel = document.getElementById("cgMes");
      if (!sel) return;
      sel.innerHTML = MESES.map(m => `<option value="${m.v}">${m.t}</option>`).join("");
      // default no mês atual
      const now = new Date();
      sel.value = MESES[now.getMonth()].v;
    }
    initMesCargoSelect();

    // aplica máscara no input de VR/VA
    const cgVR = document.getElementById("cgVR");
    const cgVA = document.getElementById("cgVA");
    if (cgVR) cgVR.addEventListener("input", ()=>maskCurrencyBR(cgVR));
    if (cgVA) cgVA.addEventListener("input", ()=>maskCurrencyBR(cgVA));

    /* ========= CARGOS ========= */
    function fillCargoSelects(){
      const sel1 = document.getElementById("cadCargo");
      if (!sel1) return;

      const cur = sel1.value;
      sel1.innerHTML = `<option value="">(Sem cargo)</option>` + cacheCargos.map(c =>
        `<option value="${c.id}">${c.nome}</option>`
      ).join("");
      if (cur) sel1.value = cur;
    }
    function cargoNomeById(id){
      const c = cacheCargos.find(x => x.id === id);
      return c ? c.nome : "";
    }

    function carregarCargos(){
      setUiStatus("Carregando cargos...");
      return db.collection("cargos").get()
        .then(function(snap){
          cacheCargos = snap.docs.map(function(d){
            const data = d.data() || {};
            return {
              id: d.id,
              nome: String(data.nome||"").trim(),
              mes: String(data.mes||data.database||"").trim(), // compat: se tinha database antes
              vr: Number(data.vr||0),
              va: Number(data.va||0),
              updatedAt: String(data.updatedAt||"")
            };
          })
          .filter(c => !!c.nome)
          .sort((a,b)=>a.nome.localeCompare(b.nome));

          const tbody = document.getElementById("tbodyCargos");
          if (tbody){
            tbody.innerHTML = "";
            cacheCargos.forEach(c=>{
              const mesTxt = (MESES.find(m=>m.v===c.mes)?.t) || (c.mes||"");
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${c.nome}</td>
                <td>${mesTxt}</td>
                <td>${formatMoneyBR(c.vr)}</td>
                <td>${formatMoneyBR(c.va)}</td>
                <td>${brDateTimeFromIso(c.updatedAt)}</td>
                <td><button class="minBtn" onclick="editarCargo('${c.id}')">Modificar</button></td>
              `;
              tbody.appendChild(tr);
            });
          }

          fillCargoSelects();
          setUiStatus("✅ Cargos carregados.", "ok");
        })
        .catch(function(e){
          console.error("carregarCargos ERRO:", e);
          setUiStatus("❌ Falha ao carregar cargos (ver console).", "err");
          alert("Não foi possível carregar cargos.");
        });
    }
    window.carregarCargos = carregarCargos;

    function cadastrarCargo(){
      const nome = (document.getElementById("cgNome").value || "").trim();
      const mes  = (document.getElementById("cgMes").value || "").trim();
      const vr   = moneyToNumberBR(document.getElementById("cgVR").value);
      const va   = moneyToNumberBR(document.getElementById("cgVA").value);

      if (!nome){ alert("Informe o nome do cargo."); return; }
      if (!mes){ alert("Selecione o mês."); return; }

      db.collection("cargos").add({
        nome,
        mes,         // ✅ substitui database
        vr, va,      // ✅ números
        updatedAt: new Date().toISOString()
      })
      .then(function(){
        document.getElementById("cgNome").value="";
        document.getElementById("cgVR").value="";
        document.getElementById("cgVA").value="";
        initMesCargoSelect();
        return carregarCargos();
      })
      .catch(function(e){
        console.error("cadastrarCargo ERRO:", e);
        alert("Não foi possível cadastrar cargo.");
      });
    }
    window.cadastrarCargo = cadastrarCargo;

    /* ========= MODAL ========= */
    const overlay=document.getElementById("modalOverlay");
    const titleEl=document.getElementById("modalTitle");
    const bodyEl=document.getElementById("modalBody");
    const saveBtn=document.getElementById("modalSaveBtn");

    function closeModal(){ overlay.style.display="none"; bodyEl.innerHTML=""; saveBtn.onclick=null; }
    function closeModalIfBackdrop(e){ if (e.target===overlay) closeModal(); }

    window.closeModal = closeModal;
    window.closeModalIfBackdrop = closeModalIfBackdrop;

    function openModal(obj){
      titleEl.innerText = obj.title || "Editar";
      bodyEl.innerHTML = obj.bodyHtml || "";
      overlay.style.display="flex";
      saveBtn.onclick = obj.onSave || null;
    }

    function editarCargo(id){
      const c = cacheCargos.find(x=>x.id===id);
      if (!c){ alert("Cargo não encontrado."); return; }

      const mesOptions = MESES.map(m => `<option value="${m.v}" ${m.v===c.mes?'selected':''}>${m.t}</option>`).join("");

      openModal({
        title: "Modificar Cargo",
        bodyHtml: `
          <div class="grid">
            <div style="grid-column:1 / -1">
              <label>Nome</label>
              <input id="mcgNome" value="${String(c.nome||"").replaceAll('"','&quot;')}">
            </div>

            <div style="grid-column:1 / -1">
              <label>Mês</label>
              <select id="mcgMes">${mesOptions}</select>
            </div>

            <div>
              <label>VR</label>
              <input id="mcgVr" value="${formatMoneyBR(c.vr)}">
            </div>
            <div>
              <label>VA</label>
              <input id="mcgVa" value="${formatMoneyBR(c.va)}">
            </div>

            <div style="grid-column:1 / -1; display:flex; justify-content:flex-start;">
              <button class="btnDanger" id="btnExcluirCargo" type="button">Excluir</button>
            </div>
          </div>
        `,
        onSave: function(){
          const nome = (document.getElementById("mcgNome").value || "").trim();
          const mes  = (document.getElementById("mcgMes").value || "").trim();
          const vr   = moneyToNumberBR(document.getElementById("mcgVr").value);
          const va   = moneyToNumberBR(document.getElementById("mcgVa").value);

          if (!nome){ alert("Nome não pode ficar vazio."); return; }
          if (!mes){ alert("Selecione o mês."); return; }

          db.collection("cargos").doc(id).update({
            nome, mes, vr, va, updatedAt:new Date().toISOString()
          })
          .then(function(){
            closeModal();
            carregarCargos();
            carregarColaboradores();
          })
          .catch(function(e){
            console.error("editarCargo ERRO:", e);
            alert("Não foi possível salvar cargo.");
          });
        }
      });

      setTimeout(function(){
        const vrEl = document.getElementById("mcgVr");
        const vaEl = document.getElementById("mcgVa");
        if (vrEl) vrEl.addEventListener("input", ()=>maskCurrencyBR(vrEl));
        if (vaEl) vaEl.addEventListener("input", ()=>maskCurrencyBR(vaEl));

        const btn = document.getElementById("btnExcluirCargo");
        if (btn){
          btn.onclick = function(){
            if (!confirm("Excluir este cargo?")) return;
            db.collection("cargos").doc(id).delete()
              .then(function(){ closeModal(); carregarCargos(); })
              .catch(function(e){ console.error("excluirCargo ERRO:", e); alert("Não foi possível excluir cargo."); });
          };
        }
      }, 0);
    }
    window.editarCargo = editarCargo;

    /* ========= COLABORADORES ========= */
    function aplicarFiltroColab(){
      colabFiltroRe = (document.getElementById("colabBuscaRe").value||"").trim();
      colabFiltroNome = (document.getElementById("colabBuscaNome").value||"").trim().toLowerCase();
      renderColaboradores();
    }
    window.aplicarFiltroColab = aplicarFiltroColab;

    function limparFiltroColab(){
      document.getElementById("colabBuscaRe").value = "";
      document.getElementById("colabBuscaNome").value = "";
      colabFiltroRe = "";
      colabFiltroNome = "";
      renderColaboradores();
    }
    window.limparFiltroColab = limparFiltroColab;

    function carregarColaboradores(){
      setUiStatus("Carregando colaboradores...");
      return db.collection("colaboradores").get()
        .then(function(snap){
          cacheColabs = snap.docs.map(d => ({ id:d.id, ...(d.data()||{}) }))
            .map(c => ({
              re: String(c.re || c.id || "").trim(),
              nome: String(c.nome||"").trim(),
              cpf: String(c.cpf||"").trim(),
              cargoId: String(c.cargoId||"").trim(),
              escala: String(c.escala||"5x2").trim(),
              horaEntrada: String(c.horaEntrada||"").trim(),
              horaSaida: String(c.horaSaida||"").trim(),
              admissao: String(c.admissao||"").slice(0,10),
              ativo: (c.ativo !== false),
              updatedAt: String(c.updatedAt||"")
            }))
            .filter(c => !!c.re)
            .sort((a,b)=>String(a.nome||"").localeCompare(String(b.nome||"")));

          fillCargoSelects();
          renderColaboradores();
          setUiStatus("✅ Colaboradores carregados.", "ok");
        })
        .catch(function(e){
          console.error("carregarColaboradores ERRO:", e);
          setUiStatus("❌ Falha ao carregar colaboradores (ver console).", "err");
          alert("Não foi possível carregar colaboradores.");
        });
    }
    window.carregarColaboradores = carregarColaboradores;

    function renderColaboradores(){
      const tbody = document.getElementById("tbodyColab");
      if (!tbody) return;

      let list = [...cacheColabs];

      if (colabFiltroRe){
        list = list.filter(c => c.re === colabFiltroRe);
      }
      if (colabFiltroNome){
        list = list.filter(c => (c.nome||"").toLowerCase().includes(colabFiltroNome));
      }

      tbody.innerHTML = "";
      list.forEach(c=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.re}</td>
          <td>${c.nome}</td>
          <td>${c.cpf}</td>
          <td>${cargoNomeById(c.cargoId) || "—"}</td>
          <td>${c.escala || "—"}</td>
          <td>${horarioTxt(c)}</td>
          <td>${brDateFromYmd(c.admissao)}</td>
          <td>${c.ativo ? "ATIVO" : "INATIVO"}</td>
          <td><button class="minBtn" onclick="editarColab('${c.re}')">Modificar</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function cadastrarColab(){
      const re = (document.getElementById("cadRe").value || "").trim();
      const nome = (document.getElementById("cadNome").value || "").trim();
      const cpf = (document.getElementById("cadCpf").value || "").trim();
      const cargoId = (document.getElementById("cadCargo").value || "").trim();
      const escala = (document.getElementById("cadEscala").value || "5x2").trim();
      const horaEntrada = (document.getElementById("cadHoraEntrada").value || "").trim();
      const horaSaida = (document.getElementById("cadHoraSaida").value || "").trim();
      const admissao = (document.getElementById("cadAdmissao").value || "").trim();

      if (!re){ alert("Informe o RE."); return; }
      if (!nome){ alert("Informe o nome."); return; }
      if (!cpf){ alert("Informe o CPF."); return; }

      db.collection("colaboradores").doc(re).set({
        re, nome, cpf,
        cargoId,
        escala,
        horaEntrada, horaSaida,
        admissao: admissao || null,
        ativo: true,
        updatedAt: new Date().toISOString()
      }, { merge:true })
      .then(function(){
        document.getElementById("cadRe").value="";
        document.getElementById("cadNome").value="";
        document.getElementById("cadCpf").value="";
        document.getElementById("cadCargo").value="";
        document.getElementById("cadEscala").value="5x2";
        document.getElementById("cadHoraEntrada").value="";
        document.getElementById("cadHoraSaida").value="";
        document.getElementById("cadAdmissao").value="";
        return carregarColaboradores();
      })
      .catch(function(e){
        console.error("cadastrarColab ERRO:", e);
        alert("Não foi possível cadastrar colaborador.");
      });
    }
    window.cadastrarColab = cadastrarColab;

    function editarColab(re){
      const c = cacheColabs.find(x => x.re === re);
      if (!c){ alert("Colaborador não encontrado."); return; }

      const cargosOpt = `<option value="">(Sem cargo)</option>` + cacheCargos.map(k =>
        `<option value="${k.id}" ${k.id===c.cargoId?'selected':''}>${k.nome}</option>`
      ).join("");

      openModal({
        title: "Modificar Colaborador",
        bodyHtml: `
          <div class="grid">
            <div>
              <label>RE</label>
              <input value="${String(c.re).replaceAll('"','&quot;')}" disabled>
            </div>
            <div>
              <label>Status</label>
              <select id="mAtivo">
                <option value="true" ${c.ativo?'selected':''}>ATIVO</option>
                <option value="false" ${!c.ativo?'selected':''}>INATIVO</option>
              </select>
            </div>

            <div style="grid-column:1 / -1">
              <label>Nome</label>
              <input id="mNome" value="${String(c.nome||"").replaceAll('"','&quot;')}">
            </div>

            <div>
              <label>CPF</label>
              <input id="mCpf" value="${String(c.cpf||"").replaceAll('"','&quot;')}">
            </div>

            <div>
              <label>Cargo</label>
              <select id="mCargo">${cargosOpt}</select>
            </div>

            <div>
              <label>Escala</label>
              <select id="mEscala">
                <option value="5x2" ${c.escala==='5x2'?'selected':''}>5x2</option>
                <option value="6x1" ${c.escala==='6x1'?'selected':''}>6x1</option>
                <option value="12x36" ${String(c.escala).includes('12')?'selected':''}>12x36</option>
              </select>
            </div>

            <div>
              <label>Hora entrada</label>
              <input id="mHE" type="time" value="${c.horaEntrada||""}">
            </div>

            <div>
              <label>Hora saída</label>
              <input id="mHS" type="time" value="${c.horaSaida||""}">
            </div>

            <div style="grid-column:1 / -1">
              <label>Admissão</label>
              <input id="mAdm" type="date" value="${(c.admissao||"").slice(0,10)}">
            </div>
          </div>
        `,
        onSave: function(){
          const nome = (document.getElementById("mNome").value||"").trim();
          const cpf = (document.getElementById("mCpf").value||"").trim();
          const cargoId = (document.getElementById("mCargo").value||"").trim();
          const escala = (document.getElementById("mEscala").value||"5x2").trim();
          const horaEntrada = (document.getElementById("mHE").value||"").trim();
          const horaSaida = (document.getElementById("mHS").value||"").trim();
          const admissao = (document.getElementById("mAdm").value||"").trim();
          const ativo = (document.getElementById("mAtivo").value === "true");

          if (!nome){ alert("Informe o nome."); return; }
          if (!cpf){ alert("Informe o CPF."); return; }

          db.collection("colaboradores").doc(re).update({
            nome, cpf, cargoId, escala, horaEntrada, horaSaida,
            admissao: admissao || null,
            ativo,
            updatedAt: new Date().toISOString()
          })
          .then(function(){
            closeModal();
            carregarColaboradores();
          })
          .catch(function(e){
            console.error("editarColab ERRO:", e);
            alert("Não foi possível salvar.");
          });
        }
      });
    }
    window.editarColab = editarColab;

    /* ========= LOCAIS ========= */
    function carregarLocais(){
      setUiStatus("Carregando locais...");
      return db.collection("locais").get()
        .then(snap=>{
          cacheLocais = snap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }))
            .map(l=>({
              id:l.id,
              nome:String(l.nome||"").trim(),
              lat:String(l.lat||l.latitude||"").trim(),
              lng:String(l.lng||l.longitude||"").trim(),
              raio:Number(l.raio||l.margem||0)
            }))
            .filter(x=>x.nome);

          const tbody = document.getElementById("tbodyLocais");
          if (tbody){
            tbody.innerHTML="";
            cacheLocais.forEach(l=>{
              const tr=document.createElement("tr");
              tr.innerHTML=`
                <td>${l.nome}</td>
                <td>${l.lat}</td>
                <td>${l.lng}</td>
                <td>${l.raio||0}</td>
                <td><button class="minBtn" onclick="excluirLocal('${l.id}')">Excluir</button></td>
              `;
              tbody.appendChild(tr);
            });
          }
          setUiStatus("✅ Locais carregados.", "ok");
        })
        .catch(e=>{
          console.error("carregarLocais ERRO:", e);
          setUiStatus("❌ Falha ao carregar locais.", "err");
        });
    }
    window.carregarLocais = carregarLocais;

    function cadastrarLocal(){
      const nome=(document.getElementById("locNome").value||"").trim();
      const lat=(document.getElementById("locLat").value||"").trim();
      const lng=(document.getElementById("locLng").value||"").trim();
      const raio=Number((document.getElementById("locRaio").value||"").trim()||0);

      if(!nome||!lat||!lng||!raio){ alert("Preencha nome, latitude, longitude e raio."); return; }

      db.collection("locais").add({ nome, lat, lng, raio, updatedAt:new Date().toISOString() })
        .then(()=>{
          document.getElementById("locNome").value="";
          document.getElementById("locLat").value="";
          document.getElementById("locLng").value="";
          document.getElementById("locRaio").value="";
          carregarLocais();
        })
        .catch(e=>{
          console.error("cadastrarLocal ERRO:", e);
          alert("Não foi possível cadastrar local.");
        });
    }
    window.cadastrarLocal = cadastrarLocal;

    function excluirLocal(id){
      if(!confirm("Excluir este local?")) return;
      db.collection("locais").doc(id).delete()
        .then(()=>carregarLocais())
        .catch(e=>{
          console.error("excluirLocal ERRO:", e);
          alert("Não foi possível excluir.");
        });
    }
    window.excluirLocal = excluirLocal;

    /* ========= SUPERVISORES ========= */
    function carregarSupervisores(){
      return db.collection("supervisores").get()
        .then(snap=>{
          cacheSupervisores = snap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }))
            .map(s=>({ id:s.id, nome:String(s.nome||"").trim(), updatedAt:String(s.updatedAt||"") }))
            .filter(s=>s.nome)
            .sort((a,b)=>a.nome.localeCompare(b.nome));

          const tbody=document.getElementById("tbodySup");
          if(tbody){
            tbody.innerHTML="";
            cacheSupervisores.forEach(s=>{
              const tr=document.createElement("tr");
              tr.innerHTML=`
                <td>${s.nome}</td>
                <td>${brDateTimeFromIso(s.updatedAt)}</td>
                <td><button class="minBtn" onclick="excluirSupervisor('${s.id}')">Excluir</button></td>
              `;
              tbody.appendChild(tr);
            });
          }
        })
        .catch(e=>console.error("carregarSupervisores ERRO:", e));
    }
    window.carregarSupervisores = carregarSupervisores;

    function cadastrarSupervisor(){
      const nome=(document.getElementById("supNome").value||"").trim();
      if(!nome){ alert("Informe o nome."); return; }
      db.collection("supervisores").add({ nome, updatedAt:new Date().toISOString() })
        .then(()=>{
          document.getElementById("supNome").value="";
          carregarSupervisores();
        })
        .catch(e=>{
          console.error("cadastrarSupervisor ERRO:", e);
          alert("Não foi possível cadastrar.");
        });
    }
    window.cadastrarSupervisor = cadastrarSupervisor;

    function excluirSupervisor(id){
      if(!confirm("Excluir?")) return;
      db.collection("supervisores").doc(id).delete()
        .then(()=>carregarSupervisores())
        .catch(e=>alert("Não foi possível excluir."));
    }
    window.excluirSupervisor = excluirSupervisor;

    /* ========= OCORRÊNCIAS ========= */
    function salvarOcorrencia(){
      const re=(document.getElementById("ocRe").value||"").trim();
      const data=(document.getElementById("ocData").value||"").trim();
      const tipo=(document.getElementById("ocTipo").value||"falta").trim();
      const motivo=(document.getElementById("ocMotivo").value||"").trim();

      if(!re||!data){ alert("Informe RE e data."); return; }
      const col = cacheColabs.find(c=>c.re===re);
      const nome = col ? col.nome : "";

      db.collection("ocorrencias").add({
        re, nome, data,
        tipo, motivo,
        updatedAt:new Date().toISOString()
      })
      .then(()=>{
        document.getElementById("ocMotivo").value="";
        carregarOcorrencias();
      })
      .catch(e=>{
        console.error("salvarOcorrencia ERRO:", e);
        alert("Não foi possível salvar.");
      });
    }
    window.salvarOcorrencia = salvarOcorrencia;

    function carregarOcorrencias(){
      return db.collection("ocorrencias").get()
        .then(snap=>{
          cacheOcorr = snap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }))
            .map(o=>({
              id:o.id,
              re:String(o.re||"").trim(),
              nome:String(o.nome||"").trim(),
              data:String(o.data||"").slice(0,10),
              tipo:String(o.tipo||"").trim(),
              motivo:String(o.motivo||"").trim(),
              updatedAt:String(o.updatedAt||"")
            }))
            .filter(o=>o.re && o.data)
            .sort((a,b)=> (a.data===b.data ? a.re.localeCompare(b.re) : b.data.localeCompare(a.data)));

          const fRe=(document.getElementById("ocFiltroRe").value||"").trim();
          const fDt=(document.getElementById("ocFiltroData").value||"").trim();

          let list=[...cacheOcorr];
          if(fRe) list=list.filter(x=>x.re===fRe);
          if(fDt) list=list.filter(x=>x.data===fDt);

          const tbody=document.getElementById("tbodyOcorr");
          if(tbody){
            tbody.innerHTML="";
            list.forEach(o=>{
              const tr=document.createElement("tr");
              tr.innerHTML=`
                <td>${brDateFromYmd(o.data)}</td>
                <td>${o.re}</td>
                <td>${o.nome}</td>
                <td>${String(o.tipo||"").toUpperCase()}</td>
                <td>${o.motivo||""}</td>
                <td>${brDateTimeFromIso(o.updatedAt)}</td>
                <td><button class="minBtn" onclick="excluirOcorrencia('${o.id}')">Excluir</button></td>
              `;
              tbody.appendChild(tr);
            });
          }
        })
        .catch(e=>console.error("carregarOcorrencias ERRO:", e));
    }
    window.carregarOcorrencias = carregarOcorrencias;

    function excluirOcorrencia(id){
      if(!confirm("Excluir?")) return;
      db.collection("ocorrencias").doc(id).delete()
        .then(()=>carregarOcorrencias())
        .catch(e=>alert("Não foi possível excluir."));
    }
    window.excluirOcorrencia = excluirOcorrencia;

    /* ========= FÉRIAS (afastamentos tipo=ferias) ========= */
    function salvarFerias(){
      const re=(document.getElementById("afRe").value||"").trim();
      const inicio=(document.getElementById("afInicio").value||"").trim();
      const fim=(document.getElementById("afFim").value||"").trim();
      const aplicarSomenteDiasTrabalho = !!document.getElementById("afDiasUteis").checked;
      const motivo=(document.getElementById("afMotivo").value||"").trim();

      if(!re||!inicio||!fim){ alert("Informe RE, início e fim."); return; }
      const col = cacheColabs.find(c=>c.re===re);
      const nome = col ? col.nome : "";

      db.collection("afastamentos").add({
        tipo:"ferias",
        re, nome,
        inicio, fim,
        aplicarSomenteDiasTrabalho,
        motivo,
        updatedAt:new Date().toISOString()
      })
      .then(()=>{
        document.getElementById("afMotivo").value="";
        carregarFerias();
      })
      .catch(e=>{
        console.error("salvarFerias ERRO:", e);
        alert("Não foi possível salvar férias.");
      });
    }
    window.salvarFerias = salvarFerias;

    function carregarFerias(){
      return db.collection("afastamentos").get()
        .then(snap=>{
          cacheFerias = snap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }))
            .filter(x=>String(x.tipo||"").toLowerCase()==="ferias")
            .map(f=>({
              id:f.id,
              re:String(f.re||"").trim(),
              nome:String(f.nome||"").trim(),
              inicio:String(f.inicio||"").slice(0,10),
              fim:String(f.fim||"").slice(0,10),
              aplicarSomenteDiasTrabalho: f.aplicarSomenteDiasTrabalho===true,
              motivo:String(f.motivo||"").trim()
            }))
            .sort((a,b)=> (a.inicio===b.inicio ? a.re.localeCompare(b.re) : b.inicio.localeCompare(a.inicio)));

          const tbody=document.getElementById("tbodyFerias");
          if(tbody){
            tbody.innerHTML="";
            cacheFerias.forEach(f=>{
              const tr=document.createElement("tr");
              tr.innerHTML=`
                <td>${f.re}</td>
                <td>${f.nome}</td>
                <td>${brDateFromYmd(f.inicio)} — ${brDateFromYmd(f.fim)}</td>
                <td>${f.aplicarSomenteDiasTrabalho ? "SIM" : "NÃO"}</td>
                <td>${f.motivo||""}</td>
                <td><button class="minBtn" onclick="excluirFerias('${f.id}')">Excluir</button></td>
              `;
              tbody.appendChild(tr);
            });
          }
        })
        .catch(e=>console.error("carregarFerias ERRO:", e));
    }
    window.carregarFerias = carregarFerias;

    function excluirFerias(id){
      if(!confirm("Excluir?")) return;
      db.collection("afastamentos").doc(id).delete()
        .then(()=>carregarFerias())
        .catch(e=>alert("Não foi possível excluir."));
    }
    window.excluirFerias = excluirFerias;

    /* ========= AFASTAMENTOS (período) ========= */
    function salvarAfastamentoPeriodo(){
      const re=(document.getElementById("afpRe").value||"").trim();
      const inicio=(document.getElementById("afpInicio").value||"").trim();
      const fim=(document.getElementById("afpFim").value||"").trim();
      const motivo=(document.getElementById("afpMotivo").value||"doenca").trim();

      if(!re||!inicio||!fim){ alert("Informe RE, início e fim."); return; }
      const col = cacheColabs.find(c=>c.re===re);
      const nome = col ? col.nome : "";

      db.collection("afastamentos").add({
        tipo:"afastamento_periodo",
        re, nome,
        inicio, fim,
        motivo,
        updatedAt:new Date().toISOString()
      })
      .then(()=>carregarAfastamentosPeriodo())
      .catch(e=>alert("Não foi possível salvar."));
    }
    window.salvarAfastamentoPeriodo = salvarAfastamentoPeriodo;

    function carregarAfastamentosPeriodo(){
      return db.collection("afastamentos").get()
        .then(snap=>{
          const list = snap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }))
            .filter(x=>String(x.tipo||"").toLowerCase()==="afastamento_periodo")
            .map(a=>({
              id:a.id,
              re:String(a.re||"").trim(),
              nome:String(a.nome||"").trim(),
              inicio:String(a.inicio||"").slice(0,10),
              fim:String(a.fim||"").slice(0,10),
              motivo:String(a.motivo||"").trim()
            }))
            .sort((a,b)=>b.inicio.localeCompare(a.inicio));

          const tbody=document.getElementById("tbodyAfastPeriodo");
          if(tbody){
            tbody.innerHTML="";
            list.forEach(a=>{
              const tr=document.createElement("tr");
              tr.innerHTML=`
                <td>${a.re}</td>
                <td>${a.nome}</td>
                <td>${brDateFromYmd(a.inicio)} — ${brDateFromYmd(a.fim)}</td>
                <td>${a.motivo}</td>
                <td><button class="minBtn" onclick="excluirAfastPeriodo('${a.id}')">Excluir</button></td>
              `;
              tbody.appendChild(tr);
            });
          }
        })
        .catch(e=>console.error("carregarAfastamentosPeriodo ERRO:", e));
    }
    window.carregarAfastamentosPeriodo = carregarAfastamentosPeriodo;

    function excluirAfastPeriodo(id){
      if(!confirm("Excluir?")) return;
      db.collection("afastamentos").doc(id).delete()
        .then(()=>carregarAfastamentosPeriodo())
        .catch(e=>alert("Não foi possível excluir."));
    }
    window.excluirAfastPeriodo = excluirAfastPeriodo;

    /* ========= PLANTÕES 12x36 ========= */
    function salvarPlantao12x36(){
      const re=(document.getElementById("plRe").value||"").trim();
      const vigencia=(document.getElementById("plVigencia").value||"").trim();
      const base=(document.getElementById("plBase").value||"trabalha").trim();
      const obs=(document.getElementById("plObs").value||"").trim();
      if(!re||!vigencia){ alert("Informe RE e vigência."); return; }

      const col = cacheColabs.find(c=>c.re===re);
      const nome = col ? col.nome : "";

      db.collection("plantoes12x36").add({
        re, nome,
        inicio: vigencia,
        base, obs,
        updatedAt:new Date().toISOString()
      })
      .then(()=>carregarPlantoes12x36())
      .catch(e=>alert("Não foi possível salvar."));
    }
    window.salvarPlantao12x36 = salvarPlantao12x36;

    function carregarPlantoes12x36(){
      return db.collection("plantoes12x36").get()
        .then(snap=>{
          cachePlantoes = snap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }))
            .map(p=>({
              id:p.id,
              re:String(p.re||"").trim(),
              nome:String(p.nome||"").trim(),
              inicio:String(p.inicio||"").slice(0,10),
              base:String(p.base||"").trim(),
              obs:String(p.obs||"").trim(),
              updatedAt:String(p.updatedAt||"")
            }))
            .filter(p=>p.re && p.inicio)
            .sort((a,b)=>b.inicio.localeCompare(a.inicio));

          const fRe=(document.getElementById("plFiltroRe").value||"").trim();
          let list=[...cachePlantoes];
          if(fRe) list=list.filter(x=>x.re===fRe);

          const tbody=document.getElementById("tbodyPlantoes");
          if(tbody){
            tbody.innerHTML="";
            list.forEach(p=>{
              const tr=document.createElement("tr");
              tr.innerHTML=`
                <td>${p.re}</td>
                <td>${p.nome}</td>
                <td>${brDateFromYmd(p.inicio)}</td>
                <td>${p.base.toUpperCase()}</td>
                <td>${p.obs||""}</td>
                <td>${brDateTimeFromIso(p.updatedAt)}</td>
                <td><button class="minBtn" onclick="excluirPlantao('${p.id}')">Excluir</button></td>
              `;
              tbody.appendChild(tr);
            });
          }
        })
        .catch(e=>console.error("carregarPlantoes12x36 ERRO:", e));
    }
    window.carregarPlantoes12x36 = carregarPlantoes12x36;

    function excluirPlantao(id){
      if(!confirm("Excluir?")) return;
      db.collection("plantoes12x36").doc(id).delete()
        .then(()=>carregarPlantoes12x36())
        .catch(e=>alert("Não foi possível excluir."));
    }
    window.excluirPlantao = excluirPlantao;

    /* ========= RH SELECTS ========= */
    function initRhSelectors(){
      const mesSel = document.getElementById("rhMes");
      const anoSel = document.getElementById("rhAno");
      if (!mesSel || !anoSel) return;

      const now = new Date();
      const y = now.getFullYear();

      mesSel.innerHTML = "";
      for (let m=1; m<=12; m++){
        const opt=document.createElement("option");
        opt.value=String(m);
        opt.textContent=pad2(m);
        if (m === (now.getMonth()+1)) opt.selected=true;
        mesSel.appendChild(opt);
      }

      anoSel.innerHTML = "";
      for (let yy=y-3; yy<=y+1; yy++){
        const opt=document.createElement("option");
        opt.value=String(yy);
        opt.textContent=String(yy);
        if (yy===y) opt.selected=true;
        anoSel.appendChild(opt);
      }
    }
    initRhSelectors();

    function initPdfSelectors(){
      const mesSel = document.getElementById("pdfMes");
      const anoSel = document.getElementById("pdfAno");
      if (!mesSel || !anoSel) return;

      const now = new Date();
      const y = now.getFullYear();

      mesSel.innerHTML = "";
      for (let m=1; m<=12; m++){
        const opt=document.createElement("option");
        opt.value=String(m);
        opt.textContent=pad2(m);
        if (m === (now.getMonth()+1)) opt.selected=true;
        mesSel.appendChild(opt);
      }

      anoSel.innerHTML = "";
      for (let yy=y-3; yy<=y+1; yy++){
        const opt=document.createElement("option");
        opt.value=String(yy);
        opt.textContent=String(yy);
        if (yy===y) opt.selected=true;
        anoSel.appendChild(opt);
      }
    }
    initPdfSelectors();

    /* ========= STUBS (mantém botões funcionando sem quebrar) ========= */
    function buscar(){ setUiStatus("Busca de jornadas: implemente/cole sua lógica aqui.", "err"); }
    function exportar(){ alert("Exportar CSV: implemente/cole sua lógica aqui."); }
    function abrirCriarJornada(){ alert("Criar Jornada: cole sua versão aqui (a sua anterior)."); }
    function exportarRHXLSX(){ alert("Exportar RH XLSX: cole sua versão aqui."); }
    function exportarFolhasPDF_MASSA(){ alert("Exportação em massa: cole sua versão aqui."); }
    function previewResumoMassa(){ alert("Prévia: cole sua versão aqui."); }

    window.buscar = buscar;
    window.exportar = exportar;
    window.abrirCriarJornada = abrirCriarJornada;
    window.exportarRHXLSX = exportarRHXLSX;
    window.exportarFolhasPDF_MASSA = exportarFolhasPDF_MASSA;
    window.previewResumoMassa = previewResumoMassa;

  </script>
</body>
</html>
