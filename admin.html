<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel Admin</title>

<style>

body{
  font-family: Arial;
  background:#f5f5f5;
  margin:0;
  padding:20px;
}

.container{
  background:#fff;
  padding:20px;
  border-radius:10px;
  max-width:1200px;
  margin:auto;
}

.logo{
  width:220px;
  display:block;
  margin:auto;
}

h2{
  text-align:center;
}

.row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:10px;
}

input, select, button{
  padding:10px;
}

button{
  cursor:pointer;
  border:none;
  border-radius:8px;
  background:#1f6feb;
  color:white;
}

table{
  width:100%;
  border-collapse:collapse;
}

th, td{
  border:1px solid #ccc;
  padding:8px;
}

th{
  background:#eee;
}

.minBtn{
  background:#6c757d;
}

.modalOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  display:none;
  justify-content:center;
  align-items:center;
}

.modal{
  background:white;
  padding:20px;
  border-radius:10px;
  width:600px;
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

</style>
</head>
<body>

<div class="container">

<img src="GW.png" class="logo">

<h2>Painel Admin</h2>

<div class="row">

<input id="cadRe" placeholder="RE">
<input id="cadNome" placeholder="Nome">

<select id="cadEscala">
<option value="5x2">5x2</option>
<option value="6x1">6x1</option>
<option value="12x36">12x36</option>
</select>

<input type="date" id="cadAdmissao">

<input type="date" id="cadInicioPlantao">

<input type="time" id="cadHoraEntrada">
<input type="time" id="cadHoraSaida">

<button onclick="cadastrar()">Cadastrar</button>

</div>

<table>

<thead>

<tr>

<th>RE</th>
<th>Nome</th>
<th>Escala</th>
<th>Admissão</th>
<th>Plantão atual</th>
<th>Ações</th>

</tr>

</thead>

<tbody id="tbody"></tbody>

</table>

</div>

<div class="modalOverlay" id="modalOverlay">

<div class="modal">

<h3>Modificar colaborador</h3>

<div id="modalBody"></div>

<br>

<button onclick="salvarModal()">Salvar</button>
<button onclick="fecharModal()">Cancelar</button>

</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

import {

getFirestore,
doc,
setDoc,
getDocs,
getDoc,
collection

} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {

apiKey:"AIzaSy...",
authDomain:"controle-ponto-f539b.firebaseapp.com",
projectId:"controle-ponto-f539b"

};

const app = initializeApp(firebaseConfig);

const db = getFirestore(app);

let editandoId = null;

let cacheColabs = [];

function hojeIso(){

return new Date().toISOString().slice(0,10);

}

function getPlantaoAtual(col){

if(!col.plantaoHistorico || !col.plantaoHistorico.length) return "-";

return col.plantaoHistorico[col.plantaoHistorico.length-1].inicio;

}

window.cadastrar = async function(){

const re = cadRe.value.trim();

const nome = cadNome.value.trim();

const escala = cadEscala.value;

const admissao = cadAdmissao.value;

const inicioPlantao = cadInicioPlantao.value;

const horaEntrada = cadHoraEntrada.value;

const horaSaida = cadHoraSaida.value;

if(!re || !nome) return;

let historico = [];

if(escala==="12x36" && inicioPlantao){

historico.push({

inicio:inicioPlantao,

createdAt:new Date().toISOString()

});

}

await setDoc(doc(db,"colaboradores",re),{

re,
nome,
escala,
dataAdmissao:admissao,
horaEntrada,
horaSaida,
plantaoHistorico:historico,
createdAt:new Date().toISOString()

},{merge:true});

carregar();

}

async function carregar(){

const snap = await getDocs(collection(db,"colaboradores"));

cacheColabs = snap.docs.map(d=>({

id:d.id,

...d.data()

}));

render();

}

function render(){

tbody.innerHTML="";

for(const c of cacheColabs){

const tr=document.createElement("tr");

tr.innerHTML=`

<td>${c.re}</td>
<td>${c.nome}</td>
<td>${c.escala}</td>
<td>${c.dataAdmissao||""}</td>
<td>${getPlantaoAtual(c)}</td>
<td>

<button class="minBtn" onclick="abrirModal('${c.id}')">

Modificar

</button>

</td>

`;

tbody.appendChild(tr);

}

}

window.abrirModal = function(id){

editandoId=id;

const c = cacheColabs.find(x=>x.id===id);

modalBody.innerHTML=`

<div class="grid">

<div>

<label>Nome</label>

<input id="mNome" value="${c.nome}">

</div>

<div>

<label>Escala</label>

<select id="mEscala">

<option value="5x2">5x2</option>
<option value="6x1">6x1</option>
<option value="12x36">12x36</option>

</select>

</div>

<div>

<label>Data admissão</label>

<input type="date" id="mAdmissao" value="${c.dataAdmissao||""}">

</div>

<div>

<label>Novo início plantão</label>

<input type="date" id="mInicioPlantao">

</div>

<div>

<label>Hora entrada</label>

<input type="time" id="mHoraEntrada" value="${c.horaEntrada||""}">

</div>

<div>

<label>Hora saída</label>

<input type="time" id="mHoraSaida" value="${c.horaSaida||""}">

</div>

</div>

`;

modalOverlay.style.display="flex";

}

window.fecharModal=function(){

modalOverlay.style.display="none";

}

window.salvarModal=async function(){

const nome=mNome.value;

const escala=mEscala.value;

const admissao=mAdmissao.value;

const inicioPlantao=mInicioPlantao.value;

const horaEntrada=mHoraEntrada.value;

const horaSaida=mHoraSaida.value;

const ref = doc(db,"colaboradores",editandoId);

const snap = await getDoc(ref);

let historico=[];

if(snap.exists()){

historico=snap.data().plantaoHistorico||[];

}

if(escala==="12x36" && inicioPlantao){

historico.push({

inicio:inicioPlantao,

createdAt:new Date().toISOString()

});

}

await setDoc(ref,{

nome,
escala,
dataAdmissao:admissao,
horaEntrada,
horaSaida,
plantaoHistorico:historico,
updatedAt:new Date().toISOString()

},{merge:true});

fecharModal();

carregar();

}

carregar();

</script>

</body>
</html>
