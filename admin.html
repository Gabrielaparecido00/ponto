<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Admin</title>

<style>
body {
    font-family: Arial;
    background: #f5f5f5;
    text-align: center;
}

.container {
    background: white;
    padding: 20px;
    margin: 20px auto;
    max-width: 1100px;
    border-radius: 10px;
}

.logo {
    width: 260px;
    margin-bottom: 20px;
}

input, button {
    padding: 10px;
    margin: 5px;
}

button {
    cursor: pointer;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 13px;
}

th, td {
    border: 1px solid #ccc;
    padding: 8px;
}

.filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    align-items: center;
    margin-top: 10px;
}

.filters input {
    width: 180px;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginDiv" class="container">
    <img src="GW.png" class="logo">
    <h2>Login Admin</h2>

    <input id="email" placeholder="Email"><br>
    <input id="senha" type="password" placeholder="Senha"><br>

    <button onclick="login()">Entrar</button>
</div>

<!-- PAINEL -->
<div id="painelDiv" class="container" style="display:none;">
    <img src="GW.png" class="logo">

    <h2>Painel de Ponto</h2>

    <div class="filters">
        <label>De:</label>
        <input type="date" id="inicio">

        <label>At√©:</label>
        <input type="date" id="fim">

        <label>RE:</label>
        <input type="text" id="filtroRe" placeholder="(opcional)">

        <label>Nome:</label>
        <input type="text" id="filtroNome" placeholder="(opcional)">

        <button onclick="buscar()">Buscar</button>
        <button onclick="exportar()">Exportar CSV</button>
        <button onclick="logout()">Sair</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>Data</th>
                <th>Nome</th>
                <th>RE</th>
                <th>Entrada</th>
                <th>Sa√≠da Intervalo</th>
                <th>Retorno Intervalo</th>
                <th>Sa√≠da</th>
                <th>Entrada HE</th>
                <th>Sa√≠da HE</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

// üî• SUA CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyD--zpWLbLg5X82oGTyz6SuPFQV0sd7NWc",
  authDomain: "controle-ponto-f539b.firebaseapp.com",
  projectId: "controle-ponto-f539b",
  storageBucket: "controle-ponto-f539b.firebasestorage.app",
  messagingSenderId: "324716100257",
  appId: "1:324716100257:web:32d49a9ab4916182dd4ee0",
  measurementId: "G-P81H3C4SFK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const loginDiv = document.getElementById("loginDiv");
const painelDiv = document.getElementById("painelDiv");

// üîê LOGIN
window.login = async function() {
    const email = document.getElementById("email").value;
    const senha = document.getElementById("senha").value;

    try {
        await signInWithEmailAndPassword(auth, email, senha);
    } catch (err) {
        alert("Erro no login");
        console.error(err);
    }
};

// üîê LOGOUT
window.logout = function() {
    signOut(auth);
};

// üîê PROTE√á√ÉO
onAuthStateChanged(auth, user => {
    loginDiv.style.display = user ? "none" : "block";
    painelDiv.style.display = user ? "block" : "none";
});

// helpers
function norm(s) {
    return (s || "").toString().trim().toLowerCase();
}

// Converte timestamp (ISO/string/Date/Timestamp do Firestore) para Date
function toDateAny(ts) {
    if (!ts) return null;
    if (ts.toDate) return ts.toDate();           // Firestore Timestamp
    if (ts instanceof Date) return ts;           // Date
    return new Date(ts);                         // ISO string
}

// ‚úÖ BUSCAR DADOS (SEM INDEX) ‚Äî filtra por "data" (YYYY-MM-DD)
window.buscar = async function() {

    const iniStr = document.getElementById("inicio").value || "2000-01-01";
    const fimStr = document.getElementById("fim").value || "2999-12-31";

    const filtroRe = norm(document.getElementById("filtroRe").value);
    const filtroNome = norm(document.getElementById("filtroNome").value);

    const snap = await getDocs(collection(db, "pontos"));
    let docs = snap.docs.map(doc => doc.data());

    // Filtrar per√≠odo pelo campo "data" (mais confi√°vel que new Date(timestamp))
    docs = docs.filter(d => {
        const dData = (d.data || "");
        return dData >= iniStr && dData <= fimStr;
    });

    // Filtro RE
    if (filtroRe) {
        docs = docs.filter(d => norm(d.re) === filtroRe);
    }

    // Filtro Nome (cont√©m)
    if (filtroNome) {
        docs = docs.filter(d => norm(d.nome).includes(filtroNome));
    }

    console.log("docs filtrados:", docs.length);
    montarTabela(docs);
};

// üìä ORGANIZAR EM 6 COLUNAS USANDO "tipo"
function montarTabela(dados) {

    const tbody = document.querySelector("tbody");
    tbody.innerHTML = "";

    // Agrupa por DIA + RE + NOME
    const grupos = {};

    for (const d of dados) {

        const data = d.data || ""; // YYYY-MM-DD
        const nome = d.nome || "";
        const re = d.re || "";

        const chave = `${data}__${re}__${nome}`;

        if (!grupos[chave]) {
            grupos[chave] = {
                data,
                nome,
                re,
                entrada: "",
                saida_intervalo: "",
                retorno_intervalo: "",
                saida: "",
                entrada_he: "",
                saida_he: "",
                _ordenacao: [] // para ordenar e preencher caso venha sem tipo (fallback)
            };
        }

        // Prefer√™ncia: usar tipo do index
        if (d.tipo && grupos[chave][d.tipo] !== undefined) {
            grupos[chave][d.tipo] = formatHora(d);
        } else {
            // fallback: guarda para ordena√ß√£o
            grupos[chave]._ordenacao.push(d);
        }
    }

    // Se tiver registros sem tipo (dados antigos), tenta preencher por ordem
    const ordemTipos = ["entrada","saida_intervalo","retorno_intervalo","saida","entrada_he","saida_he"];

    for (const chave in grupos) {

        const g = grupos[chave];

        if (g._ordenacao.length > 0) {
            g._ordenacao.sort((a,b) => (toDateAny(a.timestamp) - toDateAny(b.timestamp)));

            // Preenche em ordem s√≥ os que estiverem vazios
            let idx = 0;
            for (const tipo of ordemTipos) {
                if (!g[tipo] && g._ordenacao[idx]) {
                    g[tipo] = formatHora(g._ordenacao[idx]);
                    idx++;
                }
            }
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${g.data}</td>
            <td>${g.nome}</td>
            <td>${g.re}</td>
            <td>${g.entrada}</td>
            <td>${g.saida_intervalo}</td>
            <td>${g.retorno_intervalo}</td>
            <td>${g.saida}</td>
            <td>${g.entrada_he}</td>
            <td>${g.saida_he}</td>
        `;
        tbody.appendChild(tr);
    }
}

// Formata ‚Äúhora‚Äù preferindo campo hora, sen√£o usa timestamp
function formatHora(d) {
    if (d.hora) return d.hora; // j√° vem "HH:MM"
    const dt = toDateAny(d.timestamp);
    if (!dt || isNaN(dt)) return "";
    return dt.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
}

// üì• EXPORTAR CSV (9 colunas)
window.exportar = function() {

    let csv = "Data,Nome,RE,Entrada,Saida Intervalo,Retorno Intervalo,Saida,Entrada HE,Saida HE\n";

    document.querySelectorAll("tbody tr").forEach(tr => {
        const cols = tr.querySelectorAll("td");
        const linha = Array.from(cols)
            .map(td => `"${td.innerText.replaceAll('"','""')}"`)
            .join(",");
        csv += linha + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "pontos.csv";
    a.click();
};

</script>

</body>
</html>
