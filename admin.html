<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Painel Admin</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

<style>
  *{ box-sizing:border-box; }
  body{
    font-family:'Montserrat', Arial, sans-serif;
    background:#f0f0f0;
    padding:12px;
    margin:0;
    text-align:center;
  }
  .container{
    max-width:1300px;
    margin:12px auto;
    background:#fff;
    padding:14px;
    border-radius:12px;
    box-shadow:0 2px 10px rgba(0,0,0,0.08);
  }
  .logo{ width:220px; display:block; margin:0 auto 8px; max-width:90vw; height:auto; }

  h2{ margin:8px 0 10px; text-align:center; }
  h3{ margin:10px 0 8px; text-align:center; }

  .small{ font-size:12px; color:#666; text-align:center; }

  input, select, button{
    font-family:inherit;
    padding:10px;
    border-radius:10px;
    border:1px solid #ddd;
    outline:none;
  }
  button{ cursor:pointer; }
  button:hover{ filter:brightness(0.98); }

  .row{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    justify-content:center;
    align-items:end;
    margin-top:10px;
  }

  .hr{ height:1px; background:#eee; margin:18px 0; border:0; }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:14px;
    font-size:13px;
  }
  th, td{
    border:1px solid #e2e2e2;
    padding:8px;
    vertical-align:top;
  }
  th{ background:#fafafa; text-align:center; }
  thead th{ text-align:center; }
  td{ text-align:left; }

  .menu{
    display:flex;
    gap:8px;
    justify-content:center;
    flex-wrap:wrap;
    margin-top:10px;
  }
  .menu button{
    background:#1f6feb;
    color:#fff;
    border:none;
    border-radius:10px;
    padding:10px 14px;
  }
  .menu button.secondary{ background:#6c757d; }
  .menu button.activeBtn{ filter:brightness(0.92); }

  .minBtn{
    border:1px solid #ddd;
    background:#fff;
    border-radius:10px;
    padding:6px 10px;
    font-size:12px;
  }
  .minBtn:hover{ background:#f3f3f3; }

  .section{ display:none; }
  .section.active{ display:block; }

  .modalOverlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.45);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
    padding:10px;
  }
  .modal{
    background:#fff;
    width:min(920px, 96vw);
    max-height:92vh;
    overflow:auto;
    border-radius:12px;
    padding:14px;
    box-shadow:0 10px 30px rgba(0,0,0,0.22);
    text-align:left;
  }
  .modal h3{ margin:0 0 10px; text-align:left; }
  .modal .grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  .modal label{ font-size:12px; color:#555; }
  .modal input, .modal select{ width:100%; margin-top:4px; }

  .modal .actions{
    position:sticky;
    bottom:0;
    background:#fff;
    padding-top:10px;
    margin-top:10px;
    display:flex;
    justify-content:flex-end;
    gap:8px;
    border-top:1px solid #eee;
  }
  .modal .actions button{
    border:none;
    border-radius:10px;
    padding:10px 14px;
  }
  .btnPrimary{ background:#1f6feb; color:#fff; }
  .btnGhost{ background:#e9ecef; }
  .btnDangerInline{
    display:inline-block;
    border:1px solid #f2b8b5;
    background:#fff0f0;
    border-radius:10px;
    padding:8px 10px;
    font-size:12px;
    cursor:pointer;
    color:#a10000;
  }

  .pill{
    display:inline-block;
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    background:#f3f4f6;
    border:1px solid #e5e7eb;
    color:#111;
  }

  @media (max-width: 820px){
    table{ font-size:12px; }
    th, td{ padding:6px; }
    .modal .grid{ grid-template-columns:1fr; }
  }
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginDiv" class="container">
  <img src="GW.png" class="logo" />
  <h2>Login Admin</h2>
  <input id="email" placeholder="Email" autocomplete="username"><br><br>
  <input id="senha" type="password" placeholder="Senha" autocomplete="current-password"><br><br>
  <button id="btnLogin" onclick="login()">Entrar</button>
</div>

<!-- PAINEL -->
<div id="painelDiv" class="container" style="display:none;">
  <img src="GW.png" class="logo" />
  <h2>Painel Admin</h2>

  <div class="small">
    Editar horários no formato: <b>DD/MM/AAAA HH:MM</b> (ex: 16/02/2026 07:10)
  </div>

  <div class="menu">
    <button id="btnJornadas" onclick="showSection('secJornadas', this)">Jornadas</button>
    <button id="btnExportRH" onclick="showSection('secExportRH', this)">Exportação RH</button>
    <button id="btnColab" onclick="showSection('secColab', this)">Colaboradores</button>
    <button id="btnLocal" onclick="showSection('secLocal', this)">Locais</button>
    <button id="btnOcorr" onclick="showSection('secOcorr', this)">Ocorrências (dia)</button>
    <button id="btnAfast" onclick="showSection('secAfast', this)">Férias (período)</button>
    <button id="btnPlantoes" onclick="showSection('secPlantoes', this)">Plantões 12x36</button>
    <button id="btnSup" onclick="showSection('secSup', this)">Supervisores (FT)</button>
    <button class="secondary" onclick="logout()">Sair</button>
  </div>

  <hr class="hr">

  <!-- JORNADAS -->
  <div id="secJornadas" class="section active">
    <h3>Jornadas</h3>
    <div class="row">
      <label>De:</label><input type="date" id="inicio">
      <label>Até:</label><input type="date" id="fim">
      <input id="filtroRe" placeholder="Filtrar por RE (opcional)" inputmode="numeric">
      <input id="filtroNome" placeholder="Filtrar por Nome (opcional)">
      <button onclick="buscar()">Buscar</button>
      <button onclick="exportar()">Exportar CSV</button>
      <button class="secondary" onclick="abrirCriarJornada()">+ Criar Jornada</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Data (Entrada)</th>
          <th>Nome</th>
          <th>RE</th>
          <th>Entrada</th>
          <th>Início Intervalo</th>
          <th>Fim Intervalo</th>
          <th>Saída</th>
          <th>Entrada HE</th>
          <th>Saída HE</th>
          <th>Coords</th>
          <th>Local</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyJornadas"></tbody>
    </table>

    <div class="small" style="margin-top:10px;">
      <span class="pill">FT = Folga Trabalhada</span>
      <span class="pill">HE = Hora Extra</span>
    </div>
  </div>

  <!-- EXPORTAÇÃO RH -->
  <div id="secExportRH" class="section">
    <h3>Exportação RH</h3>
    <div class="small">
      Gera um único XLSX com 3 abas: <b>Resumo</b>, <b>Diário</b> e <b>Escala</b>.<br>
      <b>HE</b> = excedente do planejado em dia de trabalho + campo HE.<br>
      <b>FT</b> = trabalho em folga (NÃO conta como HE).<br>
      <b>Exporta apenas colaboradores ATIVOS.</b>
    </div>

    <div class="row">
      <label>Competência (mês):</label>
      <select id="rhMes"></select>

      <label>Ano:</label>
      <select id="rhAno"></select>

      <button onclick="exportarRHXLSX()">Exportar RH (XLSX)</button>
    </div>

    <div class="small" id="rhStatus" style="margin-top:10px;"></div>
  </div>

  <!-- COLABORADORES -->
  <div id="secColab" class="section">
    <h3>Colaboradores</h3>
    <div class="small">CPF é obrigatório • Sem excluir colaborador • Cadastre escala, horário previsto e data de admissão</div>

    <div class="row">
      <input id="colabBuscaRe" placeholder="Buscar por RE" inputmode="numeric">
      <input id="colabBuscaNome" placeholder="Buscar por Nome">
      <button onclick="aplicarFiltroColab()">Buscar</button>
      <button class="secondary" onclick="limparFiltroColab()">Limpar</button>
    </div>

    <div class="row">
      <input id="cadRe" placeholder="RE" inputmode="numeric">
      <input id="cadNome" placeholder="Nome completo">
      <input id="cadCpf" placeholder="CPF (obrigatório)" inputmode="numeric">

      <select id="cadEscala">
        <option value="5x2">5x2 (Seg-Sex)</option>
        <option value="6x1">6x1 (Folga Dom)</option>
        <option value="12x36">12x36 (1 trabalha / 1 folga)</option>
      </select>

      <input id="cadHoraEntrada" type="time" title="Hora prevista de entrada (informativo)">
      <input id="cadHoraSaida" type="time" title="Hora prevista de saída (informativo)">

      <input id="cadAdmissao" type="date" title="Data de admissão">

      <button onclick="cadastrarColab()">Cadastrar</button>
      <button onclick="carregarColaboradores()">Atualizar lista</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>RE</th>
          <th>Nome</th>
          <th>CPF</th>
          <th>Escala</th>
          <th>Horário</th>
          <th>Admissão</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyColab"></tbody>
    </table>
  </div>

  <!-- LOCAIS -->
  <div id="secLocal" class="section">
    <h3>Locais</h3>
    <div class="small">margem = raio (metros) • locais podem ser excluídos</div>

    <div class="row">
      <input id="locNome" placeholder="Nome do posto (ex: Posto A)">
      <input id="locLat" placeholder="Latitude (X) ex: -12.3456">
      <input id="locLng" placeholder="Longitude (Y) ex: -38.1234">
      <input id="locRaio" placeholder="Margem (metros) ex: 150" inputmode="numeric">
      <button onclick="cadastrarLocal()">Cadastrar</button>
      <button onclick="carregarLocais()">Atualizar lista</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th>Raio (m)</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyLocais"></tbody>
    </table>
  </div>

  <!-- OCORRÊNCIAS -->
  <div id="secOcorr" class="section">
    <h3>Ocorrências (por dia)</h3>
    <div class="small">
      Ao salvar (FALTA/ATESTADO/ABONO), a ocorrência vira prioridade e apaga jornadas do dia (pela data da ENTRADA).
    </div>

    <div class="row">
      <input id="ocRe" placeholder="RE" inputmode="numeric">
      <input id="ocData" type="date">
      <select id="ocTipo">
        <option value="falta">FALTA</option>
        <option value="atestado">ATESTADO</option>
        <option value="abono">ABONO</option>
      </select>
      <input id="ocMotivo" placeholder="Motivo (opcional)">
      <button onclick="salvarOcorrencia()">Salvar ocorrência (prioritária)</button>
    </div>

    <hr class="hr">

    <div class="row">
      <input id="ocFiltroRe" placeholder="Filtrar RE (opcional)" inputmode="numeric">
      <input id="ocFiltroData" type="date" title="Filtrar data (opcional)">
      <button onclick="carregarOcorrencias()">Atualizar lista</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>RE</th>
          <th>Nome</th>
          <th>Tipo</th>
          <th>Motivo</th>
          <th>Atualizado</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyOcorr"></tbody>
    </table>
  </div>

  <!-- FÉRIAS -->
  <div id="secAfast" class="section">
    <h3>Férias (por período)</h3>
    <div class="small">
      Cadastre 1 período e o sistema marca automaticamente no espelho (somente dias de trabalho).<br>
      Ao salvar férias, o sistema apaga jornadas do período (dias úteis, conforme escala do colaborador).
    </div>

    <div class="row">
      <input id="afRe" placeholder="RE" inputmode="numeric">
      <input id="afInicio" type="date">
      <input id="afFim" type="date">
      <label style="display:flex;align-items:center;gap:6px;font-size:12px;">
        <input type="checkbox" id="afDiasUteis" checked> Somente dias de trabalho
      </label>
      <input id="afMotivo" placeholder="Motivo (opcional)">
      <button onclick="salvarFerias()">Salvar FÉRIAS</button>
      <button onclick="carregarFerias()">Atualizar lista</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>RE</th>
          <th>Nome</th>
          <th>Período</th>
          <th>Somente dias trabalho?</th>
          <th>Motivo</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyFerias"></tbody>
    </table>
  </div>

  <!-- PLANTÕES 12x36 -->
  <div id="secPlantoes" class="section">
    <h3>Plantões 12x36</h3>
    <div class="small">
      Cadastre uma regra de base por vigência: se em <b>DATA</b> a pessoa estará em <b>TRABALHA</b> ou <b>FOLGA</b>.<br>
      O sistema usa o histórico (não altera o passado ao trocar o plantão depois).<br>
      <b>IMPORTANTE:</b> após salvar, sincroniza em <b>colaboradores/{re}.plantaoHistorico</b>.
    </div>

    <div class="row">
      <input id="plRe" placeholder="RE" inputmode="numeric">
      <input id="plVigencia" type="date" title="A partir desta data (inclusive)">
      <select id="plBase">
        <option value="trabalha">TRABALHA (dia base)</option>
        <option value="folga">FOLGA (dia base)</option>
      </select>
      <input id="plObs" placeholder="Obs (opcional) ex: Mudança de plantão">
      <button onclick="salvarPlantao12x36()">Salvar 12x36</button>
    </div>

    <hr class="hr">

    <div class="row">
      <input id="plFiltroRe" placeholder="Filtrar RE (opcional)" inputmode="numeric">
      <button onclick="carregarPlantoes12x36()">Atualizar lista</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>RE</th>
          <th>Nome</th>
          <th>Vigência</th>
          <th>Base</th>
          <th>Obs</th>
          <th>Atualizado</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodyPlantoes"></tbody>
    </table>
  </div>

  <!-- SUPERVISORES (FT) -->
  <div id="secSup" class="section">
    <h3>Supervisores (FT)</h3>
    <div class="small">
      Cadastro de supervisores (somente nome). Usado no fluxo de FT do registro.
    </div>

    <div class="row">
      <input id="supNome" placeholder="Nome do supervisor">
      <button onclick="cadastrarSupervisor()">Cadastrar</button>
      <button onclick="carregarSupervisores()">Atualizar lista</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Atualizado</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tbodySup"></tbody>
    </table>
  </div>

</div>

<!-- MODAL -->
<div id="modalOverlay" class="modalOverlay" onclick="closeModalIfBackdrop(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <h3 id="modalTitle">Editar</h3>
    <div id="modalBody"></div>
    <div class="actions">
      <button class="btnGhost" onclick="closeModal()">Cancelar</button>
      <button id="modalSaveBtn" class="btnPrimary">Salvar</button>
    </div>
  </div>
</div>

<!-- XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- Firebase COMPAT (global) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
/* ========= FIREBASE CONFIG ========= */
const firebaseConfig = {
  apiKey: "AIzaSyD--zpWLbLg5X82oGTyz6SuPFQV0sd7NWc",
  authDomain: "controle-ponto-f539b.firebaseapp.com",
  projectId: "controle-ponto-f539b",
  storageBucket: "controle-ponto-f539b.appspot.com",
  messagingSenderId: "324716100257",
  appId: "1:324716100257:web:32d49a9ab4916182dd4ee0",
  measurementId: "G-P81H3C4SFK"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginDiv = document.getElementById("loginDiv");
const painelDiv = document.getElementById("painelDiv");

let ultimaTabela = [];
let cacheLocais = [];
let cacheColabs = [];
let cacheFerias = [];
let cacheOcorr = [];
let cachePlantoes = [];
let cacheSupervisores = [];

let colabFiltroRe = "";
let colabFiltroNome = "";

/* ========= RH SELECTS ========= */
function pad2(n){ return String(n).padStart(2,"0"); }
function initRhSelectors(){
  const mesSel = document.getElementById("rhMes");
  const anoSel = document.getElementById("rhAno");
  if (!mesSel || !anoSel) return;

  const now = new Date();
  const y = now.getFullYear();

  mesSel.innerHTML = "";
  for (let m=1; m<=12; m++){
    const opt=document.createElement("option");
    opt.value=String(m);
    opt.textContent=pad2(m);
    if (m === (now.getMonth()+1)) opt.selected=true;
    mesSel.appendChild(opt);
  }

  anoSel.innerHTML = "";
  for (let yy=y-3; yy<=y+1; yy++){
    const opt=document.createElement("option");
    opt.value=String(yy);
    opt.textContent=String(yy);
    if (yy===y) opt.selected=true;
    anoSel.appendChild(opt);
  }
}
initRhSelectors();

/* ========= MENU ========= */
function showSection(id, btnEl){
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  document.querySelectorAll(".menu button").forEach(b => b.classList.remove("activeBtn"));
  if (btnEl) btnEl.classList.add("activeBtn");

  if (id === "secLocal") carregarLocais();
  if (id === "secColab") carregarColaboradores();
  if (id === "secAfast") { carregarColaboradores().then(carregarFerias); }
  if (id === "secOcorr") { carregarColaboradores().then(carregarOcorrencias); }
  if (id === "secPlantoes") { carregarColaboradores().then(carregarPlantoes12x36); }
  if (id === "secSup") { carregarSupervisores(); }
}
window.showSection = showSection;

/* ========= AUTH ========= */
function login(){
  const btn = document.getElementById("btnLogin");
  btn.disabled = true;
  btn.innerText = "Entrando...";

  const email = (document.getElementById("email").value || "").trim();
  const senha = (document.getElementById("senha").value || "").trim();

  if(!email || !senha){
    alert("Informe email e senha.");
    btn.disabled = false;
    btn.innerText = "Entrar";
    return;
  }

  auth.signInWithEmailAndPassword(email, senha)
    .catch(function(e){
      console.error("LOGIN ERRO:", e);
      alert("Email ou senha inválidos.");
    })
    .finally(function(){
      btn.disabled = false;
      btn.innerText = "Entrar";
    });
}
window.login = login;

function logout(){ auth.signOut(); }
window.logout = logout;

auth.onAuthStateChanged(async function(user){
  if(user){
    try{ await user.getIdToken(true); }catch(e){ console.warn("token refresh falhou:", e); }

    loginDiv.style.display = "none";
    painelDiv.style.display = "block";
    try{
      const b = document.getElementById("btnJornadas");
      if (b) b.classList.add("activeBtn");
      carregarLocais();
      carregarColaboradores();
      carregarSupervisores();
    }catch(e){
      console.error("Erro ao iniciar painel:", e);
    }
  }else{
    loginDiv.style.display = "block";
    painelDiv.style.display = "none";
  }
});

/* ========= DEBUG (chame no console: debugAuthAndSupervisores()) ========= */
async function debugAuthAndSupervisores(){
  const u = auth.currentUser;
  console.log("AUTH user:", u ? u.email : null, u ? u.uid : null);
  if (!u){ console.log("❌ Não está logado."); return; }

  const tokenRes = await u.getIdTokenResult(true);
  console.log("CLAIMS:", tokenRes.claims);

  try{
    const snap = await db.collection("supervisores").limit(1).get();
    console.log("✅ READ supervisores ok. docs:", snap.size);
  }catch(e){
    console.error("❌ READ supervisores falhou:", e.code, e.message, e);
  }

  try{
    const ref = await db.collection("supervisores").add({ nome:"__teste__", updatedAt:new Date().toISOString() });
    console.log("✅ WRITE supervisores ok. id:", ref.id);
    await db.collection("supervisores").doc(ref.id).delete();
    console.log("✅ DELETE supervisores ok.");
  }catch(e){
    console.error("❌ WRITE/DELETE supervisores falhou:", e.code, e.message, e);
  }
}
window.debugAuthAndSupervisores = debugAuthAndSupervisores;

/* ========= HELPERS ========= */
function norm(s){ return (s||"").toString().trim().toLowerCase(); }
function safeStr(v){ return (v==null) ? "" : String(v); }

function toDateAny(ts){
  if (!ts) return null;
  if (ts.toDate) return ts.toDate();
  if (ts instanceof Date) return ts;
  return new Date(ts);
}
function formatHHMM(ts){
  const d = toDateAny(ts);
  if (!d || isNaN(d)) return "";
  return d.toLocaleTimeString("pt-BR", { hour:"2-digit", minute:"2-digit" });
}
function formatBRDate(ts){
  const d = toDateAny(ts);
  if (!d || isNaN(d)) return "";
  return d.toLocaleDateString("pt-BR");
}
function brDateFromYmd(ymd){
  if (!ymd) return "";
  const p = String(ymd).slice(0,10).split("-");
  if (p.length!==3) return ymd;
  return `${p[2]}/${p[1]}/${p[0]}`;
}
function isoFromBrDateTime(str){
  const m = (str||"").trim().match(/^(\d{2})\/(\d{2})\/(\d{4})\s+([01]\d|2[0-3]):([0-5]\d)$/);
  if (!m) return null;
  const dd=m[1], mm=m[2], yyyy=m[3], hh=m[4], mi=m[5];
  const dt = new Date(`${yyyy}-${mm}-${dd}T${hh}:${mi}:00`);
  if (isNaN(dt)) return null;
  return dt.toISOString();
}
function brDateTimeFromIso(ts){
  const d = toDateAny(ts);
  if (!d || isNaN(d)) return "";
  const data = d.toLocaleDateString("pt-BR");
  const hora = d.toLocaleTimeString("pt-BR", {hour:"2-digit", minute:"2-digit"});
  return `${data} ${hora}`;
}
function horarioTxt(c){
  const he = (c && c.horaEntrada ? String(c.horaEntrada).trim() : "");
  const hs = (c && c.horaSaida ? String(c.horaSaida).trim() : "");
  if (he && hs) return `${he}–${hs}`;
  if (he || hs) return `${he||"—"}–${hs||"—"}`;
  return "—";
}
function ymd(d){
  if (!d || isNaN(d)) return "";
  return d.toISOString().slice(0,10);
}
function weekdayPtShort(d){ return d.toLocaleDateString("pt-BR", { weekday:"short" }); }

/* ========= NOVO: DATETIME PARA TURNOS NOTURNOS =========
   - Permite "virar o dia" (ex: 19:00 -> 07:00 do dia seguinte)
   - E garante que SAÍDA não fique anterior à ENTRADA
======================================================== */
function parseHHMM(hhmm){
  const m = (hhmm||"").trim().match(/^([01]\d|2[0-3]):([0-5]\d)$/);
  if (!m) return null;
  return { hh:Number(m[1]), mm:Number(m[2]) };
}
function dateFromYmdAndTime(ymdKey, hhmm){
  const t = parseHHMM(hhmm);
  if (!t) return null;
  const dt = new Date(`${ymdKey}T${String(t.hh).padStart(2,"0")}:${String(t.mm).padStart(2,"0")}:00`);
  if (isNaN(dt)) return null;
  return dt;
}
function addDays(dt, days){
  const d = new Date(dt);
  d.setDate(d.getDate()+days);
  return d;
}
/**
 * Cria um Date relativo ao "baseDate" (mesmo dia por padrão).
 * Se o horário "cair antes" do baseDate, adiciona 1 dia (vira o dia).
 */
function dateRelativeToBase(baseDate, hhmm){
  const t = parseHHMM(hhmm);
  if (!t) return null;
  const cand = new Date(baseDate);
  cand.setHours(t.hh, t.mm, 0, 0);
  if (cand < baseDate) return addDays(cand, 1);
  return cand;
}
function ensureNotBefore(label, aIso, bIso){
  // garante b >= a
  if (!aIso || !bIso) return true;
  const a = toDateAny(aIso);
  const b = toDateAny(bIso);
  if (!a || !b || isNaN(a) || isNaN(b)) return true;
  if (b < a){
    alert(`❌ ${label} não pode ser anterior ao horário anterior.`);
    return false;
  }
  return true;
}

/* ========= 12x36 helpers (ADMIN) ========= */
function normEscala(s){ return (s||"").toString().trim().toLowerCase(); }
function is12x36Escala(escalaTxt){
  const e = normEscala(escalaTxt||"");
  return e.includes("12") && e.includes("36");
}
function getPlantaoReferencia(dateObj, historico){
  if (!Array.isArray(historico) || !historico.length) return null;
  const key = ymd(dateObj);

  let best = null;
  for (const p of historico){
    const ini = String(p?.inicio || p?.vigencia || "").slice(0,10);
    if (!/^\d{4}-\d{2}-\d{2}$/.test(ini)) continue;

    if (ini <= key){
      if (!best){ best = { ...p, inicio: ini }; continue; }

      const bestIni = String(best.inicio || "").slice(0,10);
      if (ini > bestIni){ best = { ...p, inicio: ini }; continue; }

      if (ini === bestIni){
        const bestUp = String(best.updatedAt || "");
        const curUp  = String(p.updatedAt || "");
        if (curUp > bestUp) best = { ...p, inicio: ini };
      }
    }
  }
  return best;
}
function isFolgaByEscala(dateObj, escala, plantaoHistorico){
  const e = normEscala(escala || "5x2");
  const dow = dateObj.getDay();

  if (e === "5x2") return (dow === 0 || dow === 6);
  if (e === "6x1") return (dow === 0);

  if (is12x36Escala(e)){
    const hist = Array.isArray(plantaoHistorico) ? plantaoHistorico : [];
    const plantao = getPlantaoReferencia(dateObj, hist);
    if (!plantao) return true;

    const inicio = String(plantao.inicio || "").slice(0,10);
    const baseTxt = String(plantao.base || "trabalha").toLowerCase();

    const baseDate = new Date(inicio + "T00:00:00");
    const atual = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), 12, 0, 0);
    const diffDias = Math.floor((atual - baseDate) / 86400000);

    const baseEhTrabalho = (baseTxt === "trabalha");
    const ehTrabalhoHoje = (diffDias % 2 === 0) ? baseEhTrabalho : !baseEhTrabalho;

    return !ehTrabalhoHoje;
  }

  return true;
}
function isDiaTrabalho(dateObj, escala, plantaoHistorico){
  return !isFolgaByEscala(dateObj, escala, plantaoHistorico);
}

/* ========= MODAL ========= */
const overlay=document.getElementById("modalOverlay");
const titleEl=document.getElementById("modalTitle");
const bodyEl=document.getElementById("modalBody");
const saveBtn=document.getElementById("modalSaveBtn");

function closeModal(){ overlay.style.display="none"; bodyEl.innerHTML=""; saveBtn.onclick=null; }
function closeModalIfBackdrop(e){ if (e.target===overlay) closeModal(); }

window.closeModal = closeModal;
window.closeModalIfBackdrop = closeModalIfBackdrop;

function openModal(obj){
  titleEl.innerText = obj.title || "Editar";
  bodyEl.innerHTML = obj.bodyHtml || "";
  overlay.style.display="flex";
  saveBtn.onclick = obj.onSave || null;
}

/* ========= CRIAR JORNADA (NOVO) ========= */
function existeEntradaNoDia(re, ymdKey, ignoreId){
  return db.collection("jornadas").where("re","==",re).get()
    .then(function(snap){
      const all = snap.docs.map(function(d){ return Object.assign({ id:d.id }, d.data()||{}); });
      return all.some(function(j){
        if (ignoreId && j.id === ignoreId) return false;
        const k = String(j && j.entrada && j.entrada.ts ? j.entrada.ts : "").slice(0,10);
        return k === ymdKey;
      });
    });
}

function abrirCriarJornada(){
  openModal({
    title: "Criar Jornada (Admin)",
    bodyHtml: `
      <div class="grid">
        <div>
          <label>RE</label>
          <input id="cjRe" placeholder="RE" inputmode="numeric">
        </div>
        <div>
          <label>Data (da ENTRADA)</label>
          <input id="cjData" type="date">
        </div>
        <div>
          <label>Hora ENTRADA</label>
          <input id="cjEntrada" type="time" value="08:00">
        </div>
        <div>
          <label>Hora SAÍDA</label>
          <input id="cjSaida" type="time" value="17:48">
          <div class="small" style="text-align:left;">✅ Se a saída for menor que a entrada, o sistema assume <b>dia seguinte</b> (turno noturno).</div>
        </div>
        <div>
          <label>Início intervalo (opcional)</label>
          <input id="cjSaiInt" type="time" placeholder="12:00">
        </div>
        <div>
          <label>Fim intervalo (opcional)</label>
          <input id="cjRetInt" type="time" placeholder="13:00">
        </div>
        <div>
          <label>Entrada HE (opcional)</label>
          <input id="cjEntHe" type="time">
        </div>
        <div>
          <label>Saída HE (opcional)</label>
          <input id="cjSaiHe" type="time">
        </div>
        <div style="grid-column:1 / -1">
          <label>Posto (opcional)</label>
          <input id="cjPosto" placeholder="Ex: Posto A">
        </div>
        <div style="grid-column:1 / -1">
          <label>Coords (opcional) — formato: lat,lng</label>
          <input id="cjLocation" placeholder="-23.5505,-46.6333">
        </div>
        <div style="grid-column:1 / -1" class="small" style="text-align:left">
          Dica: deixe intervalos/HE em branco se não existirem. O sistema cria a jornada com status "fechada" se tiver SAÍDA.
        </div>
      </div>
    `,
    onSave: function(){
      const re = (document.getElementById("cjRe").value || "").trim();
      const data = (document.getElementById("cjData").value || "").trim(); // data da ENTRADA
      const hEnt = (document.getElementById("cjEntrada").value || "").trim();
      const hSai = (document.getElementById("cjSaida").value || "").trim();

      const hSaiInt = (document.getElementById("cjSaiInt").value || "").trim();
      const hRetInt = (document.getElementById("cjRetInt").value || "").trim();
      const hEntHe  = (document.getElementById("cjEntHe").value || "").trim();
      const hSaiHe  = (document.getElementById("cjSaiHe").value || "").trim();

      const posto = (document.getElementById("cjPosto").value || "").trim();
      const location = (document.getElementById("cjLocation").value || "").trim();

      if (!re){ alert("Informe o RE."); return; }
      if (!data){ alert("Informe a data."); return; }
      if (!hEnt){ alert("Informe a hora de ENTRADA."); return; }
      if (!hSai){ alert("Informe a hora de SAÍDA."); return; }

      // ENTRADA fixa no dia selecionado
      const entDt = dateFromYmdAndTime(data, hEnt);
      if (!entDt){ alert("Horário de ENTRADA inválido."); return; }

      // SAÍDA pode virar o dia: se horário < entrada, joga para o dia seguinte
      const saiDt = dateRelativeToBase(entDt, hSai);
      if (!saiDt){ alert("Horário de SAÍDA inválido."); return; }

      if (saiDt < entDt){
        alert("❌ Saída não pode ser anterior à entrada.");
        return;
      }

      // Intervalo/HE: também seguem a lógica relativa (podem virar o dia conforme base)
      let siDt = null, riDt = null, ehDt = null, shDt = null;

      if (hSaiInt){
        siDt = dateRelativeToBase(entDt, hSaiInt);
        if (!siDt){ alert("Horário de início do intervalo inválido."); return; }
        if (siDt < entDt){ alert("❌ Início do intervalo não pode ser antes da entrada."); return; }
      }
      if (hRetInt){
        const base = siDt || entDt;
        riDt = dateRelativeToBase(base, hRetInt);
        if (!riDt){ alert("Horário de fim do intervalo inválido."); return; }
      }
      if (siDt && riDt && riDt < siDt){
        alert("❌ Fim do intervalo não pode ser anterior ao início do intervalo.");
        return;
      }

      // Se quiser, garante que intervalo esteja dentro do período entrada->saída
      if (siDt && siDt > saiDt){ alert("❌ Início do intervalo não pode ser após a saída."); return; }
      if (riDt && riDt > saiDt){ alert("❌ Fim do intervalo não pode ser após a saída."); return; }

      if (hEntHe){
        // HE normalmente vem depois, mas só exigimos que não seja antes da entrada
        ehDt = dateRelativeToBase(entDt, hEntHe);
        if (!ehDt){ alert("Horário de entrada HE inválido."); return; }
        if (ehDt < entDt){ alert("❌ Entrada HE não pode ser antes da entrada."); return; }
      }
      if (hSaiHe){
        const base = ehDt || entDt;
        shDt = dateRelativeToBase(base, hSaiHe);
        if (!shDt){ alert("Horário de saída HE inválido."); return; }
      }
      if (ehDt && shDt && shDt < ehDt){
        alert("❌ Saída HE não pode ser anterior à entrada HE.");
        return;
      }

      const entIso = entDt.toISOString();
      const saiIso = saiDt.toISOString();
      const siIso  = siDt ? siDt.toISOString() : null;
      const riIso  = riDt ? riDt.toISOString() : null;
      const ehIso  = ehDt ? ehDt.toISOString() : null;
      const shIso  = shDt ? shDt.toISOString() : null;

      db.collection("colaboradores").doc(re).get()
        .then(function(snap){
          if (!snap.exists){ alert("Colaborador não encontrado."); return Promise.reject(); }
          const col = snap.data() || {};
          const nome = String(col.nome||"").trim();
          if (!nome){ alert("Colaborador sem nome cadastrado."); return Promise.reject(); }

          return existeEntradaNoDia(re, data, null).then(function(dup){
            if (dup){
              alert("❌ Já existe uma jornada com ENTRADA nesse dia para este RE.");
              return Promise.reject();
            }

            const payload = {
              re,
              nome,
              status: "fechada",
              entrada: { ts: entIso, foto:"", location: location||"", posto: posto||"" },
              saida: { ts: saiIso, foto:"", location: location||"", posto: posto||"" },
              updatedAt: new Date().toISOString(),
              adminCriada: true
            };

            if (siIso) payload.saida_intervalo = { ts: siIso, foto:"", location: location||"", posto: posto||"" };
            if (riIso) payload.retorno_intervalo = { ts: riIso, foto:"", location: location||"", posto: posto||"" };
            if (ehIso) payload.entrada_he = { ts: ehIso, foto:"", location: location||"", posto: posto||"" };
            if (shIso) payload.saida_he = { ts: shIso, foto:"", location: location||"", posto: posto||"" };

            const virouTxt = (ymd(entDt) !== ymd(saiDt)) ? "\n⚠️ Saída no dia seguinte (turno noturno)" : "";
            if (!confirm(
              `Criar jornada?\nRE: ${re}\nData (Entrada): ${brDateFromYmd(data)}\nEntrada: ${hEnt}\nSaída: ${hSai}` +
              virouTxt +
              (hSaiInt?`\nInício intervalo: ${hSaiInt}`:"") +
              (hRetInt?`\nFim intervalo: ${hRetInt}`:"") +
              (hEntHe?`\nEntrada HE: ${hEntHe}`:"") +
              (hSaiHe?`\nSaída HE: ${hSaiHe}`:"")
            )) return Promise.reject();

            return db.collection("jornadas").add(payload);
          });
        })
        .then(function(){
          closeModal();
          buscar();
          alert("✅ Jornada criada.");
        })
        .catch(function(e){
          if (e) console.warn("criar jornada cancel/erro:", e);
        });
    }
  });
}
window.abrirCriarJornada = abrirCriarJornada;

/* ========= LOCAIS ========= */
function haversineMeters(lat1, lon1, lat2, lon2){
  const R=6371000; const toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function parseLocation(str){
  if (!str) return null;
  const p=str.split(",").map(s=>s.trim());
  if (p.length!==2) return null;
  const lat=Number(p[0]), lng=Number(p[1]);
  if (!Number.isFinite(lat)||!Number.isFinite(lng)) return null;
  return {lat,lng};
}
function getBestLocationFromJornada(j){
  const steps=["saida_he","entrada_he","saida","retorno_intervalo","saida_intervalo","entrada"];
  for (let i=0;i<steps.length;i++){
    const s=steps[i];
    const loc = j && j[s] && j[s].location ? j[s].location : "";
    if (loc) return loc;
  }
  return "";
}
function reconhecerLocal(locationStr){
  const p=parseLocation(locationStr);
  if (!p) return "Não disponível";
  let best=null;
  for (let i=0;i<cacheLocais.length;i++){
    const l=cacheLocais[i];
    const d=haversineMeters(p.lat,p.lng,l.lat,l.lng);
    if (d<=l.raio){
      if (!best || d<best.d) best={nome:l.nome,d:d};
    }
  }
  return best ? best.nome : "Não reconhecido";
}

function cadastrarLocal(){
  const nome = (document.getElementById("locNome").value || "").trim();
  const lat = Number((document.getElementById("locLat").value || "").trim());
  const lng = Number((document.getElementById("locLng").value || "").trim());
  const raio = Number((document.getElementById("locRaio").value || "").trim());

  if (!nome || !Number.isFinite(lat) || !Number.isFinite(lng) || !Number.isFinite(raio)){
    alert("Preencha Nome, Latitude, Longitude e Raio.");
    return;
  }
  if (!confirm(`Cadastrar local?\n${nome}\n(${lat}, ${lng})\nRaio: ${raio}m`)) return;

  db.collection("locais").add({ nome, lat, lng, raio, updatedAt:new Date().toISOString() })
    .then(function(){
      document.getElementById("locNome").value="";
      document.getElementById("locLat").value="";
      document.getElementById("locLng").value="";
      document.getElementById("locRaio").value="";
      carregarLocais();
    })
    .catch(function(e){
      console.error("cadastrarLocal ERRO:", e);
      alert("Não foi possível cadastrar o local.");
    });
}
window.cadastrarLocal = cadastrarLocal;

function carregarLocais(){
  return db.collection("locais").get()
    .then(function(snap){
      cacheLocais = snap.docs.map(function(d){
        const data = d.data() || {};
        return { id:d.id, nome:data.nome, lat:data.lat, lng:data.lng, raio:data.raio, updatedAt:data.updatedAt };
      })
      .filter(function(l){
        return Number.isFinite(l.lat) && Number.isFinite(l.lng) && Number.isFinite(l.raio);
      })
      .sort(function(a,b){
        return String(a.nome||"").localeCompare(String(b.nome||""));
      });

      const tbody=document.getElementById("tbodyLocais");
      if (!tbody) return;

      tbody.innerHTML="";
      cacheLocais.forEach(function(l){
        const tr=document.createElement("tr");
        tr.innerHTML = `
          <td>${l.nome || ""}</td>
          <td>${l.lat}</td>
          <td>${l.lng}</td>
          <td>${l.raio}</td>
          <td><button class="minBtn" onclick="editarLocal('${l.id}')">Modificar</button></td>
        `;
        tbody.appendChild(tr);
      });
    })
    .catch(function(e){
      console.error("carregarLocais ERRO:", e);
      alert("Não foi possível carregar locais.");
    });
}
window.carregarLocais = carregarLocais;

function editarLocal(id){
  const l = cacheLocais.find(function(x){ return x.id===id; });
  if (!l){ alert("Local não encontrado."); return; }

  openModal({
    title: "Modificar local",
    bodyHtml: `
      <div class="grid">
        <div style="grid-column:1 / -1">
          <label>Nome</label>
          <input id="mlNome" value="${(l.nome||"").replaceAll('"','&quot;')}">
        </div>
        <div>
          <label>Latitude</label>
          <input id="mlLat" value="${l.lat}">
        </div>
        <div>
          <label>Longitude</label>
          <input id="mlLng" value="${l.lng}">
        </div>
        <div style="grid-column:1 / -1">
          <label>Raio (m)</label>
          <input id="mlRaio" value="${l.raio}">
        </div>
        <div class="small" style="grid-column:1 / -1">
          <button class="btnDangerInline" id="btnExcluirLocal">Excluir local</button>
        </div>
      </div>
    `,
    onSave: function(){
      const nome = (document.getElementById("mlNome").value || "").trim();
      const lat = Number((document.getElementById("mlLat").value || "").trim());
      const lng = Number((document.getElementById("mlLng").value || "").trim());
      const raio = Number((document.getElementById("mlRaio").value || "").trim());

      if (!nome || !Number.isFinite(lat) || !Number.isFinite(lng) || !Number.isFinite(raio)){
        alert("Preencha corretamente Nome, Latitude, Longitude e Raio.");
        return;
      }
      if (!confirm("Salvar alterações do local?")) return;

      db.collection("locais").doc(id).update({ nome, lat, lng, raio, updatedAt:new Date().toISOString() })
        .then(function(){
          closeModal();
          carregarLocais();
          try{ buscar(); }catch{}
        })
        .catch(function(e){
          console.error("editarLocal update ERRO:", e);
          alert("Não foi possível salvar o local.");
        });
    }
  });

  setTimeout(function(){
    const btn = document.getElementById("btnExcluirLocal");
    if (!btn) return;
    btn.onclick = function(){
      if (!confirm("Excluir este local?")) return;
      db.collection("locais").doc(id).delete()
        .then(function(){
          closeModal();
          carregarLocais();
          try{ buscar(); }catch{}
        })
        .catch(function(e){
          console.error("editarLocal delete ERRO:", e);
          alert("Não foi possível excluir o local.");
        });
    };
  }, 0);
}
window.editarLocal = editarLocal;

/* ========= SUPERVISORES (FT) ========= */
function carregarSupervisores(){
  return db.collection("supervisores").get()
    .then(function(snap){
      cacheSupervisores = snap.docs.map(function(d){
        const data = d.data() || {};
        return { id:d.id, nome:String(data.nome||"").trim(), updatedAt:String(data.updatedAt||"") };
      })
      .filter(function(s){ return !!s.nome; })
      .sort(function(a,b){ return a.nome.localeCompare(b.nome); });

      const tbody = document.getElementById("tbodySup");
      if (!tbody) return;
      tbody.innerHTML = "";

      cacheSupervisores.forEach(function(s){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.nome}</td>
          <td>${brDateTimeFromIso(s.updatedAt)}</td>
          <td><button class="minBtn" onclick="editarSupervisor('${s.id}')">Modificar</button></td>
        `;
        tbody.appendChild(tr);
      });
    })
    .catch(function(e){
      console.error("carregarSupervisores ERRO:", e);
      alert("Não foi possível carregar supervisores.");
    });
}
window.carregarSupervisores = carregarSupervisores;

function cadastrarSupervisor(){
  const nome = (document.getElementById("supNome").value || "").trim();
  if (!nome){ alert("Informe o nome do supervisor."); return; }
  if (!confirm(`Cadastrar supervisor?\n${nome}`)) return;

  db.collection("supervisores").add({ nome, updatedAt:new Date().toISOString() })
    .then(function(){
      document.getElementById("supNome").value = "";
      carregarSupervisores();
    })
    .catch(function(e){
      console.error("cadastrarSupervisor ERRO:", e);
      alert("Não foi possível cadastrar supervisor.");
    });
}
window.cadastrarSupervisor = cadastrarSupervisor;

function editarSupervisor(id){
  const s = cacheSupervisores.find(function(x){ return x.id===id; });
  if (!s){ alert("Supervisor não encontrado."); return; }

  openModal({
    title: "Modificar supervisor",
    bodyHtml: `
      <div class="grid">
        <div style="grid-column:1 / -1">
          <label>Nome</label>
          <input id="msNome" value="${String(s.nome||"").replaceAll('"','&quot;')}">
        </div>
        <div class="small" style="grid-column:1 / -1">
          <button class="btnDangerInline" id="btnExcluirSup">Excluir supervisor</button>
        </div>
      </div>
    `,
    onSave: function(){
      const nome = (document.getElementById("msNome").value || "").trim();
      if (!nome){ alert("Nome não pode ficar vazio."); return; }
      if (!confirm("Salvar alterações do supervisor?")) return;

      db.collection("supervisores").doc(id).update({ nome, updatedAt:new Date().toISOString() })
        .then(function(){
          closeModal();
          carregarSupervisores();
        })
        .catch(function(e){
          console.error("editarSupervisor update ERRO:", e);
          alert("Não foi possível salvar supervisor.");
        });
    }
  });

  setTimeout(function(){
    const btn = document.getElementById("btnExcluirSup");
    if (!btn) return;
    btn.onclick = function(){
      if (!confirm("Excluir este supervisor?")) return;
      db.collection("supervisores").doc(id).delete()
        .then(function(){
          closeModal();
          carregarSupervisores();
        })
        .catch(function(e){
          console.error("editarSupervisor delete ERRO:", e);
          alert("Não foi possível excluir supervisor.");
        });
    };
  }, 0);
}
window.editarSupervisor = editarSupervisor;

/* ========= COLABORADORES ========= */
function carregarColaboradores(){
  return db.collection("colaboradores").get()
    .then(function(snap){
      cacheColabs = snap.docs.map(function(d){
        const data = d.data() || {};
        const re = String(data.re || d.id || "").trim() || String(d.id||"").trim();
        return {
          id: d.id,
          re,
          nome: String(data.nome||"").trim(),
          cpf: String(data.cpf||"").trim(),
          ativo: (data.ativo !== false),
          escala: String(data.escala||"5x2"),
          horaEntrada: String(data.horaEntrada||"").trim(),
          horaSaida: String(data.horaSaida||"").trim(),
          dataAdmissao: String(data.dataAdmissao||data.admissao||"").slice(0,10),
          horariosSemana: (data.horariosSemana && typeof data.horariosSemana === "object") ? data.horariosSemana : {},
          plantaoHistorico: Array.isArray(data.plantaoHistorico) ? data.plantaoHistorico : [],
          updatedAt: String(data.updatedAt||"")
        };
      })
      .filter(c => !!c.re)
      .sort((a,b) => (a.re||"").localeCompare(b.re||""));

      montarColaboradores();
      return cacheColabs;
    })
    .catch(function(e){
      console.error("carregarColaboradores ERRO:", e);
      alert("Não foi possível carregar colaboradores.");
      cacheColabs = [];
      montarColaboradores();
    });
}
window.carregarColaboradores = carregarColaboradores;

function montarColaboradores(){
  const tbody = document.getElementById("tbodyColab");
  if (!tbody) return;
  tbody.innerHTML = "";

  const fr = norm(colabFiltroRe);
  const fn = norm(colabFiltroNome);

  let list = cacheColabs.slice();
  if (fr) list = list.filter(c => norm(c.re) === fr);
  if (fn) list = list.filter(c => norm(c.nome).includes(fn));

  list.sort((a,b) => String(a.nome||"").localeCompare(String(b.nome||"")));

  list.forEach(function(c){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.re}</td>
      <td>${c.nome || ""}</td>
      <td>${c.cpf || ""}</td>
      <td>${c.escala || ""}</td>
      <td>${horarioTxt(c)}</td>
      <td>${c.dataAdmissao ? brDateFromYmd(c.dataAdmissao) : ""}</td>
      <td>${c.ativo ? "ATIVO" : "INATIVO"}</td>
      <td><button class="minBtn" onclick="editarColab('${c.id}')">Modificar</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function aplicarFiltroColab(){
  colabFiltroRe = (document.getElementById("colabBuscaRe").value || "").trim();
  colabFiltroNome = (document.getElementById("colabBuscaNome").value || "").trim();
  montarColaboradores();
}
window.aplicarFiltroColab = aplicarFiltroColab;

function limparFiltroColab(){
  colabFiltroRe = "";
  colabFiltroNome = "";
  document.getElementById("colabBuscaRe").value = "";
  document.getElementById("colabBuscaNome").value = "";
  montarColaboradores();
}
window.limparFiltroColab = limparFiltroColab;

function sanitizeCpf(v){
  return (v||"").toString().replace(/\D/g,"");
}
function cadastrarColab(){
  const re = (document.getElementById("cadRe").value || "").trim();
  const nome = (document.getElementById("cadNome").value || "").trim();
  const cpfRaw = (document.getElementById("cadCpf").value || "").trim();
  const cpf = sanitizeCpf(cpfRaw);
  const escala = (document.getElementById("cadEscala").value || "5x2");
  const horaEntrada = (document.getElementById("cadHoraEntrada").value || "").trim();
  const horaSaida = (document.getElementById("cadHoraSaida").value || "").trim();
  const dataAdmissao = (document.getElementById("cadAdmissao").value || "").trim();

  if (!re || !nome || !cpf){
    alert("Preencha RE, Nome e CPF (obrigatório).");
    return;
  }
  if (cpf.length < 11){
    alert("CPF inválido (precisa ter 11 dígitos).");
    return;
  }

  const payload = {
    re,
    nome,
    cpf,
    escala,
    horaEntrada,
    horaSaida,
    dataAdmissao: dataAdmissao || "",
    ativo: true,
    updatedAt: new Date().toISOString()
  };

  if (!confirm(`Cadastrar colaborador?\nRE: ${re}\nNome: ${nome}\nCPF: ${cpf}`)) return;

  db.collection("colaboradores").doc(re).set(payload, { merge:true })
    .then(function(){
      document.getElementById("cadRe").value="";
      document.getElementById("cadNome").value="";
      document.getElementById("cadCpf").value="";
      document.getElementById("cadHoraEntrada").value="";
      document.getElementById("cadHoraSaida").value="";
      document.getElementById("cadAdmissao").value="";
      carregarColaboradores();
      alert("✅ Colaborador cadastrado/atualizado.");
    })
    .catch(function(e){
      console.error("cadastrarColab ERRO:", e);
      alert("Não foi possível cadastrar colaborador.");
    });
}
window.cadastrarColab = cadastrarColab;

/* ========= MODIFICAR COLABORADOR ========= */
function editarColab(id){
  const c = cacheColabs.find(x => x.id===id);
  if (!c){ alert("Colaborador não encontrado."); return; }

  const escalaSel = `
    <select id="mcEscala">
      <option value="5x2" ${String(c.escala)==="5x2"?"selected":""}>5x2 (Seg-Sex)</option>
      <option value="6x1" ${String(c.escala)==="6x1"?"selected":""}>6x1 (Folga Dom)</option>
      <option value="12x36" ${normEscala(c.escala).includes("12")?"selected":""}>12x36 (1 trabalha / 1 folga)</option>
    </select>
  `;

  openModal({
    title: `Modificar Colaborador — RE ${c.re}`,
    bodyHtml: `
      <div class="grid">
        <div>
          <label>RE</label>
          <input value="${c.re}" disabled>
        </div>
        <div>
          <label>Status</label>
          <select id="mcAtivo">
            <option value="true" ${c.ativo ? "selected":""}>ATIVO</option>
            <option value="false" ${!c.ativo ? "selected":""}>INATIVO</option>
          </select>
        </div>

        <div style="grid-column:1 / -1">
          <label>Nome</label>
          <input id="mcNome" value="${String(c.nome||"").replaceAll('"','&quot;')}">
        </div>

        <div>
          <label>CPF</label>
          <input id="mcCpf" value="${String(c.cpf||"").replaceAll('"','&quot;')}">
          <div class="small" style="text-align:left;">(A senha do colaborador é os 4 primeiros dígitos do CPF)</div>
        </div>

        <div>
          <label>Escala</label>
          ${escalaSel}
        </div>

        <div>
          <label>Hora Entrada (informativo)</label>
          <input id="mcHE" type="time" value="${String(c.horaEntrada||"")}">
        </div>

        <div>
          <label>Hora Saída (informativo)</label>
          <input id="mcHS" type="time" value="${String(c.horaSaida||"")}">
        </div>

        <div style="grid-column:1 / -1">
          <label>Admissão</label>
          <input id="mcAdm" type="date" value="${String(c.dataAdmissao||"").slice(0,10)}">
        </div>

        <div class="small" style="grid-column:1 / -1">
          <div><b>Horários semana (opcional)</b>: se preencher, o RH usa isso para “Planejado”.</div>
          <div>Formato: Domingo=0 ... Sábado=6 (ex: 1: 08:00–17:48)</div>
        </div>

        <div style="grid-column:1 / -1">
          <label>Horários semana (JSON)</label>
          <input id="mcHSem" placeholder='Ex: {"1":{"in":"08:00","out":"17:48"},"2":{"in":"08:00","out":"17:48"}}'
                 value="${String(JSON.stringify(c.horariosSemana||{})).replaceAll('"','&quot;')}">
        </div>
      </div>
    `,
    onSave: function(){
      const nome = (document.getElementById("mcNome").value || "").trim();
      const cpf = sanitizeCpf((document.getElementById("mcCpf").value || "").trim());
      const escala = (document.getElementById("mcEscala").value || "5x2").trim();
      const horaEntrada = (document.getElementById("mcHE").value || "").trim();
      const horaSaida = (document.getElementById("mcHS").value || "").trim();
      const dataAdmissao = (document.getElementById("mcAdm").value || "").trim();
      const ativo = (document.getElementById("mcAtivo").value === "true");
      const hsemTxt = (document.getElementById("mcHSem").value || "").trim();

      if (!nome){ alert("Nome não pode ficar vazio."); return; }
      if (!cpf || cpf.length < 11){ alert("CPF inválido (11 dígitos)."); return; }

      let horariosSemana = {};
      if (hsemTxt){
        try{
          horariosSemana = JSON.parse(hsemTxt);
          if (horariosSemana && typeof horariosSemana !== "object") throw new Error("inválido");
        }catch{
          alert("Horários semana (JSON) inválido.");
          return;
        }
      }

      if (!confirm("Salvar alterações do colaborador?")) return;

      db.collection("colaboradores").doc(c.re).set({
        nome,
        cpf,
        escala,
        horaEntrada,
        horaSaida,
        dataAdmissao: dataAdmissao || "",
        ativo,
        horariosSemana,
        updatedAt: new Date().toISOString()
      }, { merge:true })
      .then(function(){
        closeModal();
        carregarColaboradores();
      })
      .catch(function(e){
        console.error("editarColab ERRO:", e);
        alert("Não foi possível salvar colaborador.");
      });
    }
  });
}
window.editarColab = editarColab;

/* ========= JORNADAS ========= */
function buscar(){
  const iniStr = document.getElementById("inicio").value || "2000-01-01";
  const fimStr = document.getElementById("fim").value || "2999-12-31";
  const filtroRe = norm(document.getElementById("filtroRe").value);
  const filtroNome = norm(document.getElementById("filtroNome").value);

  db.collection("jornadas").get()
    .then(function(snap){
      let jornadas = snap.docs.map(function(d){
        return Object.assign({ id:d.id }, d.data() || {});
      });

      jornadas = jornadas.filter(function(j){
        const iso = (j && j.entrada && j.entrada.ts ? String(j.entrada.ts) : "");
        const d = iso ? iso.slice(0,10) : "";
        if (!d) return false;
        return d >= iniStr && d <= fimStr;
      });

      if (filtroRe) jornadas = jornadas.filter(function(j){ return norm(j.re) === filtroRe; });
      if (filtroNome) jornadas = jornadas.filter(function(j){ return norm(j.nome).includes(filtroNome); });

      jornadas.sort(function(a,b){
        const da = toDateAny(a && a.entrada ? a.entrada.ts : null) || new Date(0);
        const dbb= toDateAny(b && b.entrada ? b.entrada.ts : null) || new Date(0);
        return dbb - da;
      });

      ultimaTabela = jornadas;
      montarJornadas(jornadas);
    })
    .catch(function(e){
      console.error("buscar jornadas ERRO:", e);
      alert("Não foi possível buscar jornadas.");
    });
}
window.buscar = buscar;

function montarJornadas(jornadas){
  const tbody=document.getElementById("tbodyJornadas");
  if (!tbody) return;
  tbody.innerHTML="";

  (jornadas||[]).forEach(function(j){
    const dataEntrada = formatBRDate(j && j.entrada ? j.entrada.ts : null);
    const loc = getBestLocationFromJornada(j);
    const rec = reconhecerLocal(loc);

    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${dataEntrada}</td>
      <td>${j.nome || ""}</td>
      <td>${j.re || ""}</td>
      <td>${formatHHMM(j && j.entrada ? j.entrada.ts : null)}</td>
      <td>${formatHHMM(j && j.saida_intervalo ? j.saida_intervalo.ts : null)}</td>
      <td>${formatHHMM(j && j.retorno_intervalo ? j.retorno_intervalo.ts : null)}</td>
      <td>${formatHHMM(j && j.saida ? j.saida.ts : null)}</td>
      <td>${formatHHMM(j && j.entrada_he ? j.entrada_he.ts : null)}</td>
      <td>${formatHHMM(j && j.saida_he ? j.saida_he.ts : null)}</td>
      <td>${loc || ""}</td>
      <td>${rec}</td>
      <td><button class="minBtn" onclick="editarJornada('${j.id}')">Modificar</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function editarJornada(docId){
  const j = ultimaTabela.find(function(x){ return x.id === docId; });
  if (!j){ alert("Jornada não encontrada."); return; }

  const val = function(ts){ return brDateTimeFromIso(ts); };

  openModal({
    title: `Modificar Jornada — RE ${j.re}`,
    bodyHtml: `
      <div class="grid">
        <div><label>ENTRADA</label><input id="fEntrada" placeholder="DD/MM/AAAA HH:MM" value="${val(j.entrada && j.entrada.ts)}"></div>
        <div><label>INÍCIO INTERVALO</label><input id="fSaiInt" placeholder="DD/MM/AAAA HH:MM" value="${val(j.saida_intervalo && j.saida_intervalo.ts)}"></div>
        <div><label>FIM INTERVALO</label><input id="fRetInt" placeholder="DD/MM/AAAA HH:MM" value="${val(j.retorno_intervalo && j.retorno_intervalo.ts)}"></div>
        <div><label>SAÍDA</label><input id="fSaida" placeholder="DD/MM/AAAA HH:MM" value="${val(j.saida && j.saida.ts)}"></div>
        <div><label>ENTRADA HE</label><input id="fEntHe" placeholder="DD/MM/AAAA HH:MM" value="${val(j.entrada_he && j.entrada_he.ts)}"></div>
        <div><label>SAÍDA HE</label><input id="fSaiHe" placeholder="DD/MM/AAAA HH:MM" value="${val(j.saida_he && j.saida_he.ts)}"></div>
      </div>
      <div class="small" style="margin-top:8px">Deixe em branco para remover o campo.</div>
      <div class="small" style="margin-top:6px;color:#a10000;">
        ✅ Permitido remover ENTRADA (isso apagará a jornada inteira para não quebrar relatórios).
      </div>
      <div class="small" style="margin-top:6px;">
        ✅ Turno noturno permitido (saída pode ser no dia seguinte), mas <b>SAÍDA nunca pode ser anterior à ENTRADA</b>.
      </div>
    `,
    onSave: function(){
      const campos = [
        ["entrada.ts", (document.getElementById("fEntrada").value || "")],
        ["saida_intervalo.ts", (document.getElementById("fSaiInt").value || "")],
        ["retorno_intervalo.ts", (document.getElementById("fRetInt").value || "")],
        ["saida.ts", (document.getElementById("fSaida").value || "")],
        ["entrada_he.ts", (document.getElementById("fEntHe").value || "")],
        ["saida_he.ts", (document.getElementById("fSaiHe").value || "")],
      ];

      const payload = { updatedAt: new Date().toISOString() };
      let newEntradaIso = null;

      // Guardar novos valores para validação antes do update
      let tmp = {
        entrada: null,
        saida_intervalo: null,
        retorno_intervalo: null,
        saida: null,
        entrada_he: null,
        saida_he: null
      };

      for (let i=0;i<campos.length;i++){
        const path = campos[i][0];
        const txt = String(campos[i][1]||"").trim();

        if (!txt){
          payload[path] = firebase.firestore.FieldValue.delete();
          continue;
        }

        const iso = isoFromBrDateTime(txt);
        if (!iso){
          alert("Formato inválido. Use DD/MM/AAAA HH:MM");
          return;
        }

        payload[path] = iso;

        if (path === "entrada.ts") newEntradaIso = iso;

        if (path === "entrada.ts") tmp.entrada = iso;
        if (path === "saida_intervalo.ts") tmp.saida_intervalo = iso;
        if (path === "retorno_intervalo.ts") tmp.retorno_intervalo = iso;
        if (path === "saida.ts") tmp.saida = iso;
        if (path === "entrada_he.ts") tmp.entrada_he = iso;
        if (path === "saida_he.ts") tmp.saida_he = iso;
      }

      if (!newEntradaIso){
        const ok = confirm(
          "⚠️ Você removeu a ENTRADA.\n\n" +
          "Para não quebrar relatórios e buscas (que dependem da ENTRADA), " +
          "esta ação vai APAGAR a jornada inteira.\n\n" +
          "Confirmar exclusão?"
        );
        if (!ok) return;

        db.collection("jornadas").doc(docId).delete()
          .then(function(){
            closeModal();
            buscar();
            alert("✅ Jornada apagada (ENTRADA removida).");
          })
          .catch(function(e){
            console.error("delete jornada ERRO:", e);
            alert("Não foi possível apagar a jornada.");
          });
        return;
      }

      // ===== VALIDAÇÕES IMPORTANTES =====
      // 1) Saída não pode ser anterior à entrada (mesmo permitindo virar o dia)
      const entIso = tmp.entrada;
      const saiIso = tmp.saida;
      if (entIso && saiIso){
        const entD = toDateAny(entIso);
        const saiD = toDateAny(saiIso);
        if (entD && saiD && !isNaN(entD) && !isNaN(saiD) && (saiD < entD)){
          alert("❌ SAÍDA não pode ser anterior à ENTRADA.");
          return;
        }
      }

      // 2) Ordem do intervalo (se existir)
      if (tmp.saida_intervalo && tmp.retorno_intervalo){
        const a = toDateAny(tmp.saida_intervalo);
        const b = toDateAny(tmp.retorno_intervalo);
        if (a && b && !isNaN(a) && !isNaN(b) && (b < a)){
          alert("❌ Fim do intervalo não pode ser anterior ao início do intervalo.");
          return;
        }
      }

      // 3) (Opcional, mas ajuda) Intervalo dentro de entrada->saída
      if (entIso && tmp.saida_intervalo){
        if (!ensureNotBefore("Início do intervalo", entIso, tmp.saida_intervalo)) return;
      }
      if (tmp.saida_intervalo && tmp.retorno_intervalo){
        if (!ensureNotBefore("Fim do intervalo", tmp.saida_intervalo, tmp.retorno_intervalo)) return;
      }
      if (tmp.retorno_intervalo && saiIso){
        if (!ensureNotBefore("Saída", tmp.retorno_intervalo, saiIso)) return;
      } else if (tmp.saida_intervalo && saiIso){
        if (!ensureNotBefore("Saída", tmp.saida_intervalo, saiIso)) return;
      }

      // 4) HE: saída HE não pode ser anterior à entrada HE
      if (tmp.entrada_he && tmp.saida_he){
        const a = toDateAny(tmp.entrada_he);
        const b = toDateAny(tmp.saida_he);
        if (a && b && !isNaN(a) && !isNaN(b) && (b < a)){
          alert("❌ Saída HE não pode ser anterior à entrada HE.");
          return;
        }
      }
      // ================================

      const newDay = String(newEntradaIso).slice(0,10);
      const re = String(j.re || "").trim();

      db.collection("jornadas").where("re","==",re).get()
        .then(function(snap){
          const all = snap.docs.map(function(d){ return Object.assign({ id:d.id }, d.data()||{}); });
          const duplicates = all.filter(function(x){
            if (x.id === docId) return false;
            const k = String(x && x.entrada && x.entrada.ts ? x.entrada.ts : "").slice(0,10);
            return k === newDay;
          });

          if (duplicates.length > 0){
            alert("❌ Já existe uma ENTRADA registrada para este RE nesse mesmo dia.\nAltere a data/hora da ENTRADA.");
            return Promise.reject();
          }

          if (!confirm("Salvar alterações desta jornada?")) return Promise.reject();

          return db.collection("jornadas").doc(docId).update(payload);
        })
        .then(function(){
          closeModal();
          buscar();
        })
        .catch(function(e){
          if (e) console.warn("editarJornada cancel/erro:", e);
        });
    }
  });
}
window.editarJornada = editarJornada;

/* ========= EXPORT CSV (JORNADAS) ========= */
function exportar(){
  let csv = "DataEntrada,Nome,RE,Entrada,InicioIntervalo,FimIntervalo,Saida,EntradaHE,SaidaHE,Coords,Local\n";
  (ultimaTabela||[]).forEach(function(j){
    const loc = getBestLocationFromJornada(j);
    const rec = reconhecerLocal(loc);
    const linha = [
      formatBRDate(j && j.entrada ? j.entrada.ts : null),
      j.nome || "",
      j.re || "",
      formatHHMM(j && j.entrada ? j.entrada.ts : null),
      formatHHMM(j && j.saida_intervalo ? j.saida_intervalo.ts : null),
      formatHHMM(j && j.retorno_intervalo ? j.retorno_intervalo.ts : null),
      formatHHMM(j && j.saida ? j.saida.ts : null),
      formatHHMM(j && j.entrada_he ? j.entrada_he.ts : null),
      formatHHMM(j && j.saida_he ? j.saida_he.ts : null),
      loc || "",
      rec || ""
    ].map(function(v){ return `"${String(v).replaceAll('"','""')}"`; }).join(",");
    csv += linha + "\n";
  });

  const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "jornadas.csv";
  a.click();
}
window.exportar = exportar;

/* ========= OCORRÊNCIAS ========= */
function ocDocId(re, ymdKey){ return re + "_" + ymdKey; }
function nomePorRe(re){
  const c = cacheColabs.find(function(x){ return (x.re || x.id) === re; });
  return c && c.nome ? c.nome : "";
}

function apagarJornadasDoDia(re, dataYmd){
  return db.collection("jornadas").where("re","==",re).get()
    .then(function(snap){
      const all = snap.docs.map(function(d){ return Object.assign({ id:d.id }, d.data()||{}); });
      const doDia = all.filter(function(j){
        const k = String(j && j.entrada && j.entrada.ts ? j.entrada.ts : "").slice(0,10);
        return k === dataYmd;
      });

      const proms = doDia.map(function(j){
        return db.collection("jornadas").doc(j.id).delete();
      });

      return Promise.all(proms).then(function(){ return doDia.length; });
    });
}

function salvarOcorrencia(){
  const re = (document.getElementById("ocRe").value || "").trim();
  const data = document.getElementById("ocData").value;
  const tipo = document.getElementById("ocTipo").value;
  const motivo = (document.getElementById("ocMotivo").value || "").trim();

  if (!re){ alert("Informe o RE."); return; }
  if (!data){ alert("Informe a data."); return; }

  if (!confirm(`Salvar ocorrência?\nRE: ${re}\nData: ${brDateFromYmd(data)}\nTipo: ${tipo.toUpperCase()}\n\nIsso vai APAGAR registros do dia (se existirem).`)) return;

  db.collection("ocorrencias").doc(ocDocId(re, data)).set({
    re, data, tipo, motivo,
    status: "pendente",
    updatedAt: new Date().toISOString()
  }, { merge:true })
  .then(function(){
    return apagarJornadasDoDia(re, data);
  })
  .then(function(n){
    alert(`Ocorrência salva.\nRegistros apagados do dia: ${n}`);
    document.getElementById("ocMotivo").value = "";
    document.getElementById("ocFiltroRe").value = re;
    document.getElementById("ocFiltroData").value = data;
    return carregarOcorrencias();
  })
  .catch(function(){
    alert("Falha ao salvar ocorrência.");
  });
}
window.salvarOcorrencia = salvarOcorrencia;

function carregarOcorrencias(){
  const filtroRe = (document.getElementById("ocFiltroRe").value || "").trim();
  const filtroData = document.getElementById("ocFiltroData").value;

  return db.collection("ocorrencias").get()
    .then(function(snap){
      let list = snap.docs.map(function(d){ return Object.assign({ id:d.id }, d.data()||{}); });

      list = list.map(function(o){
        return {
          id:o.id,
          re: String(o.re||"").trim(),
          data: String(o.data||"").slice(0,10),
          tipo: String(o.tipo||""),
          motivo: String(o.motivo||""),
          status: String(o.status||""),
          updatedAt: String(o.updatedAt||"")
        };
      });

      if (filtroRe) list = list.filter(function(o){ return o.re === filtroRe; });
      if (filtroData) list = list.filter(function(o){ return o.data === filtroData; });

      list.sort(function(a,b){
        const c1 = String(b.data||"").localeCompare(String(a.data||""));
        if (c1!==0) return c1;
        return String(b.updatedAt||"").localeCompare(String(a.updatedAt||""));
      });

      cacheOcorr = list;

      const tbody = document.getElementById("tbodyOcorr");
      if (!tbody) return;

      tbody.innerHTML = "";
      cacheOcorr.forEach(function(o){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${brDateFromYmd(o.data||"")}</td>
          <td>${o.re || ""}</td>
          <td>${nomePorRe(o.re)}</td>
          <td>${(o.tipo||"").toUpperCase()}</td>
          <td>${o.motivo || ""}</td>
          <td>${brDateTimeFromIso(o.updatedAt)}</td>
          <td><button class="minBtn" onclick="editarOcorrencia('${o.id}')">Modificar</button></td>
        `;
        tbody.appendChild(tr);
      });
    })
    .catch(function(){
      alert("Falha ao carregar ocorrências.");
    });
}
window.carregarOcorrencias = carregarOcorrencias;

function editarOcorrencia(id){
  const o = cacheOcorr.find(function(x){ return x.id === id; });
  if (!o){ alert("Ocorrência não encontrada."); return; }

  openModal({
    title: `Modificar Ocorrência — ${o.re} — ${brDateFromYmd(o.data)}`,
    bodyHtml: `
      <div class="grid">
        <div><label>RE</label><input value="${o.re}" disabled></div>
        <div><label>Data</label><input value="${o.data}" disabled></div>
        <div>
          <label>Tipo</label>
          <select id="moTipo">
            <option value="falta" ${o.tipo==="falta" ? "selected" : ""}>FALTA</option>
            <option value="atestado" ${o.tipo==="atestado" ? "selected" : ""}>ATESTADO</option>
            <option value="abono" ${o.tipo==="abono" ? "selected" : ""}>ABONO</option>
          </select>
        </div>
        <div><label>Motivo</label><input id="moMotivo" value="${(o.motivo||"").replaceAll('"','&quot;')}"></div>
        <div>
          <label>Status</label>
          <select id="moStatus">
            <option value="pendente" ${(o.status||"pendente")==="pendente"?"selected":""}>PENDENTE</option>
            <option value="analisado" ${(o.status||"")==="analisado"?"selected":""}>ANALISADO</option>
          </select>
        </div>
        <div class="small" style="grid-column:1 / -1">
          <button class="btnDangerInline" id="btnExcluirOcorr">Excluir ocorrência</button>
        </div>
      </div>
    `,
    onSave: function(){
      const tipo = document.getElementById("moTipo").value;
      const motivo = (document.getElementById("moMotivo").value || "").trim();
      const status = (document.getElementById("moStatus").value || "pendente").trim();
      if (!confirm("Salvar alteração desta ocorrência?")) return;

      db.collection("ocorrencias").doc(id).update({ tipo, motivo, status, updatedAt: new Date().toISOString() })
        .then(function(){
          closeModal();
          carregarOcorrencias();
        })
        .catch(function(){
          alert("Não foi possível salvar a ocorrência.");
        });
    }
  });

  setTimeout(function(){
    const btn = document.getElementById("btnExcluirOcorr");
    if (!btn) return;
    btn.onclick = function(){
      if (!confirm("Excluir esta ocorrência?")) return;
      db.collection("ocorrencias").doc(id).delete()
        .then(function(){
          closeModal();
          carregarOcorrencias();
        })
        .catch(function(){
          alert("Não foi possível excluir a ocorrência.");
        });
    };
  }, 0);
}
window.editarOcorrencia = editarOcorrencia;

/* ========= FÉRIAS ========= */
function getColab(re){
  return db.collection("colaboradores").doc(re).get()
    .then(function(snap){
      if (!snap.exists) return null;
      return Object.assign({ id:snap.id }, snap.data()||{});
    });
}
function rangeDays(iniYmd, fimYmd){
  const out = [];
  const a = iniYmd.split("-").map(Number);
  const b = fimYmd.split("-").map(Number);
  let cur = new Date(a[0], a[1]-1, a[2], 12, 0, 0);
  const end = new Date(b[0], b[1]-1, b[2], 12, 0, 0);
  while (cur <= end){
    out.push(new Date(cur));
    cur.setDate(cur.getDate()+1);
  }
  return out;
}
function apagarJornadasNoPeriodo(re, iniYmd, fimYmd, escala, somenteDiasTrabalho, plantaoHistorico){
  return db.collection("jornadas").where("re","==",re).get()
    .then(function(snap){
      const all = snap.docs.map(function(d){ return Object.assign({ id:d.id }, d.data()||{}); });

      const days = rangeDays(iniYmd, fimYmd);
      const alvo = new Set();

      days.forEach(function(dt){
        const dayKey = dt.toISOString().slice(0,10);
        if (somenteDiasTrabalho){
          if (!isDiaTrabalho(dt, escala, plantaoHistorico)) return;
        }
        alvo.add(dayKey);
      });

      const apagar = all.filter(function(j){
        const k = String(j && j.entrada && j.entrada.ts ? j.entrada.ts : "").slice(0,10);
        return alvo.has(k);
      });

      const proms = apagar.map(function(j){
        return db.collection("jornadas").doc(j.id).delete();
      });

      return Promise.all(proms).then(function(){ return apagar.length; });
    });
}

function salvarFerias(){
  const re = (document.getElementById("afRe").value || "").trim();
  const inicio = document.getElementById("afInicio").value;
  const fim = document.getElementById("afFim").value;
  const aplicarSomenteDiasTrabalho = document.getElementById("afDiasUteis").checked;
  const motivo = (document.getElementById("afMotivo").value || "").trim();

  if (!re){ alert("Informe o RE."); return; }
  if (!inicio || !fim){ alert("Informe início e fim."); return; }
  if (fim < inicio){ alert("Fim não pode ser menor que início."); return; }

  getColab(re).then(function(col){
    if (!col){ alert("Colaborador não encontrado."); return; }

    const escala = (col.escala || "5x2");
    const plantaoHistorico = Array.isArray(col.plantaoHistorico) ? col.plantaoHistorico : [];

    if (!confirm(
      `Salvar FÉRIAS?\nRE: ${re}\nNome: ${col.nome||""}\nPeríodo: ${brDateFromYmd(inicio)} até ${brDateFromYmd(fim)}\nSomente dias de trabalho: ${aplicarSomenteDiasTrabalho ? "SIM" : "NÃO"}\n\nIsso vai APAGAR jornadas dentro do período.`
    )) return;

    db.collection("afastamentos").add({
      re, tipo:"ferias", inicio, fim,
      aplicarSomenteDiasTrabalho,
      motivo,
      createdAt:new Date().toISOString(),
      updatedAt:new Date().toISOString()
    })
    .then(function(){
      return apagarJornadasNoPeriodo(re, inicio, fim, escala, aplicarSomenteDiasTrabalho, plantaoHistorico);
    })
    .then(function(apagadas){
      alert(`Férias salvas.\nJornadas apagadas no período: ${apagadas}`);
      document.getElementById("afMotivo").value="";
      carregarFerias();
    })
    .catch(function(){
      alert("Não foi possível salvar férias.");
    });
  });
}
window.salvarFerias = salvarFerias;

function carregarFerias(){
  return db.collection("afastamentos").get()
    .then(function(snap){
      cacheFerias = snap.docs.map(function(d){
        return Object.assign({ id:d.id }, d.data()||{});
      })
      .filter(function(x){
        return String(x.tipo||"").toLowerCase() === "ferias";
      })
      .sort(function(a,b){
        return String(b.inicio||"").localeCompare(String(a.inicio||""));
      });

      const tbody = document.getElementById("tbodyFerias");
      if (!tbody) return;

      tbody.innerHTML="";
      cacheFerias.forEach(function(f){
        const col = cacheColabs.find(function(c){ return (c.re||c.id) === f.re; }) || null;
        const nome = col && col.nome ? col.nome : "";
        const periodo = `${brDateFromYmd(String(f.inicio||"").slice(0,10))} até ${brDateFromYmd(String(f.fim||"").slice(0,10))}`;
        const du = (f.aplicarSomenteDiasTrabalho === true) ? "SIM" : "NÃO";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${f.re || ""}</td>
          <td>${nome}</td>
          <td>${periodo}</td>
          <td>${du}</td>
          <td>${(f.motivo||"")}</td>
          <td><button class="minBtn" onclick="editarFerias('${f.id}')">Modificar</button></td>
        `;
        tbody.appendChild(tr);
      });
    })
    .catch(function(){
      alert("Não foi possível carregar férias.");
    });
}
window.carregarFerias = carregarFerias;

function editarFerias(id){
  const f = cacheFerias.find(function(x){ return x.id === id; });
  if (!f){ alert("Férias não encontradas."); return; }

  openModal({
    title: `Modificar Férias — RE ${f.re}`,
    bodyHtml: `
      <div class="grid">
        <div><label>RE</label><input value="${f.re||""}" disabled></div>
        <div><label>Tipo</label><input value="FÉRIAS" disabled></div>
        <div><label>Início</label><input id="mfInicio" type="date" value="${String(f.inicio||"").slice(0,10)}"></div>
        <div><label>Fim</label><input id="mfFim" type="date" value="${String(f.fim||"").slice(0,10)}"></div>
        <div style="grid-column:1 / -1">
          <label style="display:flex;align-items:center;gap:8px;">
            <input id="mfDiasUteis" type="checkbox" ${f.aplicarSomenteDiasTrabalho===true ? "checked" : ""}>
            Somente dias de trabalho
          </label>
        </div>
        <div style="grid-column:1 / -1">
          <label>Motivo</label>
          <input id="mfMotivo" value="${String(f.motivo||"").replaceAll('"','&quot;')}">
        </div>
        <div class="small" style="grid-column:1 / -1">
          <button class="btnDangerInline" id="btnExcluirFerias">Excluir período de férias</button>
        </div>
      </div>
    `,
    onSave: function(){
      const ini = document.getElementById("mfInicio").value;
      const fim = document.getElementById("mfFim").value;
      const du = document.getElementById("mfDiasUteis").checked;
      const motivo = (document.getElementById("mfMotivo").value || "").trim();

      if (!ini || !fim){ alert("Informe início e fim."); return; }
      if (fim < ini){ alert("Fim não pode ser menor que início."); return; }
      if (!confirm("Salvar alteração do período de férias?")) return;

      db.collection("afastamentos").doc(id).update({
        inicio: ini, fim: fim, aplicarSomenteDiasTrabalho: du, motivo,
        updatedAt: new Date().toISOString()
      })
      .then(function(){
        closeModal();
        carregarFerias();
      })
      .catch(function(){
        alert("Não foi possível salvar as férias.");
      });
    }
  });

  setTimeout(function(){
    const btn = document.getElementById("btnExcluirFerias");
    if (!btn) return;
    btn.onclick = function(){
      if (!confirm("Excluir este período de férias?")) return;
      db.collection("afastamentos").doc(id).delete()
        .then(function(){
          closeModal();
          carregarFerias();
        })
        .catch(function(){
          alert("Não foi possível excluir as férias.");
        });
    };
  }, 0);
}
window.editarFerias = editarFerias;

/* ========= PLANTÕES 12x36 ========= */
function syncPlantaoHistoricoToColaborador(re){
  return db.collection("plantoes12x36").where("re","==",re).get()
    .then(function(snap){
      let list = snap.docs.map(function(d){ return Object.assign({ id:d.id }, d.data()||{}); });
      list.sort(function(a,b){
        return String(a.vigencia||"").localeCompare(String(b.vigencia||""));
      });

      const historico = list.map(function(p){
        return {
          inicio: String(p.vigencia||"").slice(0,10),
          base: String(p.base||"trabalha").toLowerCase(),
          obs: String(p.obs||""),
          updatedAt: String(p.updatedAt||"")
        };
      }).filter(function(p){
        return /^\d{4}-\d{2}-\d{2}$/.test(p.inicio);
      });

      return db.collection("colaboradores").doc(re).set({
        plantaoHistorico: historico,
        updatedAt: new Date().toISOString()
      }, { merge:true });
    });
}

function salvarPlantao12x36(){
  const re = (document.getElementById("plRe").value || "").trim();
  const vigencia = (document.getElementById("plVigencia").value || "").trim();
  const base = document.getElementById("plBase").value;
  const obs = (document.getElementById("plObs").value || "").trim();

  if (!re){ alert("Informe o RE."); return; }
  if (!vigencia){ alert("Informe a data de vigência."); return; }

  db.collection("colaboradores").doc(re).get()
    .then(function(colSnap){
      if (!colSnap.exists){ alert("Colaborador não encontrado. Cadastre na aba Colaboradores."); return Promise.reject(); }

      const col = colSnap.data() || {};
      const msg =
        `Salvar ajuste 12x36?\nRE: ${re}\nNome: ${col.nome||""}\nVigente a partir de: ${brDateFromYmd(vigencia)}\nBase: ${base.toUpperCase()}` +
        (obs ? `\nObs: ${obs}` : "");

      if (!confirm(msg)) return Promise.reject();

      return db.collection("plantoes12x36").add({ re, vigencia, base, obs, updatedAt: new Date().toISOString() });
    })
    .then(function(){
      return syncPlantaoHistoricoToColaborador(re);
    })
    .then(function(){
      document.getElementById("plObs").value = "";
      document.getElementById("plFiltroRe").value = re;
      alert("✅ Plantão 12x36 salvo.");
      return carregarPlantoes12x36();
    })
    .catch(function(){});
}
window.salvarPlantao12x36 = salvarPlantao12x36;

function carregarPlantoes12x36(){
  const filtroRe = (document.getElementById("plFiltroRe") && document.getElementById("plFiltroRe").value ? document.getElementById("plFiltroRe").value : "").trim();

  return db.collection("plantoes12x36").get()
    .then(function(snap){
      let list = snap.docs.map(function(d){ return Object.assign({ id:d.id }, d.data()||{}); });

      list = list.map(function(x){
        return {
          id:x.id,
          re: String(x.re||"").trim(),
          vigencia: String(x.vigencia||"").slice(0,10),
          base: String(x.base||""),
          obs: String(x.obs||""),
          updatedAt: String(x.updatedAt||"")
        };
      });

      if (filtroRe) list = list.filter(function(x){ return x.re === filtroRe; });

      list.sort(function(a,b){
        const c1 = String(b.vigencia||"").localeCompare(String(a.vigencia||""));
        if (c1!==0) return c1;
        return String(b.updatedAt||"").localeCompare(String(a.updatedAt||""));
      });

      cachePlantoes = list;

      const tbody = document.getElementById("tbodyPlantoes");
      if (!tbody) return;

      tbody.innerHTML="";
      cachePlantoes.forEach(function(p){
        const tr=document.createElement("tr");
        tr.innerHTML = `
          <td>${p.re}</td>
          <td>${nomePorRe(p.re)}</td>
          <td>${brDateFromYmd(p.vigencia)}</td>
          <td>${String(p.base||"").toUpperCase()}</td>
          <td>${p.obs || ""}</td>
          <td>${brDateTimeFromIso(p.updatedAt)}</td>
          <td><button class="minBtn" onclick="editarPlantao('${p.id}')">Modificar</button></td>
        `;
        tbody.appendChild(tr);
      });
    })
    .catch(function(){
      alert("Não foi possível carregar plantões 12x36.");
    });
}
window.carregarPlantoes12x36 = carregarPlantoes12x36;

function editarPlantao(id){
  const p = cachePlantoes.find(function(x){ return x.id === id; });
  if (!p){ alert("Plantão não encontrado."); return; }

  openModal({
    title: `Modificar 12x36 — RE ${p.re}`,
    bodyHtml: `
      <div class="grid">
        <div><label>RE</label><input value="${p.re}" disabled></div>
        <div><label>Nome</label><input value="${nomePorRe(p.re)}" disabled></div>
        <div><label>Vigência (a partir)</label><input id="mpVigencia" type="date" value="${String(p.vigencia||"").slice(0,10)}"></div>
        <div>
          <label>Base</label>
          <select id="mpBase">
            <option value="trabalha" ${String(p.base)==="trabalha" ? "selected" : ""}>TRABALHA</option>
            <option value="folga" ${String(p.base)==="folga" ? "selected" : ""}>FOLGA</option>
          </select>
        </div>
        <div style="grid-column:1 / -1">
          <label>Obs</label>
          <input id="mpObs" value="${String(p.obs||"").replaceAll('"','&quot;')}">
        </div>
        <div class="small" style="grid-column:1 / -1">
          <button class="btnDangerInline" id="btnExcluirPlantao">Excluir este registro</button>
        </div>
      </div>
    `,
    onSave: function(){
      const vig = (document.getElementById("mpVigencia").value || "").trim();
      const base = document.getElementById("mpBase").value;
      const obs = (document.getElementById("mpObs").value || "").trim();
      if (!vig){ alert("Informe a vigência."); return; }
      if (!confirm("Salvar alteração deste plantão 12x36?")) return;

      db.collection("plantoes12x36").doc(id).update({ vigencia: vig, base, obs, updatedAt: new Date().toISOString() })
        .then(function(){ return syncPlantaoHistoricoToColaborador(p.re); })
        .then(function(){
          closeModal();
          carregarPlantoes12x36();
        })
        .catch(function(){
          alert("Não foi possível salvar o plantão.");
        });
    }
  });

  setTimeout(function(){
    const btn = document.getElementById("btnExcluirPlantao");
    if (!btn) return;
    btn.onclick = function(){
      if (!confirm("Excluir este registro de plantão 12x36?")) return;
      db.collection("plantoes12x36").doc(id).delete()
        .then(function(){ return syncPlantaoHistoricoToColaborador(p.re); })
        .then(function(){
          closeModal();
          carregarPlantoes12x36();
        })
        .catch(function(){
          alert("Não foi possível excluir o plantão.");
        });
    };
  }, 0);
}
window.editarPlantao = editarPlantao;

/* ============================================
   EXPORTAÇÃO RH (XLSX) - ATIVOS
   FT separado de HE
============================================ */
function setRhStatus(msg){
  const el = document.getElementById("rhStatus");
  if (el) el.textContent = msg || "";
}
function minutesToHHMM(min){
  const m = Math.max(0, Math.round(min||0));
  const hh = Math.floor(m/60);
  const mm = m%60;
  return `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}`;
}
function parseHHMMToMinutes(h){
  const m = (h||"").trim().match(/^([01]\d|2[0-3]):([0-5]\d)$/);
  if (!m) return null;
  return Number(m[1])*60 + Number(m[2]);
}
function diffMinutes(a,b){
  const da = toDateAny(a);
  const dbb = toDateAny(b);
  if (!da || !dbb || isNaN(da) || isNaN(dbb)) return 0;
  return Math.round((dbb - da)/60000);
}
function getPlannedMinutesForDay(col, dateObj){
  const dow = dateObj.getDay();
  const hs = (col && col.horariosSemana) ? col.horariosSemana : {};
  const slot = hs ? hs[String(dow)] : null;
  if (slot && slot.in && slot.out){
    const i = parseHHMMToMinutes(slot.in);
    const o = parseHHMMToMinutes(slot.out);
    if (i != null && o != null) return (o >= i) ? (o - i) : (o + 24*60 - i);
  }
  const he = parseHHMMToMinutes(col && col.horaEntrada ? col.horaEntrada : "");
  const hs2= parseHHMMToMinutes(col && col.horaSaida ? col.horaSaida : "");
  if (he!=null && hs2!=null) return (hs2>=he) ? (hs2-he) : (hs2+24*60-he);
  return null;
}
function calcWorkedMinutesFromJornada(j){
  const ent = j && j.entrada ? j.entrada.ts : null;
  const sai = j && j.saida ? j.saida.ts : null;
  if (!ent || !sai) return { worked:0, intervalo:0, virou:false };

  const dEnt = toDateAny(ent);
  const dSai = toDateAny(sai);
  const virou = (dEnt && dSai) ? (ymd(dEnt) !== ymd(dSai)) : false;

  let total = diffMinutes(ent, sai);
  let intervalo = 0;
  const si = j && j.saida_intervalo ? j.saida_intervalo.ts : null;
  const ri = j && j.retorno_intervalo ? j.retorno_intervalo.ts : null;
  if (si && ri) intervalo = Math.max(0, diffMinutes(si, ri));
  total = Math.max(0, total - intervalo);
  return { worked: total, intervalo: intervalo, virou: virou };
}
function calcHeMinutesFromJornada(j){
  const ehEnt = j && j.entrada_he ? j.entrada_he.ts : null;
  const ehSai = j && j.saida_he ? j.saida_he.ts : null;
  if (!ehEnt || !ehSai) return 0;
  return Math.max(0, diffMinutes(ehEnt, ehSai));
}
function monthDays(year, month1to12){
  const last = new Date(year, month1to12, 0).getDate();
  const out = [];
  for (let d=1; d<=last; d++) out.push(new Date(year, month1to12-1, d, 12, 0, 0));
  return out;
}
function findOcorrencia(re, ymdKey, ocorrenciasList){
  return (ocorrenciasList||[]).find(function(o){
    return o.re===re && String(o.data||"").slice(0,10)===ymdKey;
  }) || null;
}
function findFerias(re, ymdKey, dateObj, col, feriasList){
  const escala = (col && col.escala) ? col.escala : "5x2";
  const plantaoHistorico = (col && Array.isArray(col.plantaoHistorico)) ? col.plantaoHistorico : [];
  for (let i=0;i<(feriasList||[]).length;i++){
    const f = feriasList[i];
    if (f.re !== re) continue;
    const ini = String(f.inicio||"").slice(0,10);
    const fim = String(f.fim||"").slice(0,10);
    if (!ini || !fim) continue;
    if (!(ymdKey >= ini && ymdKey <= fim)) continue;
    const onlyWork = (f.aplicarSomenteDiasTrabalho === true);
    if (onlyWork){
      if (!isDiaTrabalho(dateObj, escala, plantaoHistorico)) continue;
    }
    return f;
  }
  return null;
}
function isBeforeAdmissao(col, ymdKey){
  const ad = String((col && col.dataAdmissao) ? col.dataAdmissao : "").slice(0,10);
  if (!/^\d{4}-\d{2}-\d{2}$/.test(ad)) return false;
  return ymdKey < ad;
}
function getScaleStatus(col, dateObj){
  const escala = (col && col.escala) ? col.escala : "5x2";
  const plantaoHistorico = (col && Array.isArray(col.plantaoHistorico)) ? col.plantaoHistorico : [];
  const folga = isFolgaByEscala(dateObj, escala, plantaoHistorico);
  return folga ? "FOLGA" : "TRABALHA";
}
function getJornadaOfDay(re, ymdKey, jornadasList){
  return (jornadasList||[]).find(function(j){
    return j.re===re && String(j && j.entrada && j.entrada.ts ? j.entrada.ts : "").slice(0,10)===ymdKey;
  }) || null;
}
function formatDayBR(ymdKey){ return brDateFromYmd(ymdKey); }

function exportarRHXLSX(){
  setRhStatus("Carregando dados...");

  const mes = Number(document.getElementById("rhMes").value);
  const ano = Number(document.getElementById("rhAno").value);
  const mes2 = pad2(mes);

  Promise.all([
    db.collection("colaboradores").get(),
    db.collection("jornadas").get(),
    db.collection("ocorrencias").get(),
    db.collection("afastamentos").get()
  ])
  .then(function(res){
    const snapCol = res[0], snapJor = res[1], snapOco = res[2], snapAfa = res[3];

    const colaboradores = snapCol.docs
      .map(function(d){ return Object.assign({ id:d.id }, d.data()||{}); })
      .filter(function(c){ return c.ativo !== false; })
      .sort(function(a,b){ return String(a.nome||"").localeCompare(String(b.nome||"")); });

    const jornadasAll = snapJor.docs.map(function(d){ return Object.assign({ id:d.id }, d.data()||{}); });
    const ocorrAll = snapOco.docs.map(function(d){ return Object.assign({ id:d.id }, d.data()||{}); });
    const feriasAll = snapAfa.docs.map(function(d){ return Object.assign({ id:d.id }, d.data()||{}); })
      .filter(function(x){ return String(x.tipo||"").toLowerCase() === "ferias"; });

    const jornadasMes = jornadasAll.filter(function(j){
      const ent = String(j && j.entrada && j.entrada.ts ? j.entrada.ts : "");
      if (!ent) return false;
      const d = toDateAny(ent);
      if (!d || isNaN(d)) return false;
      return d.getFullYear()===ano && (d.getMonth()+1)===mes;
    });

    setRhStatus("Montando XLSX...");

    const days = monthDays(ano, mes);

    const sheetResumo = [];
    const sheetDiario = [];
    const sheetEscala = [];

    sheetResumo.push([`RELATÓRIO RH — ${mes2}/${ano}`]);
    sheetResumo.push([
      "RE","Nome","CPF","Escala","Admissão",
      "Minutos Normais","Horas Normais",
      "Minutos HE","Horas HE",
      "Minutos FT","Horas FT",
      "Minutos Trabalhados Total","Horas Total",
      "Faltas","Atestados","Abonos","Férias","Folgas",
      "Dias Trabalhados","Dias Planejados Trabalhar"
    ]);

    sheetDiario.push([`DIÁRIO — ${mes2}/${ano}`]);
    sheetDiario.push([
      "RE","Nome","Data","Dia",
      "Escala (dia)","Planejado (HH:MM)","Status",
      "Entrada","Saída","Intervalo (min)","Trabalhado (min)",
      "Normal (min)","HE (min)","FT (min)",
      "Entrada HE","Saída HE","HE (min) (campo HE)",
      "Posto","Obs"
    ]);

    sheetEscala.push([`ESCALA — ${mes2}/${ano}`]);
    sheetEscala.push([
      "RE","Nome","Data","Dia","Escala","Status (TRABALHA/FOLGA)","Planejado (HH:MM)"
    ]);

    colaboradores.forEach(function(col){
      const re = String(col.re || col.id || "").trim();
      if (!re) return;

      const nome = safeStr(col.nome);
      const cpf = safeStr(col.cpf);
      const escala = safeStr(col.escala || "5x2");
      const adm = safeStr(col.dataAdmissao||"").slice(0,10);

      let sumNormal = 0, sumHE = 0, sumFT = 0, sumTotal = 0;
      let qtdFalta = 0, qtdAtestado = 0, qtdAbono = 0, qtdFerias = 0, qtdFolga = 0;
      let diasTrabalhados = 0, diasPlanejadosTrabalhar = 0;

      days.forEach(function(dt){
        const ymdKey = ymd(dt);
        const diaAntesAdm = isBeforeAdmissao(col, ymdKey);
        const escalaDia = getScaleStatus(col, dt);
        const planejadoMin = getPlannedMinutesForDay(col, dt);
        const planejadoTxt = (planejadoMin==null) ? "" : minutesToHHMM(planejadoMin);

        sheetEscala.push([
          re, nome,
          formatDayBR(ymdKey),
          weekdayPtShort(dt),
          escala,
          diaAntesAdm ? "NÃO ADMITIDO" : escalaDia,
          planejadoTxt
        ]);

        if (diaAntesAdm) return;

        const isTrabalha = (escalaDia === "TRABALHA");
        if (isTrabalha) diasPlanejadosTrabalhar++;

        const fer = findFerias(re, ymdKey, dt, col, feriasAll);
        if (fer){
          qtdFerias++;
          sheetDiario.push([
            re,nome,formatDayBR(ymdKey),weekdayPtShort(dt),
            escalaDia, planejadoTxt, "FÉRIAS",
            "","","","",
            "","","",
            "","","",
            "", safeStr(fer.motivo||"")
          ]);
          return;
        }

        const oc = findOcorrencia(re, ymdKey, ocorrAll);
        if (oc){
          const t = String(oc.tipo||"").toLowerCase();
          if (t==="falta") qtdFalta++;
          if (t==="atestado") qtdAtestado++;
          if (t==="abono") qtdAbono++;
          sheetDiario.push([
            re,nome,formatDayBR(ymdKey),weekdayPtShort(dt),
            escalaDia, planejadoTxt, (t||"").toUpperCase(),
            "","","","",
            "","","",
            "","","",
            "", safeStr(oc.motivo||"")
          ]);
          return;
        }

        const j = getJornadaOfDay(re, ymdKey, jornadasMes);
        if (!j){
          if (!isTrabalha){
            qtdFolga++;
            sheetDiario.push([re,nome,formatDayBR(ymdKey),weekdayPtShort(dt),escalaDia,planejadoTxt,"FOLGA","","","","","", "","","","", "", ""]);
          } else {
            qtdFalta++;
            sheetDiario.push([re,nome,formatDayBR(ymdKey),weekdayPtShort(dt),escalaDia,planejadoTxt,"FALTA","","","","","", "","","","", "", ""]);
          }
          return;
        }

        const workedInfo = calcWorkedMinutesFromJornada(j);
        const heFieldMin = calcHeMinutesFromJornada(j);
        const worked = workedInfo.worked;
        const intervaloMin = workedInfo.intervalo;

        let normalMin = 0, heMin = 0, ftMin = 0;

        if (!isTrabalha){
          qtdFolga++;
          ftMin += worked;
        } else {
          if (planejadoMin == null) {
            normalMin += worked;
          } else {
            normalMin += Math.min(worked, planejadoMin);
            heMin    += Math.max(0, worked - planejadoMin);
          }
        }

        heMin += heFieldMin;

        sumNormal += normalMin;
        sumHE     += heMin;
        sumFT     += ftMin;
        sumTotal  += (worked + heFieldMin);

        if ((worked + heFieldMin) > 0) diasTrabalhados++;

        const posto = reconhecerLocal(getBestLocationFromJornada(j));
        const obs = [
          (workedInfo.virou ? "Virou o dia" : ""),
          (!j.saida || !j.saida.ts ? "Sem saída" : ""),
          (((j.saida_intervalo && j.saida_intervalo.ts) && (!j.retorno_intervalo || !j.retorno_intervalo.ts)) ||
           ((!j.saida_intervalo || !j.saida_intervalo.ts) && (j.retorno_intervalo && j.retorno_intervalo.ts)))
           ? "Intervalo incompleto" : ""
        ].filter(Boolean).join(" | ");

        const status = (!isTrabalha ? "FT" : "TRABALHOU");

        sheetDiario.push([
          re, nome,
          formatDayBR(ymdKey), weekdayPtShort(dt),
          escalaDia, planejadoTxt,
          status,
          formatHHMM(j.entrada && j.entrada.ts),
          formatHHMM(j.saida && j.saida.ts),
          intervaloMin,
          worked,
          normalMin,
          heMin,
          ftMin,
          formatHHMM(j.entrada_he && j.entrada_he.ts),
          formatHHMM(j.saida_he && j.saida_he.ts),
          heFieldMin,
          posto,
          obs
        ]);
      });

      sheetResumo.push([
        re, nome, cpf, escala,
        adm ? brDateFromYmd(adm) : "",
        sumNormal, minutesToHHMM(sumNormal),
        sumHE, minutesToHHMM(sumHE),
        sumFT, minutesToHHMM(sumFT),
        sumTotal, minutesToHHMM(sumTotal),
        qtdFalta, qtdAtestado, qtdAbono, qtdFerias, qtdFolga,
        diasTrabalhados, diasPlanejadosTrabalhar
      ]);
    });

    const wb = XLSX.utils.book_new();

    const wsResumo = XLSX.utils.aoa_to_sheet(sheetResumo);
    const wsDiario = XLSX.utils.aoa_to_sheet(sheetDiario);
    const wsEscala = XLSX.utils.aoa_to_sheet(sheetEscala);

    wsResumo["!merges"] = [{ s:{r:0,c:0}, e:{r:0,c:19} }];
    wsDiario["!merges"] = [{ s:{r:0,c:0}, e:{r:0,c:18} }];
    wsEscala["!merges"] = [{ s:{r:0,c:0}, e:{r:0,c:6} }];

    XLSX.utils.book_append_sheet(wb, wsResumo, "Resumo");
    XLSX.utils.book_append_sheet(wb, wsDiario, "Diario");
    XLSX.utils.book_append_sheet(wb, wsEscala, "Escala");

    const filename = `RH_${mes2}-${ano}.xlsx`;
    XLSX.writeFile(wb, filename);
    setRhStatus(`✅ Exportado: ${filename}`);
  })
  .catch(function(){
    setRhStatus("❌ Falha ao exportar.");
    alert("Falha ao exportar RH.");
  });
}
window.exportarRHXLSX = exportarRHXLSX;
</script>

</body>
</html>
