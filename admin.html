<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Admin</title>

<style>
body { font-family: Arial; background:#f5f5f5; text-align:center; }

.container {
    background:white;
    padding:20px;
    margin:20px auto;
    max-width:1000px;
    border-radius:10px;
}

.logo { width:280px; }

table {
    width:100%;
    border-collapse: collapse;
    margin-top:20px;
}

th, td {
    border:1px solid #ccc;
    padding:8px;
}
</style>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

// üî• SUA CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyD--zpWLbLg5X82oGTyz6SuPFQV0sd7NWc",
  authDomain: "controle-ponto-f539b.firebaseapp.com",
  projectId: "controle-ponto-f539b",
  storageBucket: "controle-ponto-f539b.firebasestorage.app",
  messagingSenderId: "324716100257",
  appId: "1:324716100257:web:32d49a9ab4916182dd4ee0",
  measurementId: "G-P81H3C4SFK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// login
window.login = async () => {
    const email = document.getElementById("email").value;
    const senha = document.getElementById("senha").value;

    try {
        await signInWithEmailAndPassword(auth, email, senha);
    } catch {
        alert("Erro login");
    }
};

// logout
window.logout = () => signOut(auth);

// prote√ß√£o
onAuthStateChanged(auth, user => {
    document.getElementById("login").style.display = user ? "none" : "block";
    document.getElementById("painel").style.display = user ? "block" : "none";
});

// buscar dados
window.buscar = async () => {

    const snap = await getDocs(collection(db, "pontos"));
    console.log("TOTAL DOCUMENTOS:", snap.size);
    
    const ini = new Date(document.getElementById("inicio").value);
    const fim = new Date(document.getElementById("fim").value);

    const snap = await getDocs(collection(db, "pontos"));

    let dados = [];

    snap.forEach(doc => {
        const d = doc.data();
        const t = new Date(d.timestamp);

        if (t >= ini && t <= fim) dados.push(d);
    });

    montar(dados);
};

// montar tabela
function montar(dados){

    const tbody = document.querySelector("tbody");
    tbody.innerHTML = "";

    const grupos = {};

    dados.forEach(d => {
        const key = d.re + d.fullName;
        if(!grupos[key]) grupos[key] = [];
        grupos[key].push(d);
    });

    for(const k in grupos){

        const r = grupos[k].sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));

        const tr = `
        <tr>
            <td>${r[0]?.fullName||""}</td>
            <td>${r[0]?.re||""}</td>
            <td>${f(r[0])}</td>
            <td>${f(r[1])}</td>
            <td>${f(r[2])}</td>
            <td>${f(r[3])}</td>
        </tr>`;

        tbody.innerHTML += tr;
    }
}

function f(d){
    return d ? new Date(d.timestamp).toLocaleString() : "";
}

// exportar CSV
window.exportar = () => {

    let csv = "Nome,RE,Entrada,Saida Intervalo,Retorno,Saida Final\n";

    document.querySelectorAll("tbody tr").forEach(tr => {
        const tds = tr.querySelectorAll("td");
        csv += Array.from(tds).map(td=>td.innerText).join(",")+"\n";
    });

    const blob = new Blob([csv]);
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "pontos.csv";
    a.click();
};

</script>

</head>

<body>

<div id="login" class="container">
    <img src="GW.png" class="logo">
    <h2>Login Admin</h2>
    <input id="email" placeholder="Email"><br>
    <input id="senha" type="password" placeholder="Senha"><br>
    <button onclick="login()">Entrar</button>
</div>

<div id="painel" class="container" style="display:none;">
    <img src="GW.png" class="logo">
    <h2>Painel</h2>

    <input type="date" id="inicio">
    <input type="date" id="fim">

    <br><br>

    <button onclick="buscar()">Buscar</button>
    <button onclick="exportar()">Exportar CSV</button>
    <button onclick="logout()">Sair</button>

    <table>
        <thead>
            <tr>
                <th>Nome</th>
                <th>RE</th>
                <th>Entrada</th>
                <th>Sa√≠da Intervalo</th>
                <th>Retorno</th>
                <th>Sa√≠da Final</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

</body>
</html>
