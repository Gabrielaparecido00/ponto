<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ponto Eletrônico</title>

<style>
body {
    font-family: Arial;
    text-align: center;
    background: #f5f5f5;
}

.container {
    margin-top: 50px;
}

input {
    padding: 10px;
    margin: 5px;
    width: 250px;
}

button {
    padding: 12px 20px;
    margin: 10px;
    cursor: pointer;
    border: none;
    background: #28a745;
    color: white;
    border-radius: 5px;
}

button:hover {
    background: #218838;
}

.logo {
    width: 260px;
    margin-bottom: 20px;
}

.footer {
    position: fixed;
    bottom: 10px;
    width: 100%;
}

.admin-link {
    font-size: 12px;
    color: gray;
    text-decoration: none;
}
</style>
</head>

<body>

<div class="container">

<img src="GW.png" class="logo">

<h2>Registro de Ponto</h2>

<input type="text" id="nome" placeholder="Nome Completo"><br>
<input type="text" id="re" placeholder="RE"><br>

<button onclick="registrar()">Registrar Ponto</button>

</div>

<div class="footer">
    <a href="admin.html" class="admin-link">.</a>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD--zpWLbLg5X82oGTyz6SuPFQV0sd7NWc",
  authDomain: "controle-ponto-f539b.firebaseapp.com",
  projectId: "controle-ponto-f539b",
  storageBucket: "controle-ponto-f539b.appspot.com",
  messagingSenderId: "324716100257",
  appId: "1:324716100257:web:32d49a9ab4916182dd4ee0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// CONFIG
const TEMPO_MINIMO = 5 * 60 * 1000;

const etapas = [
    { tipo: "entrada", label: "ENTRADA", confirm: "Você está entrando no serviço?" },
    { tipo: "saida_intervalo", label: "SAÍDA INTERVALO", confirm: "Você está saindo para intervalo?" },
    { tipo: "retorno_intervalo", label: "RETORNO INTERVALO", confirm: "Você está retornando do intervalo?" },
    { tipo: "saida", label: "SAÍDA", confirm: "Você está encerrando o expediente?" },
    { tipo: "entrada_he", label: "ENTRADA HE", confirm: "Você está iniciando hora extra?" },
    { tipo: "saida_he", label: "SAÍDA HE", confirm: "Você está finalizando hora extra?" }
];

function formatarData(data) {
    return data.toISOString().split('T')[0];
}

function formatarHora(data) {
    return data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
}

// REGISTRO
window.registrar = async function () {

    const nome = document.getElementById("nome").value.trim();
    const re = document.getElementById("re").value.trim();

    if (!nome || !re) {
        alert("Preencha nome e RE");
        return;
    }

    const agora = new Date();
    const hoje = formatarData(agora);

    // BUSCAR REGISTROS DO DIA
    const q = query(
        collection(db, "pontos"),
        where("re", "==", re),
        where("data", "==", hoje),
        orderBy("timestamp", "asc")
    );

    const snapshot = await getDocs(q);
    const registros = snapshot.docs.map(doc => doc.data());

    // BLOQUEIO DUPLICIDADE
    if (registros.length > 0) {
        const ultimo = registros[registros.length - 1];
        const ultimoTimestamp = ultimo.timestamp?.toDate?.() || new Date(ultimo.timestamp);

        if ((agora - ultimoTimestamp) < TEMPO_MINIMO) {
            alert("Aguarde 5 minutos para registrar novamente.");
            return;
        }
    }

    let etapaIndex = registros.length;

    if (etapaIndex >= etapas.length) {
        alert("Todos os pontos do dia já foram registrados.");
        return;
    }

    const etapa = etapas[etapaIndex];

    // CONFIRMAÇÃO
    if (!confirm(etapa.confirm)) return;

    // SALVAR
    await addDoc(collection(db, "pontos"), {
        nome,
        re,
        tipo: etapa.tipo,
        label: etapa.label,
        data: hoje,
        hora: formatarHora(agora),
        timestamp: agora
    });

    alert(etapa.label + " registrada!");
};

</script>

</body>
</html>
