import { getFirestore, collection, addDoc, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const db = getFirestore();

// CONFIG
const TEMPO_MINIMO = 5 * 60 * 1000; // 5 minutos

function formatarData(data) {
    return data.toISOString().split('T')[0];
}

function formatarHora(data) {
    return data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
}

// DEFINIÇÃO DAS ETAPAS
const etapas = [
    { tipo: "entrada", label: "ENTRADA", confirm: "Você está entrando no serviço?" },
    { tipo: "saida_intervalo", label: "SAÍDA INTERVALO", confirm: "Você está saindo para intervalo?" },
    { tipo: "retorno_intervalo", label: "RETORNO INTERVALO", confirm: "Você está retornando do intervalo?" },
    { tipo: "saida", label: "SAÍDA", confirm: "Você está encerrando o expediente?" },
    { tipo: "entrada_he", label: "ENTRADA HE", confirm: "Você está iniciando hora extra?" },
    { tipo: "saida_he", label: "SAÍDA HE", confirm: "Você está finalizando hora extra?" }
];

window.registrarPonto = async function () {

    const usuario = auth.currentUser;
    if (!usuario) {
        alert("Faça login primeiro!");
        return;
    }

    const agora = new Date();
    const hoje = formatarData(agora);

    // Buscar registros de hoje
    const q = query(
        collection(db, "pontos"),
        where("uid", "==", usuario.uid),
        where("data", "==", hoje),
        orderBy("timestamp", "asc")
    );

    const snapshot = await getDocs(q);
    const registros = snapshot.docs.map(doc => doc.data());

    // BLOQUEIO DE DUPLICIDADE (5 minutos)
    if (registros.length > 0) {
        const ultimo = registros[registros.length - 1];
        const ultimoTimestamp = ultimo.timestamp?.toDate();

        if (ultimoTimestamp && (agora - ultimoTimestamp < TEMPO_MINIMO)) {
            alert("Aguarde 5 minutos para registrar novamente.");
            return;
        }
    }

    // DEFINIR PRÓXIMA ETAPA
    let etapaIndex = registros.length;

    if (etapaIndex >= etapas.length) {
        alert("Todos os registros do dia já foram feitos.");
        return;
    }

    const etapa = etapas[etapaIndex];

    // CONFIRMAÇÃO
    const confirmar = confirm(etapa.confirm);

    if (!confirmar) return;

    // SALVAR NO FIREBASE
    await addDoc(collection(db, "pontos"), {
        uid: usuario.uid,
        email: usuario.email,
        tipo: etapa.tipo,
        label: etapa.label,
        data: hoje,
        hora: formatarHora(agora),
        timestamp: agora
    });

    alert(`${etapa.label} registrada com sucesso!`);
};
