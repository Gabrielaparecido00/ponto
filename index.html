<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel Admin</title>

<style>
body { font-family: Arial; background:#f5f5f5; text-align:center; }
.container { background:white; padding:20px; margin:20px auto; max-width:1200px; border-radius:10px; }
.logo { width:260px; margin-bottom: 10px; }

input, button { padding:10px; margin:5px; }
button { cursor:pointer; }

.row { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; align-items:center; margin-top:10px; }

table { width:100%; border-collapse:collapse; margin-top:18px; font-size:13px; }
th, td { border:1px solid #ccc; padding:8px; }
th { background:#fafafa; }

.editBtn { border:none; background:transparent; cursor:pointer; font-size:14px; }
.small { font-size: 12px; color:#666; }

.boxTitle { margin-top: 0; }
.hr { height:1px; background:#eee; margin:18px 0; border:0; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginDiv" class="container">
  <img src="GW.png" class="logo">
  <h2>Login Admin</h2>
  <input id="email" placeholder="Email"><br>
  <input id="senha" type="password" placeholder="Senha"><br>
  <button onclick="login()">Entrar</button>
</div>

<!-- PAINEL -->
<div id="painelDiv" class="container" style="display:none;">
  <img src="GW.png" class="logo">

  <h2 class="boxTitle">Painel Admin</h2>
  <div class="small">Cadastro de colaboradores + correção de registros</div>

  <hr class="hr">

  <!-- CADASTRO COLABORADOR -->
  <h3>Cadastro de Colaborador</h3>
  <div class="row">
    <input id="cadRe" placeholder="RE (docId)" inputmode="numeric">
    <input id="cadNome" placeholder="Nome completo">
    <button onclick="salvarColaborador()">Salvar / Atualizar</button>
  </div>
  <div class="small">Isso grava em <b>colaboradores</b> (docId = RE).</div>

  <hr class="hr">

  <!-- FILTROS -->
  <h3>Jornadas</h3>
  <div class="row">
    <label>De:</label>
    <input type="date" id="inicio">
    <label>Até:</label>
    <input type="date" id="fim">
    <input id="filtroRe" placeholder="Filtrar por RE (opcional)" inputmode="numeric">
    <input id="filtroNome" placeholder="Filtrar por Nome (opcional)">
    <button onclick="buscar()">Buscar</button>
    <button onclick="exportar()">Exportar CSV</button>
    <button onclick="logout()">Sair</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Data (Entrada)</th>
        <th>Nome</th>
        <th>RE</th>

        <th>ENTRADA</th>
        <th>SAÍDA INTERVALO</th>
        <th>RETORNO INTERVALO</th>
        <th>SAÍDA</th>
        <th>ENTRADA HE</th>
        <th>SAÍDA HE</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDocs, collection, query, where, updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyD--zpWLbLg5X82oGTyz6SuPFQV0sd7NWc",
  authDomain: "controle-ponto-f539b.firebaseapp.com",
  projectId: "controle-ponto-f539b",
  storageBucket: "controle-ponto-f539b.firebasestorage.app",
  messagingSenderId: "324716100257",
  appId: "1:324716100257:web:32d49a9ab4916182dd4ee0",
  measurementId: "G-P81H3C4SFK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const loginDiv = document.getElementById("loginDiv");
const painelDiv = document.getElementById("painelDiv");

window.login = async function() {
  const email = document.getElementById("email").value;
  const senha = document.getElementById("senha").value;
  try {
    await signInWithEmailAndPassword(auth, email, senha);
  } catch (e) {
    alert("Erro no login");
    console.error(e);
  }
};

window.logout = function() {
  signOut(auth);
};

onAuthStateChanged(auth, user => {
  loginDiv.style.display = user ? "none" : "block";
  painelDiv.style.display = user ? "block" : "none";
});

// ===== Helpers =====
function norm(s){ return (s||"").toString().trim().toLowerCase(); }
function toDateAny(ts){
  if (!ts) return null;
  if (ts.toDate) return ts.toDate();
  if (ts instanceof Date) return ts;
  return new Date(ts);
}
function formatHHMM(ts){
  const d = toDateAny(ts);
  if (!d || isNaN(d)) return "";
  return d.toLocaleTimeString("pt-BR", { hour:"2-digit", minute:"2-digit" });
}
function formatYYYYMMDD(ts){
  const d = toDateAny(ts);
  if (!d || isNaN(d)) return "";
  return d.toISOString().slice(0,10);
}

// ===== Cadastro Colaborador =====
window.salvarColaborador = async function(){
  const re = document.getElementById("cadRe").value.trim();
  const nome = document.getElementById("cadNome").value.trim();
  if (!re || !nome) return alert("Preencha RE e Nome.");

  if (!confirm(`Salvar/Atualizar colaborador?\nRE: ${re}\nNome: ${nome}`)) return;

  const ref = doc(db, "colaboradores", re);
  await setDoc(ref, {
    re,
    nome,
    ativo: true,
    updatedAt: new Date().toISOString()
  }, { merge: true });

  alert("Colaborador salvo!");
};

// ===== Buscar Jornadas =====
let ultimaTabela = []; // para export

window.buscar = async function(){
  const iniStr = document.getElementById("inicio").value || "2000-01-01";
  const fimStr = document.getElementById("fim").value || "2999-12-31";
  const filtroRe = norm(document.getElementById("filtroRe").value);
  const filtroNome = norm(document.getElementById("filtroNome").value);

  // sem index: busca tudo e filtra no JS
  const snap = await getDocs(collection(db, "jornadas"));
  let jornadas = snap.docs.map(d => ({ id: d.id, ...d.data() }));

  // filtra por data de ENTRADA (pela ts da entrada)
  jornadas = jornadas.filter(j => {
    const entradaDate = formatYYYYMMDD(j.entrada?.ts);
    if (!entradaDate) return false;
    return entradaDate >= iniStr && entradaDate <= fimStr;
  });

  if (filtroRe) {
    jornadas = jornadas.filter(j => norm(j.re) === filtroRe);
  }
  if (filtroNome) {
    jornadas = jornadas.filter(j => norm(j.nome).includes(filtroNome));
  }

  // ordena por entrada desc
  jornadas.sort((a,b) => (toDateAny(b.entrada?.ts) || new Date(0)) - (toDateAny(a.entrada?.ts) || new Date(0)));

  ultimaTabela = jornadas;
  montarTabela(jornadas);
};

function montarTabela(jornadas){
  const tbody = document.querySelector("tbody");
  tbody.innerHTML = "";

  for (const j of jornadas){
    const dataEntrada = formatYYYYMMDD(j.entrada?.ts);

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${dataEntrada}</td>
      <td>${j.nome || ""}</td>
      <td>${j.re || ""}</td>

      ${cellEdit(j.id, "entrada.ts", j.entrada?.ts)}
      ${cellEdit(j.id, "saida_intervalo.ts", j.saida_intervalo?.ts)}
      ${cellEdit(j.id, "retorno_intervalo.ts", j.retorno_intervalo?.ts)}
      ${cellEdit(j.id, "saida.ts", j.saida?.ts)}
      ${cellEdit(j.id, "entrada_he.ts", j.entrada_he?.ts)}
      ${cellEdit(j.id, "saida_he.ts", j.saida_he?.ts)}
    `;
    tbody.appendChild(row);
  }
}

function cellEdit(docId, path, ts){
  const v = formatHHMM(ts);
  // botão lápis chama editar(docId, path)
  return `
    <td>
      <span data-doc="${docId}" data-path="${path}">${v}</span>
      <button class="editBtn" onclick="editar('${docId}','${path}')">✏️</button>
    </td>
  `;
}

// ===== Editar campo (pede HH:MM e grava no DB mantendo a data da própria entrada) =====
window.editar = async function(docId, path){
  // pega a jornada atual do DOM (mais simples: buscar de ultimaTabela)
  const j = ultimaTabela.find(x => x.id === docId);
  if (!j) return alert("Jornada não encontrada.");

  const entradaDate = formatYYYYMMDD(j.entrada?.ts);
  if (!entradaDate) return alert("Jornada sem ENTRADA válida.");

  const atual = (() => {
    const parts = path.split(".");
    const bloco = parts[0]; // ex: "saida"
    return formatHHMM(j[bloco]?.ts);
  })();

  const novo = prompt(`Editar ${path}\nData base: ${entradaDate}\nDigite hora no formato HH:MM`, atual || "");
  if (novo === null) return;

  const m = novo.trim().match(/^([01]\d|2[0-3]):([0-5]\d)$/);
  if (!m) return alert("Hora inválida. Use HH:MM (ex: 07:15).");

  // monta ISO com a DATA DA ENTRADA + hora digitada
  const iso = new Date(`${entradaDate}T${m[1]}:${m[2]}:00`).toISOString();

  if (!confirm(`Confirmar alteração?\n${path} = ${entradaDate} ${novo}`)) return;

  // update no campo aninhado: ex "saida.ts"
  const ref = doc(db, "jornadas", docId);
  await updateDoc(ref, {
    [path]: iso,
    updatedAt: new Date().toISOString()
  });

  alert("Atualizado!");
  buscar(); // recarrega tabela
};

// ===== Exportar CSV =====
window.exportar = function(){
  let csv = "DataEntrada,Nome,RE,Entrada,SaidaIntervalo,RetornoIntervalo,Saida,EntradaHE,SaidaHE\n";

  for (const j of ultimaTabela){
    const dataEntrada = formatYYYYMMDD(j.entrada?.ts);
    const linha = [
      dataEntrada,
      j.nome || "",
      j.re || "",
      formatHHMM(j.entrada?.ts),
      formatHHMM(j.saida_intervalo?.ts),
      formatHHMM(j.retorno_intervalo?.ts),
      formatHHMM(j.saida?.ts),
      formatHHMM(j.entrada_he?.ts),
      formatHHMM(j.saida_he?.ts),
    ].map(v => `"${String(v).replaceAll('"','""')}"`).join(",");
    csv += linha + "\n";
  }

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "jornadas.csv";
  a.click();
};
</script>

</body>
</html>
