<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Registro de Ponto</title>

<style>
body {
    font-family: Arial;
    background: #f0f0f0;
    padding: 20px;
}

.container {
    max-width: 500px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 10px;
}

input, button {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
}

canvas {
    width: 100%;
    border: 1px solid #ccc;
}

.logo {
    width: 250px;
    display: block;
    margin: auto;
}
</style>
</head>

<body>

<div class="container">

<img src="GW.png" class="logo">

<h2>Registro de Ponto</h2>

<input type="text" id="nome" placeholder="Nome Completo">
<input type="text" id="re" placeholder="RE">

<canvas id="photo" width="240" height="320"></canvas>
<button id="captureBtn">Capturar Foto</button>

<button id="registrarBtn">Registrar Ponto</button>

<p id="hora"></p>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, addDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyD--zpWLbLg5X82oGTyz6SuPFQV0sd7NWc",
  authDomain: "controle-ponto-f539b.firebaseapp.com",
  projectId: "controle-ponto-f539b",
  storageBucket: "controle-ponto-f539b.appspot.com",
  messagingSenderId: "324716100257",
  appId: "1:324716100257:web:32d49a9ab4916182dd4ee0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// CAMERA
let stream;

navigator.mediaDevices.getUserMedia({ video: true })
.then(s => stream = s)
.catch(() => alert("Erro ao acessar câmera"));

document.getElementById("captureBtn").onclick = async () => {
    if (!stream) return alert("Câmera não iniciada");

    const videoTrack = stream.getVideoTracks()[0];
    const imageCapture = new ImageCapture(videoTrack);

    const bitmap = await imageCapture.grabFrame();
    const ctx = document.getElementById("photo").getContext("2d");
    ctx.drawImage(bitmap, 0, 0, 240, 320);
};

// CONFIG
const TEMPO_MINIMO = 5 * 60 * 1000; // 5 min
let bloqueioClique = false; // trava clique duplo instantâneo (além dos 5 min)

// 6 ETAPAS
const etapas = [
    { tipo: "entrada",         label: "ENTRADA",          confirm: "Você está entrando no serviço?" },
    { tipo: "saida_intervalo", label: "SAÍDA INTERVALO",  confirm: "Você está saindo para intervalo?" },
    { tipo: "retorno_intervalo", label: "RETORNO INTERVALO", confirm: "Você está retornando do intervalo?" },
    { tipo: "saida",           label: "SAÍDA",            confirm: "Você está encerrando o expediente?" },
    { tipo: "entrada_he",      label: "ENTRADA HE",       confirm: "Você está iniciando hora extra?" },
    { tipo: "saida_he",        label: "SAÍDA HE",         confirm: "Você está finalizando hora extra?" }
];

function hoje() {
    return new Date().toISOString().split('T')[0];
}

function horaAtual() {
    return new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
}

// RELÓGIO
setInterval(() => {
    document.getElementById("hora").innerText = new Date().toLocaleString();
}, 1000);

// Botão registrar (sem inline onclick, mais confiável)
document.getElementById("registrarBtn").addEventListener("click", registrar);

// REGISTRAR
async function registrar() {

    if (bloqueioClique) return;           // trava clique duplo
    bloqueioClique = true;
    setTimeout(() => bloqueioClique = false, 1500); // libera após 1.5s

    const nome = document.getElementById("nome").value.trim();
    const re = document.getElementById("re").value.trim();

    if (!nome || !re) {
        alert("Preencha nome e RE");
        return;
    }

    const agora = new Date();
    const dataHoje = hoje();

    // ✅ CONSULTA SEM INDEX:
    // Busca pelo par (nome + re), e filtra a data no JS
    const q = query(
        collection(db, "pontos"),
        where("re", "==", re),
        where("nome", "==", nome)
    );

    const snap = await getDocs(q);
    let registros = snap.docs.map(d => d.data());

    // FILTRA SOMENTE HOJE
    registros = registros.filter(r => r.data === dataHoje);

    // ORDENA NO JS (timestamp pode vir como Date, string ou Timestamp)
    registros.sort((a, b) => {
        const ta = a.timestamp?.toDate?.() || new Date(a.timestamp);
        const tb = b.timestamp?.toDate?.() || new Date(b.timestamp);
        return ta - tb;
    });

    // ✅ BLOQUEIO DUPLICIDADE (5 min)
    if (registros.length > 0) {
        const ultimo = registros[registros.length - 1];
        const ultimoTs = ultimo.timestamp?.toDate?.() || new Date(ultimo.timestamp);

        if ((agora - ultimoTs) < TEMPO_MINIMO) {
            alert("Registro duplicado detectado. Aguarde 5 minutos para registrar novamente.");
            return;
        }
    }

    // ✅ DEFINIR ETAPA PELA QUANTIDADE DO DIA (6 etapas)
    const etapaIndex = registros.length;

    if (etapaIndex >= etapas.length) {
        alert("Todos os registros do dia já foram feitos.");
        return;
    }

    const etapa = etapas[etapaIndex];

    // ✅ CONFIRMAÇÃO
    if (!confirm(etapa.confirm)) return;

    // FOTO (se não tiver capturado, ainda salva — se quiser obrigar, eu travo)
    const canvas = document.getElementById("photo");
    const foto = canvas.toDataURL("image/jpeg", 0.4);

    // LOCALIZAÇÃO
    let location = "Não disponível";
    try {
        const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej));
        location = pos.coords.latitude + "," + pos.coords.longitude;
    } catch {}

    // SALVAR
    await addDoc(collection(db, "pontos"), {
        nome,
        re,
        tipo: etapa.tipo,
        label: etapa.label,
        data: dataHoje,
        hora: horaAtual(),
        timestamp: agora.toISOString(), // salva como string ISO (mais consistente)
        foto,
        location
    });

    alert(etapa.label + " registrada com sucesso!");
}

</script>

</body>
</html>
