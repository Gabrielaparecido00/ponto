<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro de Ponto</title>

<style>
body {
    font-family: Arial;
    background: #f0f0f0;
    padding: 20px;
}

.container {
    max-width: 500px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 10px;
}

.logo {
    width: 280px;
    display: block;
    margin: auto;
}

input, button {
    width: 100%;
    padding: 10px;
    margin-top: 10px;
}

button {
    background: green;
    color: white;
    border: none;
}

canvas {
    width: 100%;
    border: 1px solid #ccc;
}

#timestamp {
    text-align: center;
    margin-top: 10px;
}
</style>

</head>
<body>

<div class="container">

<img src="GW.png" class="logo">

<h2>Registro de Ponto</h2>

<form id="form">
<input id="nome" placeholder="Nome completo" required>
<input id="re" placeholder="RE" required>

<canvas id="foto" width="240" height="320"></canvas>
<button type="button" id="capturar">Capturar Foto</button>

<button type="submit">Registrar</button>
</form>

<div id="timestamp"></div>

</div>

<!-- link escondido -->
<footer style="text-align:center; margin-top:40px;">
<a href="admin.html" style="font-size:10px; color:#ccc;">.</a>
</footer>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, addDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// 游댠 SUA CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyD--zpWLbLg5X82oGTyz6SuPFQV0sd7NWc",
  authDomain: "controle-ponto-f539b.firebaseapp.com",
  projectId: "controle-ponto-f539b",
  storageBucket: "controle-ponto-f539b.firebasestorage.app",
  messagingSenderId: "324716100257",
  appId: "1:324716100257:web:32d49a9ab4916182dd4ee0",
  measurementId: "G-P81H3C4SFK"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const form = document.getElementById("form");
const canvas = document.getElementById("foto");
const btn = document.getElementById("capturar");

let stream;

// c칙mera
navigator.mediaDevices.getUserMedia({ video: true })
.then(s => stream = s)
.catch(() => alert("Erro c칙mera"));

// capturar
btn.onclick = async () => {

    if (!stream) return alert("Sem c칙mera");

    const track = stream.getVideoTracks()[0];
    const imageCapture = new ImageCapture(track);

    const bitmap = await imageCapture.grabFrame();

    const ctx = canvas.getContext("2d");
    ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
};

// rel칩gio
setInterval(()=>{
    document.getElementById("timestamp").innerText =
    new Date().toLocaleString();
},1000);

// salvar
form.onsubmit = async (e) => {

    e.preventDefault();

    const nome = document.getElementById("nome").value;
    const re = document.getElementById("re").value;

    const foto = canvas.toDataURL("image/jpeg", 0.5);

    let local = "N/A";

    try {
        const pos = await new Promise((res, rej)=>{
            navigator.geolocation.getCurrentPosition(res, rej);
        });

        local = pos.coords.latitude + "," + pos.coords.longitude;
    } catch {}

    await addDoc(collection(db, "pontos"), {
        fullName: nome,
        re,
        photo: foto,
        timestamp: new Date().toISOString(),
        location: local
    });

    alert("Registrado!");

    form.reset();
    canvas.getContext("2d").clearRect(0,0,canvas.width,canvas.height);
};

</script>

</body>
</html>
